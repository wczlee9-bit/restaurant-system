<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ½ï¸ é¤é¥®ç‚¹é¤ç³»ç»Ÿ - v3.1 è°ƒè¯•ç‰ˆ</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <script src="https://unpkg.com/element-plus/dist/index.full.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'PingFang SC', 'Microsoft YaHei', Arial, sans-serif; background: #f0f2f5; }

        .mobile-container {
            max-width: 414px; margin: 0 auto; min-height: 100vh; background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 20px; text-align: center; position: sticky;
            top: 0; z-index: 100;
        }
        .header h1 { font-size: 22px; margin-bottom: 5px; }
        .header-info { font-size: 14px; opacity: 0.9; }

        .table-selector {
            padding: 40px 20px; text-align: center;
        }
        .table-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;
            margin-top: 20px;
        }
        .table-cell {
            padding: 25px 15px; border: 3px solid #eee; border-radius: 12px;
            cursor: pointer; transition: all 0.3s; font-size: 20px; font-weight: bold;
            color: #333;
        }
        .table-cell:hover { border-color: #667eea; transform: translateY(-3px); }
        .table-cell.selected { border-color: #667eea; background: #ecf5ff; }
        .table-cell.occupied { border-color: #f56c6c; background: #fef0f0; color: #f56c6c; }

        .loading-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.9); display: flex; align-items: center;
            justify-content: center; z-index: 2000;
        }

        .debug-info {
            background: #fff3cd; border: 2px solid #ffc107; padding: 15px; margin: 20px;
            border-radius: 8px; font-size: 14px;
        }
        .debug-info h3 { margin-bottom: 10px; color: #856404; }
        .debug-info p { margin: 5px 0; color: #856404; }
    </style>
</head>
<body>
    <div id="app">
        <!-- åŠ è½½çŠ¶æ€ -->
        <div class="loading-overlay" v-if="loading">
            <div>
                <div style="font-size: 48px; margin-bottom: 20px;">ğŸ½ï¸</div>
                <div style="font-size: 18px; color: #666;">åŠ è½½ä¸­...</div>
                <div style="font-size: 14px; color: #999; margin-top: 10px;">{{ loadingStatus }}</div>
            </div>
        </div>

        <!-- è°ƒè¯•ä¿¡æ¯ -->
        <div class="debug-info" v-if="!loading">
            <h3>ğŸ” è°ƒè¯•ä¿¡æ¯</h3>
            <p>æ¡Œå·æ•°é‡: {{ tables.length }}</p>
            <p>åˆ†ç±»æ•°é‡: {{ categories.length }}</p>
            <p>èœå“æ•°é‡: {{ menuItems.length }}</p>
            <p>åŠ è½½çŠ¶æ€: {{ loading ? 'åŠ è½½ä¸­' : 'å·²å®Œæˆ' }}</p>
        </div>

        <div class="mobile-container">
            <!-- æ¡Œå·é€‰æ‹©å™¨ -->
            <div v-if="!selectedTable" class="table-selector">
                <h2 style="margin-bottom: 10px;">æ¬¢è¿å…‰ä¸´ï¼</h2>
                <p style="color: #909399; margin-bottom: 10px;">è¯·é€‰æ‹©æ‚¨çš„æ¡Œå·</p>

                <div class="table-grid">
                    <div v-for="table in tables" :key="table.id"
                         class="table-cell"
                         :class="{selected: tempTableId === table.id, occupied: table.is_occupied}"
                         @click="selectTable(table)">
                        {{ table.table_number }}å·
                    </div>
                </div>

                <el-button type="primary" size="large" style="width: 100%; margin-top: 30px; height: 50px;"
                           :disabled="!tempTableId" @click="confirmTable()">
                    ç¡®è®¤æ¡Œå·ï¼Œå¼€å§‹ç‚¹é¤
                </el-button>
            </div>

            <!-- èœå•ç•Œé¢ -->
            <div v-else>
                <div class="header">
                    <h1>{{ selectedTable.table_number }}å·æ¡Œ</h1>
                    <div class="header-info">è¯·é€‰æ‹©èœå“</div>
                </div>

                <div style="padding: 20px; text-align: center;">
                    <h3>èœå•åŒºåŸŸ</h3>
                    <p>å…± {{ menuItems.length }} é“èœå“</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('ğŸ”§ å¼€å§‹åŠ è½½è„šæœ¬...');

        // æ£€æŸ¥ä¾èµ–æ˜¯å¦åŠ è½½
        if (typeof Vue === 'undefined') {
            console.error('âŒ Vue æœªåŠ è½½');
            document.body.innerHTML = '<h1 style="color: red; padding: 20px;">Vue æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</h1>';
        } else {
            console.log('âœ… Vue å·²åŠ è½½');
        }

        if (typeof ElementPlus === 'undefined') {
            console.error('âŒ ElementPlus æœªåŠ è½½');
        } else {
            console.log('âœ… ElementPlus å·²åŠ è½½');
        }

        if (typeof axios === 'undefined') {
            console.error('âŒ Axios æœªåŠ è½½');
        } else {
            console.log('âœ… Axios å·²åŠ è½½');
        }

        const { createApp } = Vue;

        createApp({
            data() {
                console.log('ğŸ“¦ åˆå§‹åŒ– data...');
                return {
                    loading: true,
                    loadingStatus: 'å¼€å§‹åˆå§‹åŒ–...',
                    tables: [],
                    categories: [],
                    menuItems: [],
                    selectedTable: null,
                    tempTableId: null
                };
            },
            async mounted() {
                console.log('ğŸš€ mounted å¼€å§‹...');
                await this.initData();
            },
            methods: {
                async initData() {
                    console.log('ğŸ“¥ initData å¼€å§‹...');
                    this.loadingStatus = 'å¼€å§‹åŠ è½½åº—é“ºä¿¡æ¯...';
                    this.loading = true;

                    try {
                        // æ­¥éª¤1: åŠ è½½åº—é“ºä¿¡æ¯
                        this.loadingStatus = 'åŠ è½½åº—é“ºä¿¡æ¯...';
                        console.log('ğŸ“¦ åŠ è½½åº—é“ºä¿¡æ¯...');
                        this.loadShopInfo();
                        console.log('âœ… åº—é“ºä¿¡æ¯åŠ è½½å®Œæˆ');

                        // æ­¥éª¤2: åŠ è½½æ¡Œå·
                        this.loadingStatus = 'åŠ è½½æ¡Œå·æ•°æ®...';
                        console.log('ğŸ“¦ åŠ è½½æ¡Œå·...');
                        await this.loadTables();
                        console.log('âœ… æ¡Œå·åŠ è½½å®Œæˆ:', this.tables.length, 'ä¸ª');

                        // æ­¥éª¤3: åŠ è½½åˆ†ç±»
                        this.loadingStatus = 'åŠ è½½èœå“åˆ†ç±»...';
                        console.log('ğŸ“¦ åŠ è½½åˆ†ç±»...');
                        await this.loadCategories();
                        console.log('âœ… åˆ†ç±»åŠ è½½å®Œæˆ:', this.categories.length, 'ä¸ª');

                        // æ­¥éª¤4: åŠ è½½èœå“
                        this.loadingStatus = 'åŠ è½½èœå“æ•°æ®...';
                        console.log('ğŸ“¦ åŠ è½½èœå“...');
                        await this.loadMenuItems();
                        console.log('âœ… èœå“åŠ è½½å®Œæˆ:', this.menuItems.length, 'é“');

                        this.loadingStatus = 'åŠ è½½å®Œæˆ';
                        console.log('âœ… æ‰€æœ‰æ•°æ®åŠ è½½å®Œæˆ');

                        // å»¶è¿Ÿå…³é—­ loadingï¼Œç¡®ä¿ç•Œé¢æ›´æ–°
                        setTimeout(() => {
                            this.loading = false;
                            console.log('âœ… Loading å·²å…³é—­');
                        }, 500);

                    } catch (error) {
                        console.error('âŒ åˆå§‹åŒ–å¤±è´¥:', error);
                        console.error('é”™è¯¯è¯¦æƒ…:', error.message, error.stack);
                        this.loadingStatus = 'åŠ è½½å¤±è´¥: ' + error.message;
                        alert('åŠ è½½å¤±è´¥: ' + error.message);
                        this.loading = false;
                    }
                },

                loadShopInfo() {
                    console.log('ğŸ“ loadShopInfo è¢«è°ƒç”¨');
                    // ç®€åŒ–ç‰ˆï¼Œä¸ä½¿ç”¨ localStorage
                    console.log('âœ… loadShopInfo å®Œæˆ');
                },

                async loadTables() {
                    console.log('ğŸ“ loadTables è¢«è°ƒç”¨');
                    try {
                        const response = await axios.get('/api/tables/');
                        this.tables = response.data || [];
                        console.log('âœ… loadTables å®Œæˆ:', this.tables.length);
                    } catch (error) {
                        console.error('âŒ loadTables å¤±è´¥:', error);
                        throw error;
                    }
                },

                async loadCategories() {
                    console.log('ğŸ“ loadCategories è¢«è°ƒç”¨');
                    try {
                        const response = await axios.get('/api/menu-categories/');
                        this.categories = response.data || [];
                        console.log('âœ… loadCategories å®Œæˆ:', this.categories.length);
                    } catch (error) {
                        console.error('âŒ loadCategories å¤±è´¥:', error);
                        throw error;
                    }
                },

                async loadMenuItems() {
                    console.log('ğŸ“ loadMenuItems è¢«è°ƒç”¨');
                    try {
                        const response = await axios.get('/api/menu-items/');
                        this.menuItems = response.data || [];
                        console.log('âœ… loadMenuItems å®Œæˆ:', this.menuItems.length);
                    } catch (error) {
                        console.error('âŒ loadMenuItems å¤±è´¥:', error);
                        throw error;
                    }
                },

                selectTable(table) {
                    this.tempTableId = table.id;
                },

                confirmTable() {
                    if (!this.tempTableId) {
                        alert('è¯·å…ˆé€‰æ‹©æ¡Œå·');
                        return;
                    }
                    const table = this.tables.find(t => t.id === this.tempTableId);
                    if (table) {
                        this.selectedTable = table;
                        alert('å·²é€‰æ‹©' + table.table_number + 'å·æ¡Œ');
                    }
                }
            }
        }).use(ElementPlus).mount('#app');

        console.log('âœ… Vue åº”ç”¨å·²æŒ‚è½½');
    </script>
</body>
</html>
