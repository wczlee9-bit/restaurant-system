<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ½ï¸ é¤é¥®ç³»ç»Ÿ - å·¥ä½œäººå‘˜ç«¯</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <script src="https://unpkg.com/element-plus/dist/index.full.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'PingFang SC', 'Microsoft YaHei', Arial, sans-serif; background: #f0f2f5; }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px 30px; display: flex; justify-content: space-between;
            align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .header h1 { color: white; font-size: 24px; margin: 0; }
        .header-info { color: white; font-size: 14px; margin-top: 5px; opacity: 0.9; }
        
        .role-tabs {
            display: flex; gap: 10px; margin-top: 15px;
        }
        .role-tab {
            padding: 10px 20px; border: 2px solid rgba(255,255,255,0.5);
            background: rgba(255,255,255,0.1); color: white; border-radius: 25px;
            cursor: pointer; transition: all 0.3s; font-size: 14px; font-weight: bold;
        }
        .role-tab:hover, .role-tab.active {
            background: white; color: #667eea; transform: scale(1.05);
        }
        
        .main-container {
            padding: 30px; max-width: 1600px; margin: 0 auto;
        }
        
        .dashboard { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        
        .stats-row { display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card {
            padding: 20px; border-radius: 12px; text-align: center;
            color: white; font-weight: bold; transition: all 0.3s;
        }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
        .stat-card.pending { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .stat-card.preparing { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .stat-card.ready { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .stat-card.serving { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .stat-card.completed { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .stat-number { font-size: 36px; margin-bottom: 5px; }
        .stat-label { font-size: 14px; opacity: 0.9; }
        
        .orders-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }
        
        .order-card {
            border: 2px solid #eee; border-radius: 12px; overflow: hidden;
            transition: all 0.3s; background: white;
        }
        .order-card:hover { box-shadow: 0 8px 20px rgba(0,0,0,0.1); transform: translateY(-3px); }
        .order-card.urgent { border-color: #f56c6c; border-width: 3px; }
        .order-card.normal { border-color: #67c23a; }
        
        .order-header {
            padding: 15px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-bottom: 2px solid #eee; display: flex; justify-content: space-between;
            align-items: center;
        }
        .order-table { font-size: 20px; font-weight: bold; color: #333; }
        .order-time { color: #909399; font-size: 12px; }
        .order-status { font-weight: bold; padding: 4px 12px; border-radius: 12px; font-size: 12px; }
        
        .order-body { padding: 15px; }
        .order-info { margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap; }
        
        .order-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px; margin: 8px 0; background: #f9f9f9; border-radius: 8px;
            border-left: 4px solid #909399;
        }
        .order-item.pending { border-left-color: #f56c6c; background: #fef0f0; }
        .order-item.preparing { border-left-color: #e6a23c; background: #fdf6ec; }
        .order-item.ready { border-left-color: #409eff; background: #ecf5ff; }
        .order-item.served { border-left-color: #67c23a; background: #f0f9eb; opacity: 0.6; }
        
        .order-item-info { flex: 1; }
        .order-item-name { font-weight: bold; font-size: 14px; }
        .order-item-qty { font-size: 12px; color: #909399; margin-top: 4px; }
        .order-item-remark { font-size: 11px; color: #e6a23c; margin-top: 4px; }
        
        .order-actions {
            padding: 15px; background: #f9f9f9; border-top: 1px solid #eee;
            display: flex; gap: 10px; flex-wrap: wrap;
        }
        
        .notification-badge {
            position: fixed; top: 20px; right: 20px;
            padding: 15px 25px; border-radius: 10px; color: white;
            font-weight: bold; z-index: 9999; animation: slideIn 0.3s, pulse 2s infinite;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        .notification-badge.new-order { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .notification-badge.order-updated { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .empty-state {
            text-align: center; padding: 60px 20px; color: #909399;
        }
        .empty-icon { font-size: 64px; margin-bottom: 20px; }
        .empty-text { font-size: 18px; }
        
        .connection-status {
            position: fixed; bottom: 20px; right: 20px;
            padding: 10px 20px; border-radius: 20px; font-size: 12px;
            font-weight: bold; z-index: 1000;
        }
        .connection-status.connected { background: #f0f9eb; color: #67c23a; }
        .connection-status.disconnected { background: #fef0f0; color: #f56c6c; }
        
        .audio-hint {
            position: fixed; top: 90px; right: 20px;
            padding: 10px 15px; background: white; border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15); font-size: 12px;
            color: #909399; z-index: 100;
        }
        
        .filter-bar {
            display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;
        }
        .filter-tag {
            padding: 8px 16px; border-radius: 20px; cursor: pointer;
            transition: all 0.3s; font-size: 14px; border: 1px solid #eee;
            background: white;
        }
        .filter-tag.active { background: #667eea; color: white; border-color: #667eea; }
        
        .time-indicator {
            display: inline-block; padding: 4px 8px; border-radius: 4px;
            font-size: 11px; font-weight: bold; margin-left: 10px;
        }
        .time-indicator.urgent { background: #fef0f0; color: #f56c6c; }
        .time-indicator.normal { background: #f0f9eb; color: #67c23a; }
    </style>
</head>
<body>
    <div id="app">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <div class="header">
            <div>
                <h1>ğŸ½ï¸ é¤é¥®ç‚¹é¤ç³»ç»Ÿ - å·¥ä½œäººå‘˜ç«¯</h1>
                <div class="header-info" v-if="storeInfo">
                    åº—é“º: {{ storeInfo.name }} | ç”µè¯: {{ storeInfo.phone }}
                </div>
            </div>
            <div>
                <div class="role-tabs">
                    <div class="role-tab" :class="{active: currentRole === 'manager'}" @click="switchRole('manager')">
                        ğŸ‘” åº—é•¿
                    </div>
                    <div class="role-tab" :class="{active: currentRole === 'kitchen'}" @click="switchRole('kitchen')">
                        ğŸ‘¨â€ğŸ³ å¨å¸ˆ
                    </div>
                    <div class="role-tab" :class="{active: currentRole === 'waiter'}" @click="switchRole('waiter')">
                        ğŸ¤µ ä¼ èœå‘˜
                    </div>
                    <div class="role-tab" :class="{active: currentRole === 'cashier'}" @click="switchRole('cashier')">
                        ğŸ’° æ”¶é“¶å‘˜
                    </div>
                    <div class="role-tab" style="background: rgba(255,255,255,0.2);" @click="logout">
                        ğŸšª é€€å‡º
                    </div>
                </div>
                <div class="header-info" v-if="currentUser" style="text-align: right; margin-top: 10px;">
                    å½“å‰ç”¨æˆ·: {{ currentUser.name || currentUser.username }}
                </div>
            </div>
        </div>

        <div class="main-container">
            <div class="dashboard">
                <!-- ç»Ÿè®¡å¡ç‰‡ -->
                <div class="stats-row">
                    <div class="stat-card pending" @click="filterStatus('pending')">
                        <div class="stat-number">{{ stats.pending }}</div>
                        <div class="stat-label">å¾…ç¡®è®¤</div>
                    </div>
                    <div class="stat-card preparing" @click="filterStatus('preparing')">
                        <div class="stat-number">{{ stats.preparing }}</div>
                        <div class="stat-label">åˆ¶ä½œä¸­</div>
                    </div>
                    <div class="stat-card ready" @click="filterStatus('ready')">
                        <div class="stat-number">{{ stats.ready }}</div>
                        <div class="stat-label">å¾…ä¼ èœ</div>
                    </div>
                    <div class="stat-card serving" @click="filterStatus('serving')">
                        <div class="stat-number">{{ stats.serving }}</div>
                        <div class="stat-label">ä¸Šèœä¸­</div>
                    </div>
                    <div class="stat-card completed" @click="filterStatus('completed')">
                        <div class="stat-number">{{ stats.completed }}</div>
                        <div class="stat-label">å·²å®Œæˆ</div>
                    </div>
                </div>

                <!-- ç­›é€‰æ  -->
                <div class="filter-bar" v-if="currentRole !== 'manager'">
                    <div class="filter-tag" :class="{active: statusFilter === 'all'}" @click="statusFilter = 'all'">
                        å…¨éƒ¨
                    </div>
                    <div class="filter-tag" :class="{active: statusFilter === 'pending'}" @click="statusFilter = 'pending'">
                        å¾…ç¡®è®¤
                    </div>
                    <div class="filter-tag" :class="{active: statusFilter === 'preparing'}" @click="statusFilter = 'preparing'">
                        åˆ¶ä½œä¸­
                    </div>
                    <div class="filter-tag" :class="{active: statusFilter === 'ready'}" @click="statusFilter = 'ready'">
                        å¾…ä¼ èœ
                    </div>
                    <div class="filter-tag" :class="{active: statusFilter === 'serving'}" @click="statusFilter = 'serving'">
                        ä¸Šèœä¸­
                    </div>
                </div>

                <!-- è®¢å•åˆ—è¡¨ -->
                <div class="orders-grid" v-if="filteredOrders.length > 0">
                    <div v-for="order in filteredOrders" :key="order.id"
                         class="order-card"
                         :class="{urgent: isUrgent(order), normal: !isUrgent(order)}">
                        <div class="order-header">
                            <span class="order-table">{{ order.table_number }}å·æ¡Œ</span>
                            <div>
                                <span class="order-time">{{ formatTime(order.created_at) }}</span>
                                <span class="time-indicator" :class="{urgent: isUrgent(order), normal: !isUrgent(order)}">
                                    {{ getTimeElapsed(order.created_at) }}
                                </span>
                            </div>
                        </div>
                        
                        <div class="order-body">
                            <div class="order-info">
                                <el-tag type="info" size="small">è®¢å•å·: {{ order.id }}</el-tag>
                                <el-tag :type="getStatusType(order)" size="small">
                                    {{ getStatusText(order) }}
                                </el-tag>
                                <el-tag type="success" size="small">
                                    å…±{{ order.items.length }}é“èœ
                                </el-tag>
                                <el-tag type="warning" size="small">
                                    Â¥{{ order.total_amount }}
                                </el-tag>
                            </div>
                            
                            <div v-for="item in order.items" :key="item.id" class="order-item"
                                 :class="getItemClass(item)">
                                <div class="order-item-info">
                                    <div class="order-item-name">{{ item.menu_item_name }}</div>
                                    <div class="order-item-qty">æ•°é‡: {{ item.quantity }}</div>
                                    <div v-if="item.special_instructions" class="order-item-remark">
                                        å¤‡æ³¨: {{ item.special_instructions }}
                                    </div>
                                </div>
                                <div>
                                    <el-tag :type="getItemStatusType(item)" size="small">
                                        {{ getItemStatusText(item) }}
                                    </el-tag>
                                </div>
                            </div>
                        </div>
                        
                        <div class="order-actions">
                            <!-- å¨å¸ˆæ“ä½œ -->
                            <template v-if="currentRole === 'kitchen'">
                                <el-button type="primary" size="small"
                                           @click="printKitchenOrder(order)"
                                           style="margin-right: 10px;">
                                    ğŸ–¨ï¸ æ‰“å°è®¢å•
                                </el-button>
                                <el-button type="primary" size="small"
                                           @click="startCooking(order.id, item.id)"
                                           v-for="item in order.items"
                                           :key="'start-'+item.id"
                                           v-show="item.item_status === 'pending'">
                                    å¼€å§‹åˆ¶ä½œ {{ item.menu_item_name }}
                                </el-button>
                                <el-button type="success" size="small"
                                           @click="finishCooking(order.id, item.id)"
                                           v-for="item in order.items"
                                           :key="'finish-'+item.id"
                                           v-show="item.item_status === 'preparing'">
                                    å®Œæˆåˆ¶ä½œ {{ item.menu_item_name }}
                                </el-button>
                                <el-button type="success" size="default"
                                           @click="markOrderReady(order.id)"
                                           v-if="allItemsReady(order)">
                                    âœ… å…¨éƒ¨å®Œæˆ
                                </el-button>
                            </template>
                            
                            <!-- ä¼ èœå‘˜æ“ä½œ -->
                            <template v-if="currentRole === 'waiter'">
                                <el-button type="primary" size="small"
                                           @click="printWaiterOrder(order)"
                                           style="margin-right: 10px;">
                                    ğŸ–¨ï¸ æ‰“å°è®¢å•
                                </el-button>
                                <el-button type="primary" size="small"
                                           @click="deliverDish(order.id, item.id)"
                                           v-for="item in order.items"
                                           :key="'deliver-'+item.id"
                                           v-show="item.item_status === 'ready'">
                                    ä¸Šèœ {{ item.menu_item_name }}
                                </el-button>
                                <el-button type="success" size="default"
                                           @click="markOrderCompleted(order.id)"
                                           v-if="allItemsServed(order)">
                                    âœ… å®Œæˆä¼ èœ
                                </el-button>
                            </template>
                            
                            <!-- æ”¶é“¶å‘˜æ“ä½œ -->
                            <template v-if="currentRole === 'cashier'">
                                <el-button type="warning" size="default"
                                           @click="processPayment(order.id)">
                                    ğŸ’° å¤„ç†æ”¯ä»˜
                                </el-button>
                                <el-button type="info" size="default"
                                           @click="printReceipt(order.id)">
                                    ğŸ–¨ï¸ æ‰“å°å°ç¥¨
                                </el-button>
                            </template>
                            
                            <!-- åº—é•¿æ“ä½œ -->
                            <template v-if="currentRole === 'manager'">
                                <el-button type="primary" size="default" @click="viewOrderDetail(order.id)">
                                    ğŸ‘ï¸ æŸ¥çœ‹è¯¦æƒ…
                                </el-button>
                                <el-button type="danger" size="default"
                                           @click="cancelOrder(order.id)"
                                           v-if="canCancel(order)">
                                    âŒ å–æ¶ˆè®¢å•
                                </el-button>
                            </template>
                        </div>
                    </div>
                </div>
                
                <!-- ç©ºçŠ¶æ€ -->
                <div v-else class="empty-state">
                    <div class="empty-icon">ğŸ“­</div>
                    <div class="empty-text">
                        {{ getEmptyText() }}
                    </div>
                </div>
            </div>
        </div>

        <!-- é€šçŸ¥å¾½ç«  -->
        <div v-if="notification" class="notification-badge" :class="notification.type">
            {{ notification.message }}
        </div>
        
        <!-- è¿æ¥çŠ¶æ€ -->
        <div class="connection-status" :class="{connected: wsConnected, disconnected: !wsConnected}">
            {{ wsConnected ? 'ğŸŸ¢ å®æ—¶è¿æ¥ä¸­' : 'ğŸ”´ è¿æ¥å·²æ–­å¼€' }}
        </div>
        
        <!-- éŸ³é¢‘æç¤º -->
        <div class="audio-hint" v-if="notification">
            ğŸ”” æ–°è®¢å•æé†’
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    currentUser: null,
                    currentRole: 'manager',
                    orders: [],
                    storeInfo: null,
                    ws: null,
                    wsConnected: false,
                    notification: null,
                    notificationTimer: null,
                    statusFilter: 'all',
                    audioContext: null
                };
            },
            computed: {
                filteredOrders() {
                    let result = [...this.orders];
                    
                    // æ ¹æ®è§’è‰²ç­›é€‰
                    if (this.currentRole === 'kitchen') {
                        // å¨å¸ˆçœ‹åˆ°å¾…åˆ¶ä½œå’Œåˆ¶ä½œä¸­çš„è®¢å•
                        result = result.filter(o => 
                            ['pending', 'confirmed', 'preparing'].includes(o.status) ||
                            o.items.some(i => ['pending', 'preparing'].includes(i.item_status))
                        );
                    } else if (this.currentRole === 'waiter') {
                        // ä¼ èœå‘˜çœ‹åˆ°å¾…ä¼ èœå’Œä¸Šèœä¸­çš„è®¢å•
                        result = result.filter(o => 
                            o.items.some(i => ['ready', 'serving'].includes(i.item_status))
                        );
                    } else if (this.currentRole === 'cashier') {
                        // æ”¶é“¶å‘˜çœ‹åˆ°å¾…æ”¯ä»˜çš„è®¢å•
                        result = result.filter(o => o.status === 'serving');
                    }
                    
                    // æ ¹æ®çŠ¶æ€ç­›é€‰
                    if (this.statusFilter !== 'all') {
                        result = result.filter(o => o.status === this.statusFilter);
                    }
                    
                    // æŒ‰æ—¶é—´æ’åº
                    result.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                    
                    return result;
                },
                stats() {
                    const stats = {
                        pending: 0,
                        preparing: 0,
                        ready: 0,
                        serving: 0,
                        completed: 0
                    };
                    
                    this.orders.forEach(order => {
                        if (order.status === 'pending' || order.status === 'confirmed') {
                            stats.pending++;
                        } else if (order.status === 'preparing') {
                            stats.preparing++;
                        } else if (order.status === 'ready') {
                            stats.ready++;
                        } else if (order.status === 'serving') {
                            stats.serving++;
                        } else if (order.status === 'completed') {
                            stats.completed++;
                        }
                    });
                    
                    return stats;
                }
            },
            async mounted() {
                // æ£€æŸ¥ç™»å½•çŠ¶æ€
                const currentUser = localStorage.getItem('currentUser');
                if (!currentUser) {
                    ElementPlus.ElMessage.warning('è¯·å…ˆç™»å½• / Please login first');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 1000);
                    return;
                }

                // è§£æç”¨æˆ·ä¿¡æ¯
                try {
                    const user = JSON.parse(currentUser);
                    this.currentUser = user;
                    console.log('å½“å‰ç”¨æˆ· / Current user:', user);
                } catch (e) {
                    console.error('è§£æç”¨æˆ·ä¿¡æ¯å¤±è´¥ / Failed to parse user info:', e);
                }

                await this.initData();
                this.connectWebSocket();
                this.initAudio();

                // è‡ªåŠ¨åˆ·æ–°è®¢å•åˆ—è¡¨
                setInterval(() => {
                    this.loadOrders();
                }, 30000); // æ¯30ç§’åˆ·æ–°ä¸€æ¬¡
            },
            methods: {
                async initData() {
                    await this.loadStoreInfo();
                    await this.loadOrders();
                },
                
                async loadStoreInfo() {
                    try {
                        const response = await axios.get('/restaurant/api/store');
                        this.storeInfo = response.data;
                    } catch (error) {
                        console.error('åŠ è½½åº—é“ºä¿¡æ¯å¤±è´¥:', error);
                    }
                },
                
                async loadOrders() {
                    try {
                        const response = await axios.get('/restaurant/api/orders/');
                        this.orders = response.data;
                    } catch (error) {
                        console.error('åŠ è½½è®¢å•å¤±è´¥:', error);
                    }
                },
                
                connectWebSocket() {
                    // ä½¿ç”¨å½“å‰é¡µé¢çš„ä¸»æœºå’Œ8000ç«¯å£
                    const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const wsHost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
                        ? 'localhost:8000' 
                        : `${window.location.hostname}:8000`;
                    const wsUrl = `${wsProtocol}//${wsHost}/ws/store/1`;
                    this.ws = new WebSocket(wsUrl);
                    
                    this.ws.onopen = () => {
                        this.wsConnected = true;
                        console.log('WebSocketè¿æ¥æˆåŠŸ');
                    };
                    
                    this.ws.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        this.handleWebSocketMessage(data);
                    };
                    
                    this.ws.onclose = () => {
                        this.wsConnected = false;
                        console.log('WebSocketè¿æ¥æ–­å¼€');
                        // 5ç§’åé‡è¿
                        setTimeout(() => {
                            this.connectWebSocket();
                        }, 5000);
                    };
                    
                    this.ws.onerror = (error) => {
                        console.error('WebSocketé”™è¯¯:', error);
                    };
                },
                
                handleWebSocketMessage(data) {
                    console.log('æ”¶åˆ°WebSocketæ¶ˆæ¯:', data);
                    
                    if (data.type === 'new_order') {
                        // æ–°è®¢å•
                        this.showNotification('æ–°è®¢å•æé†’', 'new-order');
                        this.loadOrders();
                        this.playNotificationSound();
                    } else if (data.type === 'order_status_update') {
                        // è®¢å•çŠ¶æ€æ›´æ–°
                        this.showNotification('è®¢å•çŠ¶æ€æ›´æ–°', 'order-updated');
                        this.loadOrders();
                    }
                },
                
                showNotification(message, type) {
                    this.notification = { message, type };
                    
                    if (this.notificationTimer) {
                        clearTimeout(this.notificationTimer);
                    }
                    
                    this.notificationTimer = setTimeout(() => {
                        this.notification = null;
                    }, 5000);
                },
                
                initAudio() {
                    try {
                        this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    } catch (error) {
                        console.error('æ— æ³•åˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡:', error);
                    }
                },
                
                playNotificationSound() {
                    if (!this.audioContext) return;
                    
                    try {
                        const oscillator = this.audioContext.createOscillator();
                        const gainNode = this.audioContext.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(this.audioContext.destination);
                        
                        oscillator.frequency.value = 800;
                        oscillator.type = 'sine';
                        
                        gainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.5);
                        
                        oscillator.start(this.audioContext.currentTime);
                        oscillator.stop(this.audioContext.currentTime + 0.5);
                    } catch (error) {
                        console.error('æ’­æ”¾é€šçŸ¥éŸ³å¤±è´¥:', error);
                    }
                },
                
                switchRole(role) {
                    this.currentRole = role;
                    this.statusFilter = 'all';
                    console.log('åˆ‡æ¢è§’è‰²:', role);
                },
                
                filterStatus(status) {
                    this.statusFilter = status;
                },
                
                isUrgent(order) {
                    const elapsed = this.getTimeElapsedMinutes(order.created_at);
                    return elapsed > 10; // è¶…è¿‡10åˆ†é’Ÿè§†ä¸ºç´§æ€¥
                },
                
                getTimeElapsedMinutes(createdAt) {
                    const created = new Date(createdAt);
                    const now = new Date();
                    return (now - created) / 60000;
                },
                
                getTimeElapsed(createdAt) {
                    const minutes = Math.floor(this.getTimeElapsedMinutes(createdAt));
                    if (minutes < 60) {
                        return `${minutes}åˆ†é’Ÿå‰`;
                    }
                    const hours = Math.floor(minutes / 60);
                    return `${hours}å°æ—¶å‰`;
                },
                
                formatTime(createdAt) {
                    const date = new Date(createdAt);
                    return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                },
                
                getStatusType(order) {
                    const statusMap = {
                        'pending': 'warning',
                        'confirmed': 'primary',
                        'preparing': 'warning',
                        'ready': 'success',
                        'serving': 'primary',
                        'completed': 'success',
                        'cancelled': 'danger'
                    };
                    return statusMap[order.status] || 'info';
                },
                
                getStatusText(order) {
                    const textMap = {
                        'pending': 'å¾…ç¡®è®¤',
                        'confirmed': 'å·²ç¡®è®¤',
                        'preparing': 'åˆ¶ä½œä¸­',
                        'ready': 'å¾…ä¼ èœ',
                        'serving': 'ä¸Šèœä¸­',
                        'completed': 'å·²å®Œæˆ',
                        'cancelled': 'å·²å–æ¶ˆ'
                    };
                    return textMap[order.status] || order.status;
                },
                
                getItemClass(item) {
                    return item.item_status || 'pending';
                },
                
                getItemStatusType(item) {
                    const statusMap = {
                        'pending': 'danger',
                        'preparing': 'warning',
                        'ready': 'success',
                        'served': 'info'
                    };
                    return statusMap[item.item_status] || 'info';
                },
                
                getItemStatusText(item) {
                    const textMap = {
                        'pending': 'å¾…åˆ¶ä½œ',
                        'preparing': 'åˆ¶ä½œä¸­',
                        'ready': 'å¾…ä¼ èœ',
                        'served': 'å·²ä¸Šèœ'
                    };
                    return textMap[item.item_status] || item.item_status;
                },
                
                allItemsReady(order) {
                    return order.items.every(item => item.item_status === 'ready');
                },
                
                allItemsServed(order) {
                    return order.items.every(item => item.item_status === 'served');
                },
                
                async startCooking(orderId, itemId) {
                    try {
                        await axios.patch(`/restaurant/api/orders/${orderId}/items/${itemId}/status`, {
                            item_status: 'preparing'
                        });
                        this.$message.success('å¼€å§‹åˆ¶ä½œ');
                        this.loadOrders();
                    } catch (error) {
                        this.$message.error('æ“ä½œå¤±è´¥: ' + (error.response?.data?.detail || error.message));
                    }
                },
                
                async finishCooking(orderId, itemId) {
                    try {
                        await axios.patch(`/restaurant/api/orders/${orderId}/items/${itemId}/status`, {
                            item_status: 'ready'
                        });
                        this.$message.success('å®Œæˆåˆ¶ä½œ');
                        this.loadOrders();
                    } catch (error) {
                        this.$message.error('æ“ä½œå¤±è´¥: ' + (error.response?.data?.detail || error.message));
                    }
                },
                
                async markOrderReady(orderId) {
                    try {
                        await axios.patch(`/restaurant/api/orders/${orderId}/status`, {
                            status: 'ready'
                        });
                        this.$message.success('è®¢å•å·²å‡†å¤‡å®Œæ¯•');
                        this.loadOrders();
                    } catch (error) {
                        this.$message.error('æ“ä½œå¤±è´¥: ' + (error.response?.data?.detail || error.message));
                    }
                },
                
                async deliverDish(orderId, itemId) {
                    try {
                        await axios.patch(`/restaurant/api/orders/${orderId}/items/${itemId}/status`, {
                            item_status: 'served'
                        });
                        this.$message.success('ä¸ŠèœæˆåŠŸ');
                        this.loadOrders();
                    } catch (error) {
                        this.$message.error('æ“ä½œå¤±è´¥: ' + (error.response?.data?.detail || error.message));
                    }
                },
                
                async markOrderCompleted(orderId) {
                    try {
                        await axios.patch(`/restaurant/api/orders/${orderId}/status`, {
                            status: 'completed'
                        });
                        this.$message.success('ä¼ èœå®Œæˆ');
                        this.loadOrders();
                    } catch (error) {
                        this.$message.error('æ“ä½œå¤±è´¥: ' + (error.response?.data?.detail || error.message));
                    }
                },
                
                async processPayment(orderId) {
                    const order = this.orders.find(o => o.id === orderId);
                    if (!order) {
                        this.$message.error('è®¢å•ä¸å­˜åœ¨');
                        return;
                    }

                    const totalAmount = order.final_amount || order.total_amount;

                    try {
                        // ä½¿ç”¨ Element Plus çš„ prompt å¯¹è¯æ¡†
                        const input = await this.$prompt(`è®¢å•é‡‘é¢ï¼šÂ¥${totalAmount.toFixed(2)}\nè¯·è¾“å…¥å®æ”¶é‡‘é¢`, 'ğŸ’° æ”¶é“¶å°', {
                            confirmButtonText: 'ç¡®è®¤æ”¯ä»˜',
                            cancelButtonText: 'å–æ¶ˆ',
                            inputType: 'number',
                            inputPattern: /^\d+(\.\d{1,2})?$/,
                            inputErrorMessage: 'è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘é¢',
                            inputValue: totalAmount.toFixed(2),
                            inputPlaceholder: 'è¯·è¾“å…¥å®æ”¶é‡‘é¢'
                        });

                        if (input.action === 'confirm') {
                            const receivedAmount = parseFloat(input.value);
                            const change = receivedAmount - totalAmount;

                            if (receivedAmount < totalAmount) {
                                this.$message.error('å®æ”¶é‡‘é¢ä¸èƒ½å°äºè®¢å•é‡‘é¢ï¼');
                                return;
                            }

                            const loading = this.$loading({
                                lock: true,
                                text: 'æ­£åœ¨å¤„ç†æ”¯ä»˜...',
                                background: 'rgba(0, 0, 0, 0.7)'
                            });

                            try {
                                await axios.post(`/restaurant/api/orders/${orderId}/process-payment`, {
                                    received_amount: receivedAmount,
                                    change_amount: change
                                });

                                loading.close();

                                this.$message.success(`æ”¯ä»˜å¤„ç†æˆåŠŸï¼æ‰¾é›¶ï¼šÂ¥${change.toFixed(2)}`);
                                this.printReceipt(orderId);
                                this.loadOrders();
                            } catch (error) {
                                loading.close();
                                this.$message.error('æ“ä½œå¤±è´¥: ' + (error.response?.data?.detail || error.message));
                            }
                        }
                    } catch (error) {
                        // ç”¨æˆ·ç‚¹å‡»å–æ¶ˆï¼Œä¸éœ€è¦æç¤º
                    }
                },

                async printReceipt(orderId) {
                    try {
                        // è·å–å°ç¥¨æ•°æ®
                        const response = await axios.get(`/restaurant/api/orders/${orderId}/receipt`);
                        const receipt = response.data;
                        
                        // åˆ›å»ºæ‰“å°çª—å£
                        const printWindow = window.open('', '_blank');
                        const doc = printWindow.document;
                        
                        // ç”Ÿæˆå°ç¥¨ HTML
                        doc.write(`
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>å°ç¥¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            font-family: 'Courier New', monospace;
        }
        body {
            padding: 20px;
            background: white;
            width: 300px;
        }
        .header {
            text-align: center;
            border-bottom: 1px dashed #000;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }
        .store-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .info {
            font-size: 12px;
            margin-bottom: 3px;
        }
        .items {
            border-top: 1px dashed #000;
            border-bottom: 1px dashed #000;
            padding: 10px 0;
            margin: 10px 0;
        }
        .item {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            margin-bottom: 5px;
        }
        .item-name {
            flex: 1;
        }
        .item-price {
            text-align: right;
            white-space: nowrap;
        }
        .footer {
            border-top: 1px dashed #000;
            padding-top: 10px;
            margin-top: 10px;
        }
        .total {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .payment-info {
            font-size: 12px;
            margin-bottom: 3px;
        }
        .center {
            text-align: center;
            font-size: 12px;
            margin-top: 10px;
        }
        @media print {
            body {
                padding: 0;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="store-name">${receipt.store_name}</div>
        <div class="info">${receipt.address}</div>
        <div class="info">ç”µè¯ï¼š${receipt.phone}</div>
    </div>
    
    <div class="info">è®¢å•å·ï¼š${receipt.order_number}</div>
    <div class="info">æ¡Œå·ï¼š${receipt.table_number}</div>
    <div class="info">æ—¶é—´ï¼š${receipt.created_at}</div>
    
    <div class="items">
        ${receipt.items.map(item => `
            <div class="item">
                <span class="item-name">${item.name} x${item.quantity}</span>
                <span class="item-price">Â¥${item.subtotal.toFixed(2)}</span>
            </div>
        `).join('')}
    </div>
    
    <div class="footer">
        <div class="total">
            <span>åˆè®¡</span>
            <span>Â¥${receipt.total_amount.toFixed(2)}</span>
        </div>
        <div class="payment-info">å®æ”¶é‡‘é¢ï¼šÂ¥${receipt.received_amount ? receipt.received_amount.toFixed(2) : receipt.total_amount.toFixed(2)}</div>
        <div class="payment-info">æ‰¾é›¶ï¼šÂ¥${receipt.change_amount ? receipt.change_amount.toFixed(2) : '0.00'}</div>
        <div class="payment-info">æ”¯ä»˜æ–¹å¼ï¼š${receipt.payment_method === 'counter' ? 'æŸœå°æ”¯ä»˜' : receipt.payment_method}</div>
        <div class="payment-info">æ”¯ä»˜çŠ¶æ€ï¼š${receipt.payment_status === 'paid' ? 'å·²æ”¯ä»˜' : 'æœªæ”¯ä»˜'}</div>
        ${receipt.payment_time ? `<div class="payment-info">æ”¯ä»˜æ—¶é—´ï¼š${receipt.payment_time}</div>` : ''}
    </div>
    
    <div class="center">
        <div>è°¢è°¢å…‰ä¸´ï¼</div>
        <div>æ¬¢è¿ä¸‹æ¬¡å†æ¥ï¼</div>
    </div>
</body>
</html>
                        `);
                        
                        doc.close();
                        
                        // å»¶è¿Ÿåè°ƒç”¨æ‰“å°
                        setTimeout(() => {
                            printWindow.print();
                        }, 100);
                        
                        this.$message.success('å°ç¥¨æ‰“å°ä¸­...');
                    } catch (error) {
                        this.$message.error('æ‰“å°å°ç¥¨å¤±è´¥: ' + (error.response?.data?.detail || error.message));
                    }
                },
                
                printKitchenOrder(order) {
                    // æ‰“å°å¨å¸ˆè®¢å•
                    const printWindow = window.open('', '_blank');
                    const now = new Date();
                    const dateStr = now.toLocaleDateString('zh-CN');
                    const timeStr = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                    
                    let html = `
                        <html>
                            <head>
                                <title>å¨å¸ˆè®¢å• - ${order.order_id}</title>
                                <style>
                                    body { 
                                        font-family: 'å®‹ä½“', 'Microsoft YaHei', Arial, sans-serif; 
                                        padding: 20px; 
                                        font-size: 14px;
                                        line-height: 1.6;
                                    }
                                    .header { 
                                        text-align: center; 
                                        border-bottom: 2px solid #000; 
                                        padding-bottom: 10px; 
                                        margin-bottom: 15px; 
                                    }
                                    .order-info { 
                                        margin-bottom: 15px; 
                                        padding: 10px; 
                                        background: #f5f5f5; 
                                    }
                                    .item-list { 
                                        margin: 15px 0; 
                                    }
                                    .item { 
                                        display: flex; 
                                        justify-content: space-between; 
                                        padding: 8px 0; 
                                        border-bottom: 1px dashed #ccc; 
                                    }
                                    .item-name { 
                                        flex: 1; 
                                        font-weight: bold; 
                                    }
                                    .item-qty { 
                                        width: 80px; 
                                        text-align: right; 
                                        font-size: 16px;
                                        font-weight: bold;
                                    }
                                    .footer { 
                                        text-align: center; 
                                        margin-top: 20px; 
                                        padding-top: 10px; 
                                        border-top: 1px dashed #000; 
                                    }
                                    .remark { 
                                        color: #e6a23c; 
                                        margin-top: 10px; 
                                    }
                                </style>
                            </head>
                            <body>
                                <div class="header">
                                    <h1 style="margin: 0; font-size: 24px;">ğŸ‘¨â€ğŸ³ å¨å¸ˆè®¢å•</h1>
                                    <p style="margin: 10px 0; font-size: 18px;">${this.storeInfo.name || 'ç¾å‘³é¤å…'}</p>
                                </div>
                                
                                <div class="order-info">
                                    <p><strong>è®¢å•å·ï¼š</strong>${order.order_id}</p>
                                    <p><strong>æ¡Œå·ï¼š</strong>${order.table_number}å·æ¡Œ</p>
                                    <p><strong>ä¸‹å•æ—¶é—´ï¼š</strong>${dateStr} ${timeStr}</p>
                                    <p><strong>è®¢å•çŠ¶æ€ï¼š</strong>${this.getOrderStatusText(order.order_status)}</p>
                                </div>
                                
                                <div class="item-list">
                                    <h3 style="margin-bottom: 10px;">èœå“æ¸…å•</h3>
                    `;
                    
                    order.items.forEach(item => {
                        html += `
                            <div class="item">
                                <div class="item-name">${item.menu_item_name}</div>
                                <div class="item-qty">x${item.quantity}</div>
                            </div>
                        `;
                    });
                    
                    html += `
                                </div>
                                
                                <div class="remark">
                                    <p><strong>å¤‡æ³¨ï¼š</strong>${order.remark || 'æ— '}</p>
                                    ${order.payment_method === 'counter' ? '<p style="color: #e6a23c; font-weight: bold;">âš ï¸ æŸœå°æ”¯ä»˜</p>' : ''}
                                </div>
                                
                                <div class="footer">
                                    <p style="margin: 5px 0;">æ‰“å°æ—¶é—´ï¼š${new Date().toLocaleString('zh-CN')}</p>
                                    <p style="margin: 5px 0; font-size: 12px;">è¯·å°½å¿«åˆ¶ä½œ</p>
                                </div>
                                
                                <script>
                                    window.onload = function() {
                                        window.print();
                                    }
                                <\/script>
                            </body>
                        </html>
                    `;
                    
                    printWindow.document.write(html);
                },
                
                printWaiterOrder(order) {
                    // æ‰“å°ä¼ èœå‘˜è®¢å•
                    const printWindow = window.open('', '_blank');
                    const now = new Date();
                    const dateStr = now.toLocaleDateString('zh-CN');
                    const timeStr = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                    
                    let html = `
                        <html>
                            <head>
                                <title>ä¼ èœå‘˜è®¢å• - ${order.order_id}</title>
                                <style>
                                    body { 
                                        font-family: 'å®‹ä½“', 'Microsoft YaHei', Arial, sans-serif; 
                                        padding: 20px; 
                                        font-size: 14px;
                                        line-height: 1.6;
                                    }
                                    .header { 
                                        text-align: center; 
                                        border-bottom: 2px solid #000; 
                                        padding-bottom: 10px; 
                                        margin-bottom: 15px; 
                                    }
                                    .order-info { 
                                        margin-bottom: 15px; 
                                        padding: 10px; 
                                        background: #f5f5f5; 
                                    }
                                    .item-list { 
                                        margin: 15px 0; 
                                    }
                                    .item { 
                                        display: flex; 
                                        justify-content: space-between; 
                                        padding: 8px 0; 
                                        border-bottom: 1px dashed #ccc; 
                                    }
                                    .item-name { 
                                        flex: 1; 
                                        font-weight: bold; 
                                    }
                                    .item-qty { 
                                        width: 80px; 
                                        text-align: right; 
                                        font-size: 16px;
                                        font-weight: bold;
                                    }
                                    .footer { 
                                        text-align: center; 
                                        margin-top: 20px; 
                                        padding-top: 10px; 
                                        border-top: 1px dashed #000; 
                                    }
                                    .remark { 
                                        color: #e6a23c; 
                                        margin-top: 10px; 
                                    }
                                    .total-section {
                                        margin-top: 15px;
                                        padding: 10px;
                                        background: #f0f9ff;
                                        border-radius: 5px;
                                    }
                                </style>
                            </head>
                            <body>
                                <div class="header">
                                    <h1 style="margin: 0; font-size: 24px;">ğŸ¤µ ä¼ èœå‘˜è®¢å•</h1>
                                    <p style="margin: 10px 0; font-size: 18px;">${this.storeInfo.name || 'ç¾å‘³é¤å…'}</p>
                                </div>
                                
                                <div class="order-info">
                                    <p><strong>è®¢å•å·ï¼š</strong>${order.order_id}</p>
                                    <p><strong>æ¡Œå·ï¼š</strong>${order.table_number}å·æ¡Œ</p>
                                    <p><strong>ä¸‹å•æ—¶é—´ï¼š</strong>${dateStr} ${timeStr}</p>
                                    <p><strong>è®¢å•çŠ¶æ€ï¼š</strong>${this.getOrderStatusText(order.order_status)}</p>
                                </div>
                                
                                <div class="item-list">
                                    <h3 style="margin-bottom: 10px;">èœå“æ¸…å•</h3>
                    `;
                    
                    order.items.forEach(item => {
                        html += `
                            <div class="item">
                                <div class="item-name">${item.menu_item_name}</div>
                                <div class="item-qty">x${item.quantity}</div>
                            </div>
                        `;
                    });
                    
                    html += `
                                </div>
                                
                                <div class="total-section">
                                    <p><strong>è®¢å•æ€»é¢ï¼š</strong>Â¥${order.total_amount.toFixed(2)}</p>
                                    <p><strong>æ”¯ä»˜æ–¹å¼ï¼š</strong>${order.payment_method === 'immediate' ? 'å·²æ”¯ä»˜' : 'æŸœå°æ”¯ä»˜'}</p>
                                    <p><strong>æ”¯ä»˜çŠ¶æ€ï¼š</strong>${order.payment_status === 'paid' ? 'å·²æ”¯ä»˜' : 'æœªæ”¯ä»˜'}</p>
                                </div>
                                
                                <div class="remark">
                                    <p><strong>å¤‡æ³¨ï¼š</strong>${order.remark || 'æ— '}</p>
                                    ${order.payment_method === 'counter' ? '<p style="color: #e6a23c; font-weight: bold;">âš ï¸ æé†’é¡¾å®¢åˆ°æ”¶é“¶å°æ”¯ä»˜</p>' : ''}
                                </div>
                                
                                <div class="footer">
                                    <p style="margin: 5px 0;">æ‰“å°æ—¶é—´ï¼š${new Date().toLocaleString('zh-CN')}</p>
                                    <p style="margin: 5px 0; font-size: 12px;">è¯·åŠæ—¶ä¼ èœ</p>
                                </div>
                                
                                <script>
                                    window.onload = function() {
                                        window.print();
                                    }
                                <\/script>
                            </body>
                        </html>
                    `;
                    
                    printWindow.document.write(html);
                },
                
                getOrderStatusText(status) {
                    const statusMap = {
                        'pending': 'å¾…ç¡®è®¤',
                        'confirmed': 'å·²ç¡®è®¤',
                        'preparing': 'åˆ¶ä½œä¸­',
                        'ready': 'å¾…ä¼ èœ',
                        'serving': 'ä¸Šèœä¸­',
                        'completed': 'å·²å®Œæˆ',
                        'cancelled': 'å·²å–æ¶ˆ'
                    };
                    return statusMap[status] || status;
                },
                
                viewOrderDetail(orderId) {
                    this.$message.info('æŸ¥çœ‹è®¢å•è¯¦æƒ…åŠŸèƒ½å¾…å®ç°');
                },
                
                async cancelOrder(orderId) {
                    this.$confirm('ç¡®è®¤å–æ¶ˆæ­¤è®¢å•å—ï¼Ÿ', 'æç¤º', {
                        confirmButtonText: 'ç¡®å®š',
                        cancelButtonText: 'å–æ¶ˆ',
                        type: 'warning'
                    }).then(async () => {
                        try {
                            await axios.patch(`/restaurant/api/orders/${orderId}/status`, {
                                status: 'cancelled'
                            });
                            this.$message.success('è®¢å•å·²å–æ¶ˆ');
                            this.loadOrders();
                        } catch (error) {
                            this.$message.error('æ“ä½œå¤±è´¥: ' + (error.response?.data?.detail || error.message));
                        }
                    });
                },
                
                canCancel(order) {
                    return ['pending', 'confirmed'].includes(order.status);
                },
                
                getEmptyText() {
                    const textMap = {
                        'manager': 'æš‚æ— è®¢å•',
                        'kitchen': 'æš‚æ— å¾…åˆ¶ä½œè®¢å•',
                        'waiter': 'æš‚æ— å¾…ä¼ èœå“',
                        'cashier': 'æš‚æ— å¾…æ”¯ä»˜è®¢å•'
                    };
                    return textMap[this.currentRole] || 'æš‚æ— æ•°æ®';
                },
                
                logout() {
                    this.$confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ\nAre you sure you want to logout?', 'æç¤º / Confirm', {
                        confirmButtonText: 'ç¡®å®š / Yes',
                        cancelButtonText: 'å–æ¶ˆ / Cancel',
                        type: 'warning'
                    }).then(() => {
                        localStorage.removeItem('currentUser');
                        ElementPlus.ElMessage.success('é€€å‡ºæˆåŠŸ / Logout successful');
                        setTimeout(() => {
                            window.location.href = 'login.html';
                        }, 500);
                    }).catch(() => {
                        // ç”¨æˆ·å–æ¶ˆ
                    });
                }
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>
