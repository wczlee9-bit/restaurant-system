<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åº—é“ºè®¾ç½® - æ‰«ç ç‚¹é¤ç³»ç»Ÿ</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/qrcodejs@1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <script src="https://unpkg.com/element-plus/dist/index.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', Arial, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        }
        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }
        .tabs {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .tab-content {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        }
        .section-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        .table-card {
            border: 1px solid #e4e7ed;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        .table-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .table-number {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        .table-info {
            color: #666;
            margin-bottom: 10px;
        }
        .qrcode-preview {
            text-align: center;
            margin-top: 15px;
            padding: 15px;
            background: #f5f7fa;
            border-radius: 8px;
        }
        .qrcode-preview img {
            width: 150px;
            height: 150px;
            margin-bottom: 10px;
        }
        .qrcode-url {
            font-size: 12px;
            color: #999;
            word-break: break-all;
        }
        .form-item {
            margin-bottom: 20px;
        }
        .form-item label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        .form-item .desc {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }
        .actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .back-btn {
            display: inline-block;
            color: white;
            text-decoration: none;
            padding: 8px 20px;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            transition: all 0.3s;
        }
        .back-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        .empty-state i {
            font-size: 48px;
            margin-bottom: 20px;
        }
        @media print {
            .no-print {
                display: none !important;
            }
            .tab-content {
                box-shadow: none;
                border: none;
            }
            .table-card {
                page-break-inside: avoid;
            }
        }

        /* Logoä¸Šä¼ æ ·å¼ */
        .logo-uploader {
            border: 1px dashed #d9d9d9;
            border-radius: 6px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            width: 150px;
            height: 150px;
            background: #fafafa;
        }
        .logo-uploader:hover {
            border-color: #667eea;
        }
        .logo-uploader-icon {
            font-size: 28px;
            color: #8c939d;
            width: 150px;
            height: 150px;
            line-height: 150px;
            text-align: center;
        }
        .logo-preview {
            width: 150px;
            height: 150px;
            display: block;
            object-fit: contain;
        }
        .qrcode-config-card {
            border: 1px solid #e4e7ed;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1>ğŸª åº—é“ºè®¾ç½®</h1>
                    <p>ç®¡ç†åº—é“ºä¿¡æ¯ã€æ¡Œå·å’ŒäºŒç»´ç </p>
                </div>
                <div class="no-print">
                    <a href="index.html" class="back-btn">â† è¿”å›é¦–é¡µ</a>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="tabs no-print">
                <el-tabs v-model="activeTab" @tab-change="handleTabChange">
                    <el-tab-pane label="åº—é“ºä¿¡æ¯" name="shop"></el-tab-pane>
                    <el-tab-pane label="æ¡Œå·ç®¡ç†" name="tables">
                        <span>æ¡Œå·ç®¡ç†</span>
                        <el-badge :value="tables.length" class="item" v-if="tables.length > 0"></el-badge>
                    </el-tab-pane>
                    <el-tab-pane label="äºŒç»´ç ç®¡ç†" name="qrcode"></el-tab-pane>
                    <el-tab-pane label="æµç¨‹é…ç½®" name="workflow"></el-tab-pane>
                    <el-tab-pane label="çµæ´»é…ç½®" name="flexible">
                        <template #label>
                            <span>ğŸ¯ çµæ´»é…ç½®</span>
                        </template>
                    </el-tab-pane>
                </el-tabs>
            </div>

            <!-- åº—é“ºä¿¡æ¯ -->
            <div class="tab-content" v-show="activeTab === 'shop'">
                <div class="section-title">ğŸ“‹ åº—é“ºåŸºæœ¬ä¿¡æ¯</div>
                <el-form :model="shopInfo" label-width="120px">
                    <el-form-item label="åº—é“ºåç§°">
                        <el-input v-model="shopInfo.name" placeholder="è¯·è¾“å…¥åº—é“ºåç§°"></el-input>
                    </el-form-item>
                    <el-form-item label="åº—é“ºåœ°å€">
                        <el-input v-model="shopInfo.address" placeholder="è¯·è¾“å…¥åº—é“ºåœ°å€"></el-input>
                    </el-form-item>
                    <el-form-item label="è”ç³»ç”µè¯">
                        <el-input v-model="shopInfo.phone" placeholder="è¯·è¾“å…¥è”ç³»ç”µè¯"></el-input>
                    </el-form-item>
                    <el-form-item label="è¥ä¸šæ—¶é—´">
                        <el-time-picker
                            v-model="shopInfo.openingHours"
                            is-range
                            range-separator="è‡³"
                            start-placeholder="å¼€å§‹æ—¶é—´"
                            end-placeholder="ç»“æŸæ—¶é—´"
                            value-format="HH:mm">
                        </el-time-picker>
                    </el-form-item>
                    <el-form-item label="åº—é“ºæè¿°">
                        <el-input
                            v-model="shopInfo.description"
                            type="textarea"
                            :rows="4"
                            placeholder="è¯·è¾“å…¥åº—é“ºæè¿°">
                        </el-input>
                    </el-form-item>
                    <el-form-item>
                        <el-button type="primary" @click="saveShopInfo">ä¿å­˜åº—é“ºä¿¡æ¯</el-button>
                        <el-button @click="resetShopInfo">é‡ç½®</el-button>
                    </el-form-item>
                </el-form>
            </div>

            <!-- æ¡Œå·ç®¡ç† -->
            <div class="tab-content" v-show="activeTab === 'tables'">
                <div class="section-title" style="display: flex; justify-content: space-between; align-items: center;">
                    <span>ğŸª‘ æ¡Œå·åˆ—è¡¨</span>
                    <el-button type="primary" @click="showAddTableDialog = true">+ æ·»åŠ æ¡Œå·</el-button>
                </div>

                <div v-if="tables.length === 0" class="empty-state">
                    <i class="el-icon-table"></i>
                    <p>è¿˜æ²¡æœ‰æ·»åŠ æ¡Œå·</p>
                    <el-button type="primary" @click="showAddTableDialog = true">ç«‹å³æ·»åŠ </el-button>
                </div>

                <div v-else>
                    <div v-for="table in tables" :key="table.id" class="table-card">
                        <div class="table-header">
                            <div class="table-number">{{ table.number }}å·æ¡Œ</div>
                            <div class="actions no-print">
                                <el-button size="small" @click="editTable(table)">ç¼–è¾‘</el-button>
                                <el-button size="small" type="primary" @click="generateQrcode(table)">ç”ŸæˆäºŒç»´ç </el-button>
                                <el-button size="small" type="danger" @click="deleteTable(table)">åˆ é™¤</el-button>
                            </div>
                        </div>
                        <div class="table-info">
                            <div><strong>åº§ä½æ•°ï¼š</strong>{{ table.seats }}äºº</div>
                            <div><strong>çŠ¶æ€ï¼š</strong>
                                <el-tag v-if="table.status === 'active'" type="success">å¯ç”¨</el-tag>
                                <el-tag v-else type="info">ç¦ç”¨</el-tag>
                            </div>
                            <div><strong>å¤‡æ³¨ï¼š</strong>{{ table.remark || 'æ— ' }}</div>
                        </div>
                        <div class="qrcode-preview" v-if="table.qrcodeUrl">
                            <img :src="table.qrcodeUrl" :alt="table.number + 'å·æ¡ŒäºŒç»´ç '">
                            <div class="qrcode-url">{{ table.qrcodeUrl }}</div>
                            <div class="actions" style="margin-top: 10px;">
                                <el-button size="small" @click="downloadQrcode(table)">ä¸‹è½½</el-button>
                                <el-button size="small" @click="printQrcode(table)">æ‰“å°</el-button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- äºŒç»´ç ç®¡ç† -->
            <div class="tab-content" v-show="activeTab === 'qrcode'">
                <div class="section-title" style="display: flex; justify-content: space-between; align-items: center;">
                    <span>ğŸ“± äºŒç»´ç ç®¡ç†</span>
                    <div class="actions">
                        <el-button @click="generateAllQrcodes" :loading="generating">æ‰¹é‡ç”Ÿæˆæ‰€æœ‰äºŒç»´ç </el-button>
                        <el-button type="success" @click="printAllQrcodes">æ‰¹é‡æ‰“å°</el-button>
                    </div>
                </div>

                <el-alert
                    title="æç¤º"
                    type="info"
                    description="äºŒç»´ç ç”Ÿæˆåä¼šä¿å­˜åˆ° assets/qrcodes/ ç›®å½•ã€‚æ‚¨å¯ä»¥ä¸ºæ¯ä¸ªæ¡Œå·ç”Ÿæˆç‹¬ç«‹çš„äºŒç»´ç ï¼Œé¡¾å®¢æ‰«ç åä¼šè‡ªåŠ¨è·³è½¬åˆ°å¯¹åº”çš„ç‚¹é¤é¡µé¢ã€‚"
                    :closable="false"
                    style="margin-bottom: 20px;">
                </el-alert>

                <!-- äºŒç»´ç æ ·å¼é…ç½® -->
                <div class="qrcode-config-card" style="background: #f9f9f9; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px; color: #333;">ğŸ¨ äºŒç»´ç æ ·å¼é…ç½®</h3>

                    <el-form :model="qrcodeStyle" label-width="120px">
                        <el-row :gutter="20">
                            <el-col :span="8">
                                <el-form-item label="å‰æ™¯è‰²">
                                    <el-color-picker v-model="qrcodeStyle.foregroundColor" show-alpha></el-color-picker>
                                    <span style="margin-left: 10px; font-size: 12px; color: #666;">{{ qrcodeStyle.foregroundColor }}</span>
                                </el-form-item>
                            </el-col>
                            <el-col :span="8">
                                <el-form-item label="èƒŒæ™¯è‰²">
                                    <el-color-picker v-model="qrcodeStyle.backgroundColor" show-alpha></el-color-picker>
                                    <span style="margin-left: 10px; font-size: 12px; color: #666;">{{ qrcodeStyle.backgroundColor }}</span>
                                </el-form-item>
                            </el-col>
                            <el-col :span="8">
                                <el-form-item label="Logoå¤§å°">
                                    <el-slider v-model="qrcodeStyle.logoRatio" :min="0.1" :max="0.4" :step="0.05" :marks="{0.1: '10%', 0.2: '20%', 0.3: '30%', 0.4: '40%'}"></el-slider>
                                </el-form-item>
                            </el-col>
                        </el-row>

                        <el-form-item label="ä¸Šä¼ Logo">
                            <el-upload
                                class="logo-uploader"
                                action="#"
                                :show-file-list="true"
                                :on-change="handleLogoChange"
                                :auto-upload="false"
                                :limit="1"
                                accept="image/png,image/jpeg,image/jpg">
                                <img v-if="qrcodeStyle.logoUrl" :src="qrcodeStyle.logoUrl" class="logo-preview" />
                                <el-icon v-else class="logo-uploader-icon"><plus /></el-icon>
                            </el-upload>
                            <div style="margin-top: 10px; font-size: 12px; color: #999;">
                                å»ºè®®ä¸Šä¼ æ­£æ–¹å½¢å›¾ç‰‡ï¼ˆå¦‚200x200ï¼‰ï¼Œæ”¯æŒPNGã€JPGæ ¼å¼ã€‚Logoå°†æ˜¾ç¤ºåœ¨äºŒç»´ç ä¸­å¿ƒã€‚
                            </div>
                        </el-form-item>

                        <el-form-item>
                            <el-button type="primary" @click="saveQrcodeStyle">ä¿å­˜æ ·å¼é…ç½®</el-button>
                            <el-button @click="resetQrcodeStyle">é‡ç½®ä¸ºé»˜è®¤</el-button>
                            <el-button type="success" @click="previewStyledQrcode">é¢„è§ˆæ•ˆæœ</el-button>
                        </el-form-item>
                    </el-form>
                </div>

                <div v-if="tables.length === 0" class="empty-state">
                    <i class="el-icon-picture"></i>
                    <p>è¿˜æ²¡æœ‰æ·»åŠ æ¡Œå·ï¼Œæ— æ³•ç”ŸæˆäºŒç»´ç </p>
                    <el-button type="primary" @click="activeTab = 'tables'">å»æ·»åŠ æ¡Œå·</el-button>
                </div>

                <div v-else>
                    <el-table :data="tables" style="width: 100%">
                        <el-table-column prop="number" label="æ¡Œå·" width="100">
                            <template #default="scope">
                                <strong>{{ scope.row.number }}å·</strong>
                            </template>
                        </el-table-column>
                        <el-table-column prop="seats" label="åº§ä½æ•°" width="100"></el-table-column>
                        <el-table-column label="äºŒç»´ç " width="200">
                            <template #default="scope">
                                <el-tag v-if="scope.row.qrcodeUrl" type="success">å·²ç”Ÿæˆ</el-tag>
                                <el-tag v-else type="info">æœªç”Ÿæˆ</el-tag>
                            </template>
                        </el-table-column>
                        <el-table-column label="äºŒç»´ç URL" min-width="300">
                            <template #default="scope">
                                <span v-if="scope.row.qrcodeUrl" style="font-size: 12px; color: #666;">
                                    {{ scope.row.qrcodeUrl }}
                                </span>
                                <span v-else style="color: #999;">-</span>
                            </template>
                        </el-table-column>
                        <el-table-column label="æ“ä½œ" width="200" fixed="right">
                            <template #default="scope">
                                <el-button size="small" @click="generateQrcode(scope.row)">
                                    ç”Ÿæˆ
                                </el-button>
                                <el-button size="small" @click="previewQrcode(scope.row)">
                                    é¢„è§ˆ
                                </el-button>
                            </template>
                        </el-table-column>
                    </el-table>
                </div>

                <!-- çµæ´»é…ç½® -->
                <div class="tab-content" v-show="activeTab === 'flexible'">
                    <div class="section-title">ğŸ¯ çµæ´»è®¢å•æµç¨‹é…ç½®</div>
                    
                    <el-alert
                        title="æ–°åŠŸèƒ½"
                        type="success"
                        description="å…¨æ–°çµæ´»é…ç½®åŠŸèƒ½ï¼Œæ”¯æŒè‡ªå®šä¹‰è§’è‰²å’ŒåŠŸèƒ½åˆ†é…ã€‚"
                        :closable="false"
                        style="margin-bottom: 20px;">
                    </el-alert>

                    <div class="info-card" style="background: #f0f9ff; border-left: 4px solid #1890ff; padding: 20px; border-radius: 4px; margin-bottom: 20px;">
                        <h3 style="color: #333; margin-bottom: 15px;">âœ¨ çµæ´»é…ç½®åŠŸèƒ½ç‰¹æ€§ï¼š</h3>
                        <ul style="color: #666; line-height: 2; padding-left: 20px;">
                            <li><strong>è‡ªå®šä¹‰è§’è‰²</strong>ï¼šæ”¯æŒåˆ›å»ºã€ç¼–è¾‘ã€åˆ é™¤è§’è‰²ï¼Œæ¯ä¸ªåº—é“ºå¯ä»¥æœ‰ç‹¬ç«‹çš„è§’è‰²é…ç½®</li>
                            <li><strong>åŠŸèƒ½çµæ´»åˆ†é…</strong>ï¼šå°†è®¢å•çŠ¶æ€ï¼ˆå¾…ç¡®è®¤ã€åˆ¶ä½œä¸­ã€å¾…ä¼ èœã€ä¸Šèœä¸­ã€å·²å®Œæˆï¼‰åˆ†é…ç»™ä»»æ„è§’è‰²</li>
                            <li><strong>æ“ä½œæ–¹å¼ç‹¬ç«‹é…ç½®</strong>ï¼šæ¯ä¸ªè§’è‰²å¯¹æ¯ä¸ªçŠ¶æ€çš„æ“ä½œæ–¹å¼å¯ä»¥ç‹¬ç«‹é…ç½®ï¼ˆé€é¡¹ç¡®è®¤ã€è®¢å•ç¡®è®¤ã€è‡ªåŠ¨è·³è¿‡ã€å¿½ç•¥ä¸æ˜¾ç¤ºï¼‰</li>
                            <li><strong>ç¤ºä¾‹åœºæ™¯</strong>ï¼šä¼ èœå‘˜è§’è‰²å¯ä»¥ä¸é…ç½®ï¼Œä¼ èœåŠŸèƒ½å¯ä»¥åˆ†é…ç»™æ”¶é“¶å‘˜</li>
                        </ul>
                    </div>

                    <div style="text-align: center; margin-top: 40px;">
                        <el-button type="primary" size="large" @click="goToFlexibleConfig">
                            è¿›å…¥çµæ´»é…ç½®é¡µé¢
                            <el-icon style="margin-left: 8px;"><arrow-right /></el-icon>
                        </el-button>
                    </div>
                </div>
            </div>

            <!-- æµç¨‹é…ç½® -->
            <div class="tab-content" v-show="activeTab === 'workflow'">
                <div class="section-title" style="display: flex; justify-content: space-between; align-items: center;">
                    <span>âš™ï¸ è®¢å•æµç¨‹é…ç½®</span>
                    <div class="actions">
                        <el-button @click="resetWorkflowConfig" type="warning">é‡ç½®ä¸ºé»˜è®¤</el-button>
                        <el-button type="primary" @click="saveWorkflowConfig" :loading="saving">ä¿å­˜é…ç½®</el-button>
                    </div>
                </div>

                <el-alert
                    title="é…ç½®è¯´æ˜"
                    type="info"
                    description="é…ç½®æ¯ä¸ªè§’è‰²åœ¨è®¢å•å„ç¯èŠ‚çš„æ“ä½œæ–¹å¼ã€‚æ“ä½œæ¨¡å¼è¯´æ˜ï¼šé€é¡¹ç¡®è®¤ï¼ˆæ¯é“èœå•ç‹¬ç¡®è®¤ï¼‰ã€è®¢å•ç¡®è®¤ï¼ˆæ•´ä¸ªè®¢å•ä¸€èµ·ç¡®è®¤ï¼‰ã€è‡ªåŠ¨è·³è¿‡ï¼ˆè‡ªåŠ¨æµè½¬åˆ°ä¸‹ä¸€çŠ¶æ€ï¼‰ã€å¿½ç•¥ä¸æ˜¾ç¤ºï¼ˆä¸æ˜¾ç¤ºè¯¥çŠ¶æ€ï¼‰ã€‚"
                    :closable="false"
                    style="margin-bottom: 20px;">
                </el-alert>

                <div v-for="(roleConfigs, roleName) in groupedWorkflowConfigs" :key="roleName" style="margin-bottom: 30px;">
                    <h3 style="margin-bottom: 15px; color: #333; padding: 10px; background: #f5f7fa; border-radius: 4px;">
                        {{ roleName }}
                    </h3>
                    <el-table :data="roleConfigs" style="width: 100%; background: white;">
                        <el-table-column prop="status_name" label="è®¢å•çŠ¶æ€" width="150"></el-table-column>
                        <el-table-column label="æ“ä½œæ¨¡å¼" width="250">
                            <template #default="scope">
                                <el-select v-model="scope.row.action_mode" placeholder="è¯·é€‰æ‹©" style="width: 100%;">
                                    <el-option label="é€é¡¹ç¡®è®¤" value="per_item"></el-option>
                                    <el-option label="è®¢å•ç¡®è®¤" value="per_order"></el-option>
                                    <el-option label="è‡ªåŠ¨è·³è¿‡" value="skip"></el-option>
                                    <el-option label="å¿½ç•¥ä¸æ˜¾ç¤º" value="ignore"></el-option>
                                </el-select>
                            </template>
                        </el-table-column>
                        <el-table-column label="æ˜¯å¦å¯ç”¨" width="100">
                            <template #default="scope">
                                <el-switch v-model="scope.row.is_enabled"></el-switch>
                            </template>
                        </el-table-column>
                        <el-table-column label="è¯´æ˜">
                            <template #default="scope">
                                <span style="font-size: 12px; color: #666;">
                                    {{ getActionModeDescription(scope.row.action_mode) }}
                                </span>
                            </template>
                        </el-table-column>
                    </el-table>
                </div>
            </div>
        </div>

        <!-- æ·»åŠ /ç¼–è¾‘æ¡Œå·å¯¹è¯æ¡† -->
        <el-dialog
            v-model="showAddTableDialog"
            :title="editingTable ? 'ç¼–è¾‘æ¡Œå·' : 'æ·»åŠ æ¡Œå·'"
            width="500px">
            <el-form :model="tableForm" label-width="80px">
                <el-form-item label="æ¡Œå·">
                    <el-input-number v-model="tableForm.number" :min="1" :max="999" label="æ¡Œå·"></el-input-number>
                </el-form-item>
                <el-form-item label="åº§ä½æ•°">
                    <el-input-number v-model="tableForm.seats" :min="1" :max="20" label="åº§ä½æ•°"></el-input-number>
                </el-form-item>
                <el-form-item label="çŠ¶æ€">
                    <el-radio-group v-model="tableForm.status">
                        <el-radio label="active">å¯ç”¨</el-radio>
                        <el-radio label="disabled">ç¦ç”¨</el-radio>
                    </el-radio-group>
                </el-form-item>
                <el-form-item label="å¤‡æ³¨">
                    <el-input v-model="tableForm.remark" type="textarea" :rows="3"></el-input>
                </el-form-item>
            </el-form>
            <template #footer>
                <span class="dialog-footer">
                    <el-button @click="showAddTableDialog = false">å–æ¶ˆ</el-button>
                    <el-button type="primary" @click="saveTable">ç¡®å®š</el-button>
                </span>
            </template>
        </el-dialog>

        <!-- äºŒç»´ç é¢„è§ˆå¯¹è¯æ¡† -->
        <el-dialog v-model="showPreviewDialog" title="äºŒç»´ç é¢„è§ˆ" width="400px">
            <div style="text-align: center;">
                <img :src="previewQrcodeUrl" style="width: 250px; height: 250px; margin-bottom: 20px;">
                <p style="font-size: 12px; color: #999;">{{ previewQrcodeUrl }}</p>
            </div>
            <template #footer>
                <span class="dialog-footer">
                    <el-button @click="showPreviewDialog = false">å…³é—­</el-button>
                    <el-button type="primary" @click="downloadPreviewQrcode">ä¸‹è½½</el-button>
                </span>
            </template>
        </el-dialog>
    </div>

    <script>
        const { createApp, ref, reactive, computed } = Vue;

        createApp({
            setup() {
                const activeTab = ref('tables');
                const showAddTableDialog = ref(false);
                const showPreviewDialog = ref(false);
                const editingTable = ref(null);
                const generating = ref(false);
                const previewQrcodeUrl = ref('');

                // åº—é“ºä¿¡æ¯
                const shopInfo = reactive({
                    name: 'ç¾å‘³é¤å…',
                    address: 'åŒ—äº¬å¸‚æœé˜³åŒºxxxè¡—é“xxxå·',
                    phone: '010-12345678',
                    openingHours: ['09:00', '22:00'],
                    description: 'æä¾›ä¼˜è´¨çš„é¤é¥®æœåŠ¡ï¼Œæ¬¢è¿å…‰ä¸´ï¼'
                });

                // æ¡Œå·åˆ—è¡¨
                const tables = ref([
                    { id: 1, number: 1, seats: 4, status: 'active', remark: 'é çª—ä½ç½®', qrcodeUrl: '' },
                    { id: 2, number: 2, seats: 4, status: 'active', remark: '', qrcodeUrl: '' },
                    { id: 3, number: 3, seats: 6, status: 'active', remark: 'å¤§æ¡Œ', qrcodeUrl: '' },
                    { id: 4, number: 4, seats: 2, status: 'active', remark: 'æƒ…ä¾£æ¡Œ', qrcodeUrl: '' },
                    { id: 5, number: 5, seats: 8, status: 'active', remark: 'åŒ…å¢', qrcodeUrl: '' },
                    { id: 6, number: 6, seats: 4, status: 'active', remark: '', qrcodeUrl: '' },
                    { id: 7, number: 7, seats: 4, status: 'active', remark: '', qrcodeUrl: '' },
                    { id: 8, number: 8, seats: 4, status: 'active', remark: '', qrcodeUrl: '' },
                    { id: 9, number: 9, seats: 6, status: 'active', remark: '', qrcodeUrl: '' },
                    { id: 10, number: 10, seats: 4, status: 'active', remark: '', qrcodeUrl: '' }
                ]);

                // æ¡Œå·è¡¨å•
                const tableForm = reactive({
                    number: 1,
                    seats: 4,
                    status: 'active',
                    remark: ''
                });

                // äºŒç»´ç æ ·å¼é…ç½®
                const qrcodeStyle = reactive({
                    foregroundColor: '#000000',
                    backgroundColor: '#ffffff',
                    logoUrl: '',
                    logoData: null,
                    logoRatio: 0.2
                });

                // å·¥ä½œæµç¨‹é…ç½®
                const workflowConfigs = ref([]);
                const saving = ref(false);
                const loading = ref(false);

                // è®¡ç®—å±æ€§ï¼šæŒ‰è§’è‰²åˆ†ç»„
                const groupedWorkflowConfigs = computed(() => {
                    const grouped = {};
                    workflowConfigs.value.forEach(config => {
                        if (!grouped[config.role_name]) {
                            grouped[config.role_name] = [];
                        }
                        grouped[config.role_name].push(config);
                    });
                    return grouped;
                });

                // è·å–å½“å‰é¡µé¢çš„åŸºç¡€URL
                const getBaseUrl = () => {
                    const url = window.location.href;
                    return url.substring(0, url.lastIndexOf('/'));
                };

                // ç”ŸæˆäºŒç»´ç URL
                const generateQrcodeUrl = (tableNumber) => {
                    const baseUrl = getBaseUrl();
                    return `${baseUrl}/restaurant_full_test.html?table=${tableNumber}`;
                };

                // ä¿å­˜åº—é“ºä¿¡æ¯
                const saveShopInfo = () => {
                    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                    localStorage.setItem('shopInfo', JSON.stringify(shopInfo));
                    ElementPlus.ElMessage.success('åº—é“ºä¿¡æ¯å·²ä¿å­˜');
                };

                // é‡ç½®åº—é“ºä¿¡æ¯
                const resetShopInfo = () => {
                    localStorage.removeItem('shopInfo');
                    shopInfo.name = 'ç¾å‘³é¤å…';
                    shopInfo.address = 'åŒ—äº¬å¸‚æœé˜³åŒºxxxè¡—é“xxxå·';
                    shopInfo.phone = '010-12345678';
                    shopInfo.openingHours = ['09:00', '22:00'];
                    shopInfo.description = 'æä¾›ä¼˜è´¨çš„é¤é¥®æœåŠ¡ï¼Œæ¬¢è¿å…‰ä¸´ï¼';
                    ElementPlus.ElMessage.success('å·²é‡ç½®åº—é“ºä¿¡æ¯');
                };

                // åŠ è½½å·¥ä½œæµç¨‹é…ç½®
                const loadWorkflowConfig = async () => {
                    loading.value = true;
                    try {
                        const response = await fetch('/api/workflow-config/');
                        if (response.ok) {
                            const data = await response.json();
                            workflowConfigs.value = data;
                        }
                    } catch (error) {
                        console.error('åŠ è½½å·¥ä½œæµç¨‹é…ç½®å¤±è´¥:', error);
                    } finally {
                        loading.value = false;
                    }
                };

                // å¤„ç†Logoä¸Šä¼ 
                const handleLogoChange = (file) => {
                    const isImage = file.raw.type.startsWith('image/');
                    const isLt2M = file.raw.size / 1024 / 1024 < 2;

                    if (!isImage) {
                        ElementPlus.ElMessage.error('åªèƒ½ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶ï¼');
                        return false;
                    }
                    if (!isLt2M) {
                        ElementPlus.ElMessage.error('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡2MBï¼');
                        return false;
                    }

                    // è¯»å–å›¾ç‰‡ä¸ºbase64
                    const reader = new FileReader();
                    reader.readAsDataURL(file.raw);
                    reader.onload = () => {
                        qrcodeStyle.logoUrl = reader.result;
                        // ä¿å­˜åŸå§‹æ–‡ä»¶å¯¹è±¡
                        qrcodeStyle.logoData = file.raw;
                    };

                    return false; // é˜»æ­¢è‡ªåŠ¨ä¸Šä¼ 
                };

                // ä¿å­˜äºŒç»´ç æ ·å¼é…ç½®
                const saveQrcodeStyle = () => {
                    const styleData = {
                        foregroundColor: qrcodeStyle.foregroundColor,
                        backgroundColor: qrcodeStyle.backgroundColor,
                        logoUrl: qrcodeStyle.logoUrl,
                        logoRatio: qrcodeStyle.logoRatio
                    };
                    localStorage.setItem('qrcodeStyle', JSON.stringify(styleData));
                    ElementPlus.ElMessage.success('äºŒç»´ç æ ·å¼é…ç½®å·²ä¿å­˜');
                };

                // é‡ç½®äºŒç»´ç æ ·å¼é…ç½®
                const resetQrcodeStyle = () => {
                    qrcodeStyle.foregroundColor = '#000000';
                    qrcodeStyle.backgroundColor = '#ffffff';
                    qrcodeStyle.logoUrl = '';
                    qrcodeStyle.logoData = null;
                    qrcodeStyle.logoRatio = 0.2;
                    localStorage.removeItem('qrcodeStyle');
                    ElementPlus.ElMessage.success('å·²é‡ç½®äºŒç»´ç æ ·å¼é…ç½®');
                };

                // é¢„è§ˆæ ·å¼çš„äºŒç»´ç 
                const previewStyledQrcode = () => {
                    // ä½¿ç”¨ç¬¬ä¸€ä¸ªæ¡Œå·è¿›è¡Œé¢„è§ˆ
                    if (tables.value.length === 0) {
                        ElementPlus.ElMessage.warning('è¯·å…ˆæ·»åŠ æ¡Œå·');
                        return;
                    }

                    const table = tables.value[0];
                    const qrcodeContent = generateQrcodeUrl(table.number);

                    // åˆ›å»ºä¸´æ—¶å®¹å™¨ç”ŸæˆäºŒç»´ç 
                    const tempContainer = document.createElement('div');
                    tempContainer.style.display = 'none';
                    document.body.appendChild(tempContainer);

                    try {
                        new QRCode(tempContainer, {
                            text: qrcodeContent,
                            width: 300,
                            height: 300,
                            colorDark: qrcodeStyle.foregroundColor,
                            colorLight: qrcodeStyle.backgroundColor,
                            correctLevel: QRCode.CorrectLevel.H
                        });

                        setTimeout(() => {
                            const img = tempContainer.querySelector('img');
                            previewQrcodeUrl.value = img.src;
                            showPreviewDialog.value = true;
                            document.body.removeChild(tempContainer);
                        }, 100);
                    } catch (error) {
                        document.body.removeChild(tempContainer);
                        ElementPlus.ElMessage.error('ç”Ÿæˆé¢„è§ˆå¤±è´¥');
                    }
                };

                // ä»æœ¬åœ°å­˜å‚¨åŠ è½½äºŒç»´ç æ ·å¼
                const loadQrcodeStyle = () => {
                    const savedStyle = localStorage.getItem('qrcodeStyle');
                    if (savedStyle) {
                        const styleData = JSON.parse(savedStyle);
                        Object.assign(qrcodeStyle, styleData);
                    }
                };

                // ä¿å­˜å·¥ä½œæµç¨‹é…ç½®
                const saveWorkflowConfig = async () => {
                    saving.value = true;
                    try {
                        const configs = workflowConfigs.value.map(config => ({
                            id: config.id,
                            action_mode: config.action_mode,
                            is_enabled: config.is_enabled
                        }));

                        const response = await fetch('/api/workflow-config/bulk-update', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ configs })
                        });

                        if (response.ok) {
                            ElementPlus.ElMessage.success('å·¥ä½œæµç¨‹é…ç½®å·²ä¿å­˜');
                        } else {
                            ElementPlus.ElMessage.error('ä¿å­˜å¤±è´¥');
                        }
                    } catch (error) {
                        console.error('ä¿å­˜å·¥ä½œæµç¨‹é…ç½®å¤±è´¥:', error);
                        ElementPlus.ElMessage.error('ä¿å­˜å¤±è´¥');
                    } finally {
                        saving.value = false;
                    }
                };

                // é‡ç½®å·¥ä½œæµç¨‹é…ç½®
                const resetWorkflowConfig = async () => {
                    if (!confirm('ç¡®å®šè¦é‡ç½®ä¸ºé»˜è®¤é…ç½®å—ï¼Ÿ')) {
                        return;
                    }

                    try {
                        const response = await fetch('/api/workflow-config/reset-defaults', {
                            method: 'POST'
                        });

                        if (response.ok) {
                            ElementPlus.ElMessage.success('å·²é‡ç½®ä¸ºé»˜è®¤é…ç½®');
                            await loadWorkflowConfig();
                        } else {
                            ElementPlus.ElMessage.error('é‡ç½®å¤±è´¥');
                        }
                    } catch (error) {
                        console.error('é‡ç½®å·¥ä½œæµç¨‹é…ç½®å¤±è´¥:', error);
                        ElementPlus.ElMessage.error('é‡ç½®å¤±è´¥');
                    }
                };

                // è·å–æ“ä½œæ¨¡å¼æè¿°
                const getActionModeDescription = (mode) => {
                    const descriptions = {
                        'per_item': 'æ¯é“èœå•ç‹¬ç¡®è®¤ï¼Œå¨å¸ˆé€ä¸ªåˆ¶ä½œ',
                        'per_order': 'æ•´ä¸ªè®¢å•ä¸€èµ·ç¡®è®¤ï¼ŒæŒ‰è®¢å•æµè½¬',
                        'skip': 'è‡ªåŠ¨è·³è¿‡æ­¤æ­¥éª¤ï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œ',
                        'ignore': 'ä¸æ˜¾ç¤ºæ­¤çŠ¶æ€ï¼Œç›´æ¥è·³è¿‡'
                    };
                    return descriptions[mode] || '';
                };

                // ä¿å­˜æ¡Œå·
                const saveTable = () => {
                    if (editingTable.value) {
                        // ç¼–è¾‘
                        const index = tables.value.findIndex(t => t.id === editingTable.value.id);
                        if (index !== -1) {
                            tables.value[index] = {
                                ...tables.value[index],
                                number: tableForm.number,
                                seats: tableForm.seats,
                                status: tableForm.status,
                                remark: tableForm.remark
                            };
                        }
                    } else {
                        // æ–°å¢
                        const newId = Math.max(...tables.value.map(t => t.id)) + 1;
                        tables.value.push({
                            id: newId,
                            number: tableForm.number,
                            seats: tableForm.seats,
                            status: tableForm.status,
                            remark: tableForm.remark,
                            qrcodeUrl: ''
                        });
                    }

                    showAddTableDialog.value = false;
                    editingTable.value = null;
                    saveTablesToStorage();
                    ElementPlus.ElMessage.success(editingTable.value ? 'æ¡Œå·å·²æ›´æ–°' : 'æ¡Œå·å·²æ·»åŠ ');
                };

                // ç¼–è¾‘æ¡Œå·
                const editTable = (table) => {
                    editingTable.value = table;
                    tableForm.number = table.number;
                    tableForm.seats = table.seats;
                    tableForm.status = table.status;
                    tableForm.remark = table.remark;
                    showAddTableDialog.value = true;
                };

                // åˆ é™¤æ¡Œå·
                const deleteTable = (table) => {
                    ElementPlus.ElMessageBox.confirm(
                        `ç¡®å®šè¦åˆ é™¤${table.number}å·æ¡Œå—ï¼Ÿ`,
                        'æç¤º',
                        {
                            confirmButtonText: 'ç¡®å®š',
                            cancelButtonText: 'å–æ¶ˆ',
                            type: 'warning'
                        }
                    ).then(() => {
                        const index = tables.value.findIndex(t => t.id === table.id);
                        if (index !== -1) {
                            tables.value.splice(index, 1);
                            saveTablesToStorage();
                            ElementPlus.ElMessage.success('æ¡Œå·å·²åˆ é™¤');
                        }
                    }).catch(() => {});
                };

                // ç”ŸæˆäºŒç»´ç ï¼ˆä½¿ç”¨å‰ç«¯QRCode.jsï¼‰
                const generateQrcode = (table) => {
                    const qrcodeUrl = generateQrcodeUrl(table.number);
                    table.qrcodeUrl = qrcodeUrl;
                    saveTablesToStorage();
                    ElementPlus.ElMessage.success(`${table.number}å·æ¡ŒäºŒç»´ç å·²ç”Ÿæˆ`);
                };

                // ç”Ÿæˆå¸¦æ ·å¼çš„äºŒç»´ç ï¼ˆä½¿ç”¨åç«¯APIï¼‰
                const generateStyledQrcode = async (table) => {
                    try {
                        ElementPlus.ElMessage.info('æ­£åœ¨ç”ŸæˆäºŒç»´ç ï¼Œè¯·ç¨å€™...');

                        // å‡†å¤‡è¯·æ±‚æ•°æ®
                        const formData = new FormData();
                        formData.append('table_id', table.id);
                        formData.append('base_url', getBaseUrl());
                        formData.append('foreground_color', qrcodeStyle.foregroundColor);
                        formData.append('background_color', qrcodeStyle.backgroundColor);
                        formData.append('logo_ratio', qrcodeStyle.logoRatio);

                        // å¦‚æœæœ‰logoï¼Œæ·»åŠ logoæ•°æ®
                        if (qrcodeStyle.logoData) {
                            formData.append('logo', qrcodeStyle.logoData);
                        }

                        // è°ƒç”¨åç«¯API
                        const response = await fetch('/api/generate-styled-qrcode', {
                            method: 'POST',
                            body: formData
                        });

                        if (response.ok) {
                            const data = await response.json();
                            table.qrcodeUrl = data.qrcode_url;
                            saveTablesToStorage();
                            ElementPlus.ElMessage.success(`${table.number}å·æ¡ŒäºŒç»´ç å·²ç”Ÿæˆ`);
                        } else {
                            ElementPlus.ElMessage.error('ç”ŸæˆäºŒç»´ç å¤±è´¥');
                        }
                    } catch (error) {
                        console.error('ç”ŸæˆäºŒç»´ç å¤±è´¥:', error);
                        ElementPlus.ElMessage.error('ç”ŸæˆäºŒç»´ç å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                    }
                };

                // æ‰¹é‡ç”Ÿæˆæ‰€æœ‰äºŒç»´ç 
                const generateAllQrcodes = () => {
                    generating.value = true;
                    setTimeout(() => {
                        tables.value.forEach(table => {
                            if (!table.qrcodeUrl) {
                                table.qrcodeUrl = generateQrcodeUrl(table.number);
                            }
                        });
                        saveTablesToStorage();
                        generating.value = false;
                        ElementPlus.ElMessage.success('æ‰€æœ‰äºŒç»´ç å·²ç”Ÿæˆ');
                    }, 1000);
                };

                // é¢„è§ˆäºŒç»´ç 
                const previewQrcode = (table) => {
                    if (!table.qrcodeUrl) {
                        ElementPlus.ElMessage.warning('è¯·å…ˆç”ŸæˆäºŒç»´ç ');
                        return;
                    }
                    previewQrcodeUrl.value = table.qrcodeUrl;
                    showPreviewDialog.value = true;
                };

                // ä¸‹è½½äºŒç»´ç 
                const downloadQrcode = (table) => {
                    if (!table.qrcodeUrl) {
                        ElementPlus.ElMessage.warning('è¯·å…ˆç”ŸæˆäºŒç»´ç ');
                        return;
                    }

                    // ä½¿ç”¨QRCode.jsç”ŸæˆäºŒç»´ç å›¾ç‰‡
                    const qrContainer = document.createElement('div');
                    new QRCode(qrContainer, {
                        text: table.qrcodeUrl,
                        width: 300,
                        height: 300,
                        colorDark: "#000000",
                        colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel.H
                    });

                    setTimeout(() => {
                        const img = qrContainer.querySelector('img');
                        const link = document.createElement('a');
                        link.href = img.src;
                        link.download = `table_${table.number}_qrcode.png`;
                        link.click();
                    }, 100);
                };

                // ä¸‹è½½é¢„è§ˆäºŒç»´ç 
                const downloadPreviewQrcode = () => {
                    const link = document.createElement('a');
                    link.href = previewQrcodeUrl.value;
                    link.download = `qrcode_${Date.now()}.png`;
                    link.click();
                };

                // æ‰“å°äºŒç»´ç 
                const printQrcode = (table) => {
                    if (!table.qrcodeUrl) {
                        ElementPlus.ElMessage.warning('è¯·å…ˆç”ŸæˆäºŒç»´ç ');
                        return;
                    }

                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(`
                        <html>
                            <head>
                                <title>${table.number}å·æ¡ŒäºŒç»´ç </title>
                                <style>
                                    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
                                    .qrcode { width: 300px; height: 300px; margin: 20px auto; }
                                    .info { font-size: 18px; margin: 10px 0; }
                                </style>
                            </head>
                            <body>
                                <h1>${shopInfo.name}</h1>
                                <div class="info">${table.number}å·æ¡Œ</div>
                                <div class="info">åº§ä½æ•°ï¼š${table.seats}äºº</div>
                                <img src="${table.qrcodeUrl}" class="qrcode" />
                                <p>è¯·æ‰«æäºŒç»´ç ç‚¹é¤</p>
                                <script>
                                    window.onload = function() {
                                        window.print();
                                    }
                                <\/script>
                            </body>
                        </html>
                    `);
                };

                // æ‰¹é‡æ‰“å°æ‰€æœ‰äºŒç»´ç 
                const printAllQrcodes = () => {
                    const hasQrcode = tables.value.some(t => t.qrcodeUrl);
                    if (!hasQrcode) {
                        ElementPlus.ElMessage.warning('è¯·å…ˆç”ŸæˆäºŒç»´ç ');
                        return;
                    }

                    const printWindow = window.open('', '_blank');
                    let html = `
                        <html>
                            <head>
                                <title>æ¡Œå·äºŒç»´ç </title>
                                <style>
                                    body { font-family: Arial, sans-serif; padding: 20px; }
                                    .qrcode-card {
                                        border: 1px solid #ccc;
                                        padding: 20px;
                                        margin: 20px;
                                        display: inline-block;
                                        text-align: center;
                                        page-break-inside: avoid;
                                    }
                                    .qrcode { width: 200px; height: 200px; }
                                    .info { font-size: 16px; margin: 10px 0; }
                                </style>
                            </head>
                            <body>
                                <h1 style="text-align: center;">${shopInfo.name} - æ¡Œå·äºŒç»´ç </h1>
                    `;

                    tables.value.forEach(table => {
                        if (table.qrcodeUrl) {
                            html += `
                                <div class="qrcode-card">
                                    <h2>${table.number}å·æ¡Œ</h2>
                                    <div class="info">åº§ä½æ•°ï¼š${table.seats}äºº</div>
                                    <img src="${table.qrcodeUrl}" class="qrcode" />
                                    <p>è¯·æ‰«æäºŒç»´ç ç‚¹é¤</p>
                                </div>
                            `;
                        }
                    });

                    html += `
                                <script>
                                    window.onload = function() {
                                        window.print();
                                    }
                                <\/script>
                            </body>
                        </html>
                    `;

                    printWindow.document.write(html);
                };

                // ä¿å­˜æ¡Œå·åˆ°æœ¬åœ°å­˜å‚¨
                const saveTablesToStorage = () => {
                    localStorage.setItem('tables', JSON.stringify(tables.value));
                };

                // ä»æœ¬åœ°å­˜å‚¨åŠ è½½
                const loadFromStorage = () => {
                    const savedShopInfo = localStorage.getItem('shopInfo');
                    if (savedShopInfo) {
                        Object.assign(shopInfo, JSON.parse(savedShopInfo));
                    }

                    const savedTables = localStorage.getItem('tables');
                    if (savedTables) {
                        tables.value = JSON.parse(savedTables);
                    }

                    // åŠ è½½å·¥ä½œæµç¨‹é…ç½®
                    loadWorkflowConfig();
                };

                const handleTabChange = () => {
                    // Tabåˆ‡æ¢æ—¶çš„å¤„ç†
                };

                // è·³è½¬åˆ°çµæ´»é…ç½®é¡µé¢
                const goToFlexibleConfig = () => {
                    window.location.href = 'order_flow_config.html';
                };

                // åˆå§‹åŒ–
                loadFromStorage();
                loadQrcodeStyle();

                return {
                    activeTab,
                    showAddTableDialog,
                    showPreviewDialog,
                    editingTable,
                    generating,
                    previewQrcodeUrl,
                    shopInfo,
                    tables,
                    tableForm,
                    saveShopInfo,
                    resetShopInfo,
                    saveTable,
                    editTable,
                    deleteTable,
                    generateQrcode,
                    generateStyledQrcode,
                    generateAllQrcodes,
                    previewQrcode,
                    downloadQrcode,
                    downloadPreviewQrcode,
                    printQrcode,
                    printAllQrcodes,
                    handleTabChange,
                    goToFlexibleConfig,
                    workflowConfigs,
                    saving,
                    loading,
                    groupedWorkflowConfigs,
                    loadWorkflowConfig,
                    saveWorkflowConfig,
                    resetWorkflowConfig,
                    getActionModeDescription,
                    qrcodeStyle,
                    handleLogoChange,
                    saveQrcodeStyle,
                    resetQrcodeStyle,
                    previewStyledQrcode
                };
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>
