<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šåº—é“ºæ‰«ç ç‚¹é¤ç³»ç»Ÿ - å®Œæ•´æµ‹è¯•å¹³å°</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <script src="https://unpkg.com/element-plus/dist/index.full.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'PingFang SC', 'Microsoft YaHei', Arial, sans-serif; background: #f5f7fa; }
        #app { padding: 20px; }
        .header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .header h1 { font-size: 24px; margin: 0; }
        .api-status { font-size: 14px; }
        .api-status .online { color: #67C23A; }
        .api-status .offline { color: #F56C6C; }
        
        .card { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 12px rgba(0,0,0,0.1); }
        .card h3 { margin-bottom: 15px; color: #303133; border-bottom: 2px solid #409EFF; padding-bottom: 10px; }
        
        .menu-item { 
            display: inline-block; width: 200px; margin: 10px; 
            border: 1px solid #EBEEF5; border-radius: 8px; overflow: hidden;
            vertical-align: top; transition: all 0.3s;
        }
        .menu-item:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.15); transform: translateY(-2px); }
        .menu-item img { width: 100%; height: 120px; object-fit: cover; }
        .menu-item-info { padding: 10px; }
        .menu-item-name { font-weight: bold; margin-bottom: 5px; }
        .menu-item-price { color: #F56C6C; font-size: 18px; font-weight: bold; }
        .menu-item-desc { font-size: 12px; color: #909399; margin-top: 5px; }
        
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #EBEEF5; }
        .cart-item:last-child { border-bottom: none; }
        
        .order-status { padding: 4px 12px; border-radius: 20px; font-size: 12px; }
        .status-pending { background: #FDF6EC; color: #E6A23C; }
        .status-confirmed { background: #ECF5FF; color: #409EFF; }
        .status-preparing { background: #F0F9FF; color: #67C23A; }
        .status-ready { background: #F4F4F5; color: #909399; }
        .status-serving { background: #FEF0F0; color: #F56C6C; }
        .status-completed { background: #F0F9EB; color: #67C23A; }
        .status-cancelled { background: #FEF0F0; color: #909399; }
        
        .receipt {
            background: white; padding: 20px; font-family: monospace;
            border: 1px dashed #DCDFE6; max-width: 320px; margin: 0 auto;
        }
        .receipt h2 { text-align: center; margin-bottom: 10px; }
        .receipt-line { display: flex; justify-content: space-between; padding: 5px 0; }
        .receipt-divider { border-top: 1px dashed #DCDFE6; margin: 10px 0; }
        .receipt-total { font-weight: bold; font-size: 18px; }
        
        .kitchen-item { padding: 15px; margin: 10px 0; border: 1px solid #EBEEF5; border-radius: 8px; }
        .kitchen-item.cooking { border-left: 4px solid #E6A23C; }
        .kitchen-item.ready { border-left: 4px solid #67C23A; }
        
        .table-selector { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
        .table-card { 
            padding: 15px; text-align: center; border: 2px solid #DCDFE6; 
            border-radius: 10px; cursor: pointer; transition: all 0.3s;
        }
        .table-card:hover { border-color: #409EFF; }
        .table-card.selected { border-color: #409EFF; background: #ECF5FF; }
        .table-card.occupied { border-color: #F56C6C; background: #FEF0F0; }
        
        .step-indicator { display: flex; justify-content: space-between; margin: 20px 0; }
        .step { 
            flex: 1; text-align: center; padding: 10px; 
            border-bottom: 3px solid #DCDFE6; color: #909399;
        }
        .step.active { border-color: #409EFF; color: #409EFF; font-weight: bold; }
        .step.completed { border-color: #67C23A; color: #67C23A; }
        
        .tag-row { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
        
        .serving-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px; margin: 5px 0; background: #F5F7FA; border-radius: 5px;
        }
        .serving-item.served { opacity: 0.5; text-decoration: line-through; }
        
        .print-preview { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: flex; justify-content: center; 
            align-items: center; z-index: 1000;
        }
        .print-modal { background: white; padding: 20px; border-radius: 10px; max-width: 400px; }
        
        @media print {
            body * { visibility: hidden; }
            .print-content, .print-content * { visibility: visible; }
            .print-content { position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="header">
            <h1>ğŸ½ï¸ å¤šåº—é“ºæ‰«ç ç‚¹é¤ç³»ç»Ÿ - å®Œæ•´æµ‹è¯•å¹³å°</h1>
            <div class="api-status">
                APIçŠ¶æ€: <span :class="apiConnected ? 'online' : 'offline'">{{ apiConnected ? 'â— åœ¨çº¿' : 'â— ç¦»çº¿' }}</span>
                <span style="margin-left: 20px;">å½“å‰åº—é“º: {{ currentStore ? currentStore.name : 'æœªé€‰æ‹©' }}</span>
            </div>
        </div>

        <el-tabs v-model="activeTab" type="border-card" @tab-change="handleTabChange">
            <!-- é¡¾å®¢ç«¯ - æ‰«ç ç‚¹é¤ -->
            <el-tab-pane label="ğŸ“± é¡¾å®¢ç«¯" name="customer">
                <div class="card">
                    <h3>é€‰æ‹©æ¡Œå·</h3>
                    <div class="table-selector">
                        <div v-for="table in tables" :key="table.id" 
                             class="table-card" 
                             :class="{ selected: selectedTable && selectedTable.id === table.id, occupied: table.is_occupied }"
                             @click="selectTable(table)">
                            <div style="font-size: 24px;">{{ table.table_number }}</div>
                            <div style="font-size: 12px;">{{ table.seats }}äººæ¡Œ</div>
                            <div v-if="table.is_occupied" style="color: #F56C6C; font-size: 12px;">å·²å ç”¨</div>
                        </div>
                    </div>
                </div>

                <div v-if="selectedTable" class="card">
                    <div class="step-indicator">
                        <div class="step" :class="{ active: currentStep === 1, completed: currentStep > 1 }">1. é€‰èœ</div>
                        <div class="step" :class="{ active: currentStep === 2, completed: currentStep > 2 }">2. è´­ç‰©è½¦</div>
                        <div class="step" :class="{ active: currentStep === 3, completed: currentStep > 3 }">3. æ”¯ä»˜</div>
                    </div>

                    <!-- æ­¥éª¤1: é€‰èœ -->
                    <div v-if="currentStep === 1">
                        <div style="margin-bottom: 15px;">
                            <el-radio-group v-model="selectedCategory">
                                <el-radio-button label="">å…¨éƒ¨</el-radio-button>
                                <el-radio-button v-for="cat in categories" :key="cat.id" :label="cat.id">
                                    {{ cat.name }}
                                </el-radio-button>
                            </el-radio-group>
                        </div>
                        
                        <div v-for="item in filteredMenuItems" :key="item.id" class="menu-item">
                            <img :src="item.image_url || 'https://via.placeholder.com/200x120?text=èœå“å›¾ç‰‡'" :alt="item.name">
                            <div class="menu-item-info">
                                <div class="menu-item-name">{{ item.name }}</div>
                                <div class="menu-item-price">Â¥{{ item.price.toFixed(2) }}</div>
                                <div class="menu-item-desc">{{ item.description }}</div>
                                <div class="tag-row">
                                    <el-tag v-if="item.is_recommended" type="danger" size="small">æ¨è</el-tag>
                                    <el-tag type="info" size="small">åº“å­˜: {{ item.stock }}</el-tag>
                                    <el-tag type="success" size="small">å·²å”®: {{ item.sales_count }}</el-tag>
                                </div>
                                <div style="margin-top: 10px;">
                                    <el-button type="primary" size="small" @click="addToCart(item)" :disabled="item.stock <= 0">
                                        {{ item.stock > 0 ? 'åŠ å…¥è´­ç‰©è½¦' : 'å·²å”®ç½„' }}
                                    </el-button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æ­¥éª¤2: è´­ç‰©è½¦ -->
                    <div v-if="currentStep === 2">
                        <div v-if="cart.length === 0" style="text-align: center; padding: 40px; color: #909399;">
                            è´­ç‰©è½¦æ˜¯ç©ºçš„ï¼Œå»é€‰èœå§ï¼
                        </div>
                        <div v-else>
                            <div v-for="(item, index) in cart" :key="index" class="cart-item">
                                <div>
                                    <div style="font-weight: bold;">{{ item.name }}</div>
                                    <div style="color: #F56C6C;">Â¥{{ item.price.toFixed(2) }}</div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <el-button size="small" @click="updateCartQuantity(index, item.quantity - 1)">-</el-button>
                                    <span>{{ item.quantity }}</span>
                                    <el-button size="small" @click="updateCartQuantity(index, item.quantity + 1)">+</el-button>
                                </div>
                            </div>
                            <el-divider></el-divider>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
                                <div style="font-size: 18px; font-weight: bold;">
                                    æ€»è®¡: Â¥{{ cartTotal.toFixed(2) }}
                                </div>
                                <div>
                                    <el-button @click="currentStep = 1">è¿”å›é€‰èœ</el-button>
                                    <el-button type="primary" @click="currentStep = 3">å»ç»“ç®—</el-button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æ­¥éª¤3: æ”¯ä»˜ -->
                    <div v-if="currentStep === 3">
                        <div style="text-align: center; padding: 20px;">
                            <h2>è®¢å•ç¡®è®¤</h2>
                            <p>æ¡Œå·: {{ selectedTable.table_number }}</p>
                            <div style="font-size: 24px; color: #F56C6C; font-weight: bold; margin: 20px 0;">
                                åº”ä»˜é‡‘é¢: Â¥{{ cartTotal.toFixed(2) }}
                            </div>
                            <p>è®¢å•æ˜ç»†:</p>
                            <div v-for="(item, index) in cart" :key="index" style="padding: 10px 0; border-bottom: 1px solid #EBEEF5;">
                                {{ item.name }} x {{ item.quantity }} = Â¥{{ (item.price * item.quantity).toFixed(2) }}
                            </div>
                        </div>
                        <div style="margin-top: 20px;">
                            <el-form label-position="top">
                                <el-form-item label="é€‰æ‹©æ”¯ä»˜æ–¹å¼">
                                    <el-radio-group v-model="paymentMethod">
                                        <el-radio label="wechat">
                                            <el-icon><span style="color: #09BB07;">ğŸ’š</span></el-icon>
                                            å¾®ä¿¡æ”¯ä»˜
                                        </el-radio>
                                        <el-radio label="alipay">
                                            <el-icon><span style="color: #1677FF;">ğŸ’™</span></el-icon>
                                            æ”¯ä»˜å®
                                        </el-radio>
                                        <el-radio label="credit_card">
                                            <el-icon><span style="color: #F56C6C;">â¤ï¸</span></el-icon>
                                            ä¿¡ç”¨å¡
                                        </el-radio>
                                        <el-radio label="debit_card">
                                            <el-icon><span style="color: #E6A23C;">ğŸ§¡</span></el-icon>
                                            å€Ÿè®°å¡
                                        </el-radio>
                                        <el-radio label="cash">
                                            <el-icon><span style="color: #67C23A;">ğŸ’µ</span></el-icon>
                                            ç°é‡‘
                                        </el-radio>
                                    </el-radio-group>
                                </el-form-item>
                                <el-form-item label="ä¼šå‘˜æ‰‹æœºå·ï¼ˆå¯é€‰ï¼Œç§¯åˆ†ç´¯è®¡ï¼‰">
                                    <el-input v-model="memberPhone" placeholder="è¯·è¾“å…¥ä¼šå‘˜æ‰‹æœºå·"></el-input>
                                </el-form-item>
                            </el-form>
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <el-button @click="currentStep = 2" style="flex: 1;">è¿”å›è´­ç‰©è½¦</el-button>
                                <el-button type="primary" @click="submitOrder" style="flex: 2;" :loading="submitting">
                                    ç¡®è®¤æ”¯ä»˜å¹¶ä¸‹å•
                                </el-button>
                            </div>
                        </div>
                    </div>
                </div>
            </el-tab-pane>

            <!-- è®¢å•ç®¡ç† -->
            <el-tab-pane label="ğŸ“‹ è®¢å•ç®¡ç†" name="orders">
                <div class="card">
                    <h3>è®¢å•åˆ—è¡¨</h3>
                    <div style="margin-bottom: 15px; display: flex; gap: 10px;">
                        <el-select v-model="orderFilterStatus" placeholder="è®¢å•çŠ¶æ€" @change="filterOrders">
                            <el-option label="å…¨éƒ¨" value=""></el-option>
                            <el-option label="å¾…ç¡®è®¤" value="pending"></el-option>
                            <el-option label="å·²ç¡®è®¤" value="confirmed"></el-option>
                            <el-option label="åˆ¶ä½œä¸­" value="preparing"></el-option>
                            <el-option label="å¾…ä¼ èœ" value="ready"></el-option>
                            <el-option label="ä¸Šèœä¸­" value="serving"></el-option>
                            <el-option label="å·²å®Œæˆ" value="completed"></el-option>
                            <el-option label="å·²å–æ¶ˆ" value="cancelled"></el-option>
                        </el-select>
                        <el-select v-model="orderFilterTable" placeholder="æ¡Œå·" @change="filterOrders">
                            <el-option label="å…¨éƒ¨" value=""></el-option>
                            <el-option v-for="table in tables" :key="table.id" 
                                       :label="table.table_number" :value="table.id"></el-option>
                        </el-select>
                        <el-button type="primary" @click="refreshOrders">åˆ·æ–°</el-button>
                    </div>
                    
                    <div v-if="filteredOrders.length === 0" style="text-align: center; padding: 40px; color: #909399;">
                        æš‚æ— è®¢å•
                    </div>
                    
                    <el-table v-else :data="filteredOrders" style="width: 100%">
                        <el-table-column prop="id" label="è®¢å•å·" width="80"></el-table-column>
                        <el-table-column prop="table_number" label="æ¡Œå·" width="80"></el-table-column>
                        <el-table-column prop="total_amount" label="é‡‘é¢" width="100">
                            <template #default="scope">Â¥{{ scope.row.total_amount.toFixed(2) }}</template>
                        </el-table-column>
                        <el-table-column prop="status" label="çŠ¶æ€" width="100">
                            <template #default="scope">
                                <span class="order-status" :class="'status-' + scope.row.status">
                                    {{ getStatusText(scope.row.status) }}
                                </span>
                            </template>
                        </el-table-column>
                        <el-table-column prop="payment_method" label="æ”¯ä»˜æ–¹å¼" width="100">
                            <template #default="scope">{{ getPaymentMethodText(scope.row.payment_method) }}</template>
                        </el-table-column>
                        <el-table-column prop="created_at" label="ä¸‹å•æ—¶é—´" width="180"></el-table-column>
                        <el-table-column label="æ“ä½œ" fixed="right" width="200">
                            <template #default="scope">
                                <el-button size="small" @click="viewOrderDetail(scope.row)">è¯¦æƒ…</el-button>
                                <el-button size="small" type="primary" @click="printReceipt(scope.row)">æ‰“å°</el-button>
                            </template>
                        </el-table-column>
                    </el-table>
                </div>

                <!-- è®¢å•è¯¦æƒ…å¼¹çª— -->
                <el-dialog v-model="orderDetailVisible" title="è®¢å•è¯¦æƒ…" width="800px">
                    <div v-if="selectedOrder">
                        <el-descriptions :column="2" border>
                            <el-descriptions-item label="è®¢å•å·">{{ selectedOrder.id }}</el-descriptions-item>
                            <el-descriptions-item label="æ¡Œå·">{{ selectedOrder.table_number }}</el-descriptions-item>
                            <el-descriptions-item label="é‡‘é¢">Â¥{{ selectedOrder.total_amount.toFixed(2) }}</el-descriptions-item>
                            <el-descriptions-item label="çŠ¶æ€">
                                <span class="order-status" :class="'status-' + selectedOrder.status">
                                    {{ getStatusText(selectedOrder.status) }}
                                </span>
                            </el-descriptions-item>
                            <el-descriptions-item label="æ”¯ä»˜æ–¹å¼">{{ getPaymentMethodText(selectedOrder.payment_method) }}</el-descriptions-item>
                            <el-descriptions-item label="ä¸‹å•æ—¶é—´">{{ selectedOrder.created_at }}</el-descriptions-item>
                        </el-descriptions>
                        
                        <el-divider></el-divider>
                        
                        <h4>è®¢å•æ˜ç»†</h4>
                        <el-table :data="selectedOrder.items" style="width: 100%">
                            <el-table-column prop="menu_item_name" label="èœå“åç§°"></el-table-column>
                            <el-table-column prop="quantity" label="æ•°é‡" width="80"></el-table-column>
                            <el-table-column prop="price" label="å•ä»·" width="100">
                                <template #default="scope">Â¥{{ scope.row.price.toFixed(2) }}</template>
                            </el-table-column>
                            <el-table-column label="å°è®¡" width="100">
                                <template #default="scope">Â¥{{ (scope.row.price * scope.row.quantity).toFixed(2) }}</template>
                            </el-table-column>
                            <el-table-column prop="item_status" label="çŠ¶æ€" width="100">
                                <template #default="scope">
                                    <span class="order-status" :class="'status-' + scope.row.item_status">
                                        {{ getItemStatusText(scope.row.item_status) }}
                                    </span>
                                </template>
                            </el-table-column>
                        </el-table>

                        <el-divider></el-divider>

                        <div style="text-align: center;">
                            <el-button @click="updateOrderStatus(selectedOrder.id, 'confirmed')" 
                                       :disabled="!canUpdateStatus(selectedOrder.status, 'confirmed')">
                                ç¡®è®¤è®¢å•
                            </el-button>
                            <el-button type="warning" @click="updateOrderStatus(selectedOrder.id, 'preparing')"
                                       :disabled="!canUpdateStatus(selectedOrder.status, 'preparing')">
                                å¼€å§‹åˆ¶ä½œ
                            </el-button>
                            <el-button type="success" @click="updateOrderStatus(selectedOrder.id, 'ready')"
                                       :disabled="!canUpdateStatus(selectedOrder.status, 'ready')">
                                åˆ¶ä½œå®Œæˆ
                            </el-button>
                            <el-button type="primary" @click="updateOrderStatus(selectedOrder.id, 'serving')"
                                       :disabled="!canUpdateStatus(selectedOrder.status, 'serving')">
                                å¼€å§‹ä¼ èœ
                            </el-button>
                            <el-button type="success" @click="updateOrderStatus(selectedOrder.id, 'completed')"
                                       :disabled="!canUpdateStatus(selectedOrder.status, 'completed')">
                                å®Œæˆè®¢å•
                            </el-button>
                            <el-button type="danger" @click="updateOrderStatus(selectedOrder.id, 'cancelled')"
                                       :disabled="!canUpdateStatus(selectedOrder.status, 'cancelled')">
                                å–æ¶ˆè®¢å•
                            </el-button>
                        </div>
                    </div>
                </el-dialog>

                <!-- å°ç¥¨æ‰“å°é¢„è§ˆ -->
                <el-dialog v-model="receiptVisible" title="å°ç¥¨æ‰“å°é¢„è§ˆ" width="400px">
                    <div class="receipt print-content" v-if="selectedOrder">
                        <h2>{{ storeName }}</h2>
                        <p>åœ°å€: {{ storeAddress }}</p>
                        <p>ç”µè¯: {{ storePhone }}</p>
                        <div class="receipt-divider"></div>
                        <div class="receipt-line">
                            <span>è®¢å•å·: {{ selectedOrder.id }}</span>
                        </div>
                        <div class="receipt-line">
                            <span>æ¡Œå·: {{ selectedOrder.table_number }}</span>
                            <span>æ—¶é—´: {{ formatDateTime(selectedOrder.created_at) }}</span>
                        </div>
                        <div class="receipt-line">
                            <span>æ”¯ä»˜: {{ getPaymentMethodText(selectedOrder.payment_method) }}</span>
                        </div>
                        <div class="receipt-divider"></div>
                        <div v-for="item in selectedOrder.items" :key="item.id">
                            <div class="receipt-line">
                                <span>{{ item.menu_item_name }}</span>
                                <span>x{{ item.quantity }}</span>
                            </div>
                            <div class="receipt-line" style="padding-left: 20px;">
                                <span>Â¥{{ item.price.toFixed(2) }}</span>
                                <span>Â¥{{ (item.price * item.quantity).toFixed(2) }}</span>
                            </div>
                        </div>
                        <div class="receipt-divider"></div>
                        <div class="receipt-line receipt-total">
                            <span>æ€»è®¡:</span>
                            <span>Â¥{{ selectedOrder.total_amount.toFixed(2) }}</span>
                        </div>
                        <div class="receipt-divider"></div>
                        <p style="text-align: center;">æ„Ÿè°¢å…‰ä¸´ï¼Œæ¬¢è¿ä¸‹æ¬¡å†æ¥ï¼</p>
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <el-button @click="receiptVisible = false">å–æ¶ˆ</el-button>
                        <el-button type="primary" @click="printReceiptConfirm">æ‰“å°</el-button>
                    </div>
                </el-dialog>
            </el-tab-pane>

            <!-- å¨æˆ¿åˆ¶ä½œ -->
            <el-tab-pane label="ğŸ‘¨â€ğŸ³ å¨æˆ¿åˆ¶ä½œ" name="kitchen">
                <div class="card">
                    <h3>å¾…åˆ¶ä½œè®¢å•</h3>
                    <div style="margin-bottom: 15px;">
                        <el-button type="primary" @click="refreshKitchenOrders">åˆ·æ–°è®¢å•</el-button>
                    </div>
                    
                    <div v-if="kitchenOrders.length === 0" style="text-align: center; padding: 40px; color: #909399;">
                        æš‚æ— å¾…åˆ¶ä½œè®¢å•
                    </div>
                    
                    <div v-for="order in kitchenOrders" :key="order.id" class="kitchen-item" 
                         :class="{ cooking: order.status === 'preparing', ready: order.status === 'ready' }">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div>
                                <strong style="font-size: 18px;">è®¢å• #{{ order.id }}</strong>
                                <span style="margin-left: 10px;">æ¡Œå·: {{ order.table_number }}</span>
                                <span style="margin-left: 10px;">æ—¶é—´: {{ formatTime(order.created_at) }}</span>
                            </div>
                            <span class="order-status" :class="'status-' + order.status">
                                {{ getStatusText(order.status) }}
                            </span>
                        </div>
                        
                        <el-table :data="order.items" style="width: 100%">
                            <el-table-column prop="menu_item_name" label="èœå“åç§°"></el-table-column>
                            <el-table-column prop="quantity" label="æ•°é‡" width="80"></el-table-column>
                            <el-table-column prop="item_status" label="çŠ¶æ€" width="100">
                                <template #default="scope">
                                    <span class="order-status" :class="'status-' + scope.row.item_status">
                                        {{ getItemStatusText(scope.row.item_status) }}
                                    </span>
                                </template>
                            </el-table-column>
                            <el-table-column label="æ“ä½œ" width="200">
                                <template #default="scope">
                                    <el-button size="small" type="primary" 
                                               @click="updateItemStatus(order.id, scope.row.id, 'preparing')"
                                               :disabled="!canUpdateItemStatus(scope.row.item_status, 'preparing')">
                                        å¼€å§‹åˆ¶ä½œ
                                    </el-button>
                                    <el-button size="small" type="success"
                                               @click="updateItemStatus(order.id, scope.row.id, 'ready')"
                                               :disabled="!canUpdateItemStatus(scope.row.item_status, 'ready')">
                                        åˆ¶ä½œå®Œæˆ
                                    </el-button>
                                </template>
                            </el-table-column>
                        </el-table>
                        
                        <div style="margin-top: 10px; text-align: right;">
                            <el-button @click="printKitchenReceipt(order)">æ‰“å°åˆ¶ä½œå•</el-button>
                        </div>
                    </div>
                </div>
            </el-tab-pane>

            <!-- ä¼ èœç®¡ç† -->
            <el-tab-pane label="ğŸ½ï¸ ä¼ èœç®¡ç†" name="serving">
                <div class="card">
                    <h3>å¾…ä¼ èœè®¢å•</h3>
                    <div style="margin-bottom: 15px;">
                        <el-button type="primary" @click="refreshServingOrders">åˆ·æ–°è®¢å•</el-button>
                    </div>
                    
                    <div v-if="servingOrders.length === 0" style="text-align: center; padding: 40px; color: #909399;">
                        æš‚æ— å¾…ä¼ èœè®¢å•
                    </div>
                    
                    <div v-for="order in servingOrders" :key="order.id" style="margin-bottom: 20px;">
                        <div style="background: white; padding: 20px; border-radius: 10px; border: 1px solid #EBEEF5;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div>
                                    <strong style="font-size: 18px;">è®¢å• #{{ order.id }}</strong>
                                    <span style="margin-left: 10px;">æ¡Œå·: {{ order.table_number }}</span>
                                    <span style="margin-left: 10px;">æ—¶é—´: {{ formatTime(order.created_at) }}</span>
                                </div>
                                <el-button type="primary" @click="printServingReceipt(order)">æ‰“å°ä¼ èœå•</el-button>
                            </div>
                            
                            <h4>å¾…ä¸Šèœå“ (è¯·é€ä¸€ç¡®è®¤ä¸Šèœ)</h4>
                            <div v-for="item in order.items" :key="item.id" class="serving-item"
                                 :class="{ served: item.item_status === 'served' }">
                                <div>
                                    <strong>{{ item.menu_item_name }}</strong>
                                    <span style="margin-left: 10px;">x{{ item.quantity }}</span>
                                </div>
                                <el-button type="success" size="small"
                                           @click="confirmServeItem(order.id, item.id)"
                                           :disabled="item.item_status === 'served'">
                                    {{ item.item_status === 'served' ? 'å·²ä¸Šèœ' : 'ç¡®è®¤ä¸Šèœ' }}
                                </el-button>
                            </div>
                            
                            <el-divider></el-divider>
                            
                            <div style="text-align: center;">
                                <el-button type="success" @click="confirmAllServed(order.id)"
                                           :disabled="!allItemsServed(order.items)">
                                    å…¨éƒ¨ä¸Šèœå®Œæˆ
                                </el-button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ä¼ èœå•æ‰“å°é¢„è§ˆ -->
                <el-dialog v-model="servingReceiptVisible" title="ä¼ èœå•æ‰“å°é¢„è§ˆ" width="400px">
                    <div class="receipt print-content" v-if="selectedServingOrder">
                        <h2>ä¼ èœå•</h2>
                        <p>æ¡Œå·: {{ selectedServingOrder.table_number }}</p>
                        <p>è®¢å•å·: {{ selectedServingOrder.id }}</p>
                        <div class="receipt-divider"></div>
                        <h4>å¾…ä¼ èœå“:</h4>
                        <div v-for="item in selectedServingOrder.items" :key="item.id"
                             :class="{ served: item.item_status === 'served' }">
                            <div class="receipt-line">
                                <span>{{ item.menu_item_name }}</span>
                                <span>x{{ item.quantity }}</span>
                            </div>
                        </div>
                        <div class="receipt-divider"></div>
                        <p style="text-align: center;">è¯·æœåŠ¡å‘˜é€ä¸€ç¡®è®¤ä¸Šèœ</p>
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <el-button @click="servingReceiptVisible = false">å–æ¶ˆ</el-button>
                        <el-button type="primary" @click="printServingReceiptConfirm">æ‰“å°</el-button>
                    </div>
                </el-dialog>
            </el-tab-pane>

            <!-- èœå“ç®¡ç† -->
            <el-tab-pane label="ğŸ² èœå“ç®¡ç†" name="menu">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3>èœå“åˆ—è¡¨</h3>
                        <el-button type="primary" @click="showAddMenuItemDialog">æ·»åŠ èœå“</el-button>
                    </div>
                    
                    <el-table :data="menuItems" style="width: 100%">
                        <el-table-column prop="name" label="èœå“åç§°"></el-table-column>
                        <el-table-column prop="category_name" label="åˆ†ç±»"></el-table-column>
                        <el-table-column prop="price" label="ä»·æ ¼">
                            <template #default="scope">Â¥{{ scope.row.price.toFixed(2) }}</template>
                        </el-table-column>
                        <el-table-column prop="stock" label="åº“å­˜" width="80"></el-table-column>
                        <el-table-column prop="sales_count" label="é”€é‡" width="80"></el-table-column>
                        <el-table-column label="çŠ¶æ€" width="100">
                            <template #default="scope">
                                <el-tag :type="scope.row.is_available ? 'success' : 'danger'">
                                    {{ scope.row.is_available ? 'ä¸Šæ¶' : 'ä¸‹æ¶' }}
                                </el-tag>
                            </template>
                        </el-table-column>
                        <el-table-column label="æ“ä½œ" width="150">
                            <template #default="scope">
                                <el-button size="small" @click="editMenuItem(scope.row)">ç¼–è¾‘</el-button>
                                <el-button size="small" type="danger" @click="deleteMenuItem(scope.row.id)">åˆ é™¤</el-button>
                            </template>
                        </el-table-column>
                    </el-table>
                </div>

                <!-- æ·»åŠ /ç¼–è¾‘èœå“å¼¹çª— -->
                <el-dialog v-model="menuItemDialogVisible" :title="editingMenuItem ? 'ç¼–è¾‘èœå“' : 'æ·»åŠ èœå“'" width="600px">
                    <el-form :model="menuItemForm" label-width="100px">
                        <el-form-item label="èœå“åç§°">
                            <el-input v-model="menuItemForm.name"></el-input>
                        </el-form-item>
                        <el-form-item label="åˆ†ç±»">
                            <el-select v-model="menuItemForm.category_id">
                                <el-option v-for="cat in categories" :key="cat.id"
                                           :label="cat.name" :value="cat.id"></el-option>
                            </el-select>
                        </el-form-item>
                        <el-form-item label="ä»·æ ¼">
                            <el-input-number v-model="menuItemForm.price" :min="0" :precision="2"></el-input-number>
                        </el-form-item>
                        <el-form-item label="åº“å­˜">
                            <el-input-number v-model="menuItemForm.stock" :min="0"></el-input-number>
                        </el-form-item>
                        <el-form-item label="æè¿°">
                            <el-input type="textarea" v-model="menuItemForm.description" rows="3"></el-input>
                        </el-form-item>
                        <el-form-item label="å›¾ç‰‡URL">
                            <el-input v-model="menuItemForm.image_url"></el-input>
                        </el-form-item>
                        <el-form-item label="æ˜¯å¦æ¨è">
                            <el-switch v-model="menuItemForm.is_recommended"></el-switch>
                        </el-form-item>
                        <el-form-item label="æ˜¯å¦ä¸Šæ¶">
                            <el-switch v-model="menuItemForm.is_available"></el-switch>
                        </el-form-item>
                    </el-form>
                    <template #footer>
                        <el-button @click="menuItemDialogVisible = false">å–æ¶ˆ</el-button>
                        <el-button type="primary" @click="saveMenuItem">ä¿å­˜</el-button>
                    </template>
                </el-dialog>
            </el-tab-pane>

            <!-- æ¡Œå·ç®¡ç† -->
            <el-tab-pane label="ğŸª‘ æ¡Œå·ç®¡ç†" name="tables">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3>æ¡Œå·åˆ—è¡¨</h3>
                        <el-button type="primary" @click="showAddTableDialog">æ·»åŠ æ¡Œå·</el-button>
                    </div>
                    
                    <el-table :data="tables" style="width: 100%">
                        <el-table-column prop="table_number" label="æ¡Œå·"></el-table-column>
                        <el-table-column prop="seats" label="åº§ä½æ•°"></el-table-column>
                        <el-table-column label="çŠ¶æ€" width="100">
                            <template #default="scope">
                                <el-tag :type="scope.row.is_occupied ? 'danger' : 'success'">
                                    {{ scope.row.is_occupied ? 'å ç”¨' : 'ç©ºé—²' }}
                                </el-tag>
                            </template>
                        </el-table-column>
                        <el-table-column label="æ“ä½œ" width="150">
                            <template #default="scope">
                                <el-button size="small" @click="editTable(scope.row)">ç¼–è¾‘</el-button>
                                <el-button size="small" type="primary" @click="generateQRCode(scope.row)">ç”ŸæˆäºŒç»´ç </el-button>
                                <el-button size="small" type="danger" @click="deleteTable(scope.row.id)">åˆ é™¤</el-button>
                            </template>
                        </el-table-column>
                    </el-table>
                </div>

                <!-- æ·»åŠ /ç¼–è¾‘æ¡Œå·å¼¹çª— -->
                <el-dialog v-model="tableDialogVisible" :title="editingTable ? 'ç¼–è¾‘æ¡Œå·' : 'æ·»åŠ æ¡Œå·'" width="500px">
                    <el-form :model="tableForm" label-width="100px">
                        <el-form-item label="æ¡Œå·">
                            <el-input v-model="tableForm.table_number"></el-input>
                        </el-form-item>
                        <el-form-item label="åº§ä½æ•°">
                            <el-input-number v-model="tableForm.seats" :min="1"></el-input-number>
                        </el-form-item>
                        <el-form-item label="æ˜¯å¦å¯ç”¨">
                            <el-switch v-model="tableForm.is_active"></el-switch>
                        </el-form-item>
                    </el-form>
                    <template #footer>
                        <el-button @click="tableDialogVisible = false">å–æ¶ˆ</el-button>
                        <el-button type="primary" @click="saveTable">ä¿å­˜</el-button>
                    </template>
                </el-dialog>

                <!-- äºŒç»´ç é¢„è§ˆå¼¹çª— -->
                <el-dialog v-model="qrCodeVisible" title="æ¡Œå·äºŒç»´ç " width="400px">
                    <div style="text-align: center;">
                        <img :src="qrCodeUrl" style="max-width: 300px;">
                        <p style="margin-top: 10px;">æ¡Œå·: {{ qrCodeTable?.table_number }}</p>
                        <p>å®¢äººæ‰«ç åå¯ç›´æ¥ç‚¹é¤</p>
                    </div>
                    <template #footer>
                        <el-button @click="qrCodeVisible = false">å…³é—­</el-button>
                    </template>
                </el-dialog>
            </el-tab-pane>

            <!-- ç³»ç»Ÿè®¾ç½® -->
            <el-tab-pane label="âš™ï¸ ç³»ç»Ÿè®¾ç½®" name="settings">
                <div class="card">
                    <h3>åº—é“ºä¿¡æ¯</h3>
                    <el-form label-width="120px" style="max-width: 600px;">
                        <el-form-item label="åº—é“ºåç§°">
                            <el-input v-model="storeSettings.name"></el-input>
                        </el-form-item>
                        <el-form-item label="åº—é“ºåœ°å€">
                            <el-input v-model="storeSettings.address"></el-input>
                        </el-form-item>
                        <el-form-item label="è”ç³»ç”µè¯">
                            <el-input v-model="storeSettings.phone"></el-input>
                        </el-form-item>
                        <el-form-item label="APIåœ°å€">
                            <el-input v-model="apiBaseUrl"></el-input>
                        </el-form-item>
                        <el-form-item>
                            <el-button type="primary" @click="saveStoreSettings">ä¿å­˜è®¾ç½®</el-button>
                        </el-form-item>
                    </el-form>
                </div>
            </el-tab-pane>
        </el-tabs>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, reactive } = Vue;

        const app = createApp({
            setup() {
                // å…¨å±€çŠ¶æ€
                const activeTab = ref('customer');
                const apiBaseUrl = ref('');
                const apiConnected = ref(true);
                const currentStore = ref(null);
                
                // åº—é“ºä¿¡æ¯
                const storeName = ref('ç¾å‘³é¤å…');
                const storeAddress = ref('åŒ—äº¬å¸‚æœé˜³åŒºxxxè·¯xxxå·');
                const storePhone = ref('010-12345678');
                
                const storeSettings = reactive({
                    name: storeName.value,
                    address: storeAddress.value,
                    phone: storePhone.value
                });

                // é¡¾å®¢ç«¯ç›¸å…³
                const tables = ref([]);
                const selectedTable = ref(null);
                const categories = ref([]);
                const menuItems = ref([]);
                const selectedCategory = ref('');
                const cart = ref([]);
                const currentStep = ref(1);
                const paymentMethod = ref('wechat');
                const memberPhone = ref('');
                const submitting = ref(false);

                // è®¢å•ç›¸å…³
                const orders = ref([]);
                const filteredOrders = ref([]);
                const orderFilterStatus = ref('');
                const orderFilterTable = ref('');
                const orderDetailVisible = ref(false);
                const selectedOrder = ref(null);
                const receiptVisible = ref(false);

                // å¨æˆ¿ç›¸å…³
                const kitchenOrders = ref([]);

                // ä¼ èœç›¸å…³
                const servingOrders = ref([]);
                const servingReceiptVisible = ref(false);
                const selectedServingOrder = ref(null);

                // èœå“ç®¡ç†ç›¸å…³
                const menuItemDialogVisible = ref(false);
                const editingMenuItem = ref(null);
                const menuItemForm = reactive({
                    name: '',
                    category_id: null,
                    price: 0,
                    stock: 100,
                    description: '',
                    image_url: '',
                    is_recommended: false,
                    is_available: true
                });

                // æ¡Œå·ç®¡ç†ç›¸å…³
                const tableDialogVisible = ref(false);
                const editingTable = ref(null);
                const tableForm = reactive({
                    table_number: '',
                    seats: 4,
                    is_active: true
                });
                const qrCodeVisible = ref(false);
                const qrCodeUrl = ref('');
                const qrCodeTable = ref(null);

                // è®¡ç®—å±æ€§
                const filteredMenuItems = computed(() => {
                    if (!selectedCategory.value) return menuItems.value.filter(item => item.is_available);
                    return menuItems.value.filter(item => 
                        item.category_id === selectedCategory.value && item.is_available
                    );
                });

                const cartTotal = computed(() => {
                    return cart.value.reduce((sum, item) => sum + item.price * item.quantity, 0);
                });

                // APIè¯·æ±‚å‡½æ•°
                async function apiRequest(method, endpoint, data = null) {
                    try {
                        const config = {
                            method: method,
                            url: `${apiBaseUrl.value}${endpoint}`,
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        };
                        if (data) {
                            config.data = data;
                        }
                        const response = await axios(config);
                        apiConnected.value = true;
                        return response.data;
                    } catch (error) {
                        console.error('APIè¯·æ±‚å¤±è´¥:', error);
                        apiConnected.value = false;
                        throw error;
                    }
                }

                // åŠ è½½åˆå§‹æ•°æ®
                async function loadInitialData() {
                    try {
                        await Promise.all([
                            loadTables(),
                            loadCategories(),
                            loadMenuItems(),
                            loadOrders()
                        ]);
                    } catch (error) {
                        console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                    }
                }

                // åŠ è½½æ¡Œå·
                async function loadTables() {
                    try {
                        const response = await apiRequest('GET', '/api/tables/');
                        tables.value = response || [];
                        console.log('åŠ è½½æ¡Œå·æˆåŠŸ:', tables.value.length);
                    } catch (error) {
                        console.error('åŠ è½½æ¡Œå·å¤±è´¥:', error);
                        tables.value = [];
                    }
                }

                // åŠ è½½èœå“åˆ†ç±»
                async function loadCategories() {
                    try {
                        const response = await apiRequest('GET', '/api/menu-categories/');
                        categories.value = response || [];
                        console.log('åŠ è½½åˆ†ç±»æˆåŠŸ:', categories.value.length);
                    } catch (error) {
                        console.error('åŠ è½½åˆ†ç±»å¤±è´¥:', error);
                        categories.value = [];
                    }
                }

                // åŠ è½½èœå“
                async function loadMenuItems() {
                    try {
                        const response = await apiRequest('GET', '/api/menu-items/');
                        menuItems.value = response || [];
                        console.log('åŠ è½½èœå“æˆåŠŸ:', menuItems.value.length);
                    } catch (error) {
                        console.error('åŠ è½½èœå“å¤±è´¥:', error);
                        menuItems.value = [];
                    }
                }

                // åŠ è½½è®¢å•
                async function loadOrders() {
                    try {
                        const response = await apiRequest('GET', '/api/orders/');
                        orders.value = response || [];
                        filterOrders();
                        console.log('åŠ è½½è®¢å•æˆåŠŸ:', orders.value.length);
                    } catch (error) {
                        console.error('åŠ è½½è®¢å•å¤±è´¥:', error);
                        orders.value = [];
                    }
                }

                // ç­›é€‰è®¢å•
                function filterOrders() {
                    filteredOrders.value = orders.value.filter(order => {
                        if (orderFilterStatus.value && order.status !== orderFilterStatus.value) return false;
                        if (orderFilterTable.value && order.table_id !== orderFilterTable.value) return false;
                        return true;
                    });
                }

                // é€‰æ‹©æ¡Œå·
                function selectTable(table) {
                    if (table.is_occupied) {
                        ElementPlus.ElMessage.warning('è¯¥æ¡Œå·²è¢«å ç”¨');
                        return;
                    }
                    selectedTable.value = table;
                    currentStep.value = 1;
                    cart.value = [];
                }

                // æ·»åŠ åˆ°è´­ç‰©è½¦
                function addToCart(item) {
                    if (item.stock <= 0) return;
                    
                    const existingItem = cart.value.find(c => c.id === item.id);
                    if (existingItem) {
                        existingItem.quantity++;
                    } else {
                        cart.value.push({
                            id: item.id,
                            name: item.name,
                            price: item.price,
                            quantity: 1,
                            stock: item.stock
                        });
                    }
                    
                    ElementPlus.ElMessage.success(`${item.name} å·²åŠ å…¥è´­ç‰©è½¦`);
                }

                // æ›´æ–°è´­ç‰©è½¦æ•°é‡
                function updateCartQuantity(index, quantity) {
                    if (quantity <= 0) {
                        cart.value.splice(index, 1);
                    } else if (quantity <= cart.value[index].stock) {
                        cart.value[index].quantity = quantity;
                    } else {
                        ElementPlus.ElMessage.warning('åº“å­˜ä¸è¶³');
                    }
                }

                // æäº¤è®¢å•
                async function submitOrder() {
                    if (cart.value.length === 0) {
                        ElementPlus.ElMessage.warning('è¯·å…ˆé€‰æ‹©èœå“');
                        return;
                    }
                    
                    if (!paymentMethod.value) {
                        ElementPlus.ElMessage.warning('è¯·é€‰æ‹©æ”¯ä»˜æ–¹å¼');
                        return;
                    }

                    submitting.value = true;

                    try {
                        const orderData = {
                            table_id: selectedTable.value.id,
                            items: cart.value.map(item => ({
                                menu_item_id: item.id,
                                quantity: item.quantity
                            })),
                            payment_method: paymentMethod.value
                        };

                        // å¦‚æœæä¾›äº†ä¼šå‘˜æ‰‹æœºå·ï¼Œæ·»åŠ åˆ°è®¢å•å¤‡æ³¨
                        if (memberPhone.value) {
                            orderData.notes = `ä¼šå‘˜æ‰‹æœºå·: ${memberPhone.value}`;
                        }

                        const response = await apiRequest('POST', '/api/orders/', orderData);
                        
                        ElementPlus.ElMessage.success('è®¢å•æäº¤æˆåŠŸï¼');
                        ElementPlus.ElNotification({
                            title: 'è®¢å•è¯¦æƒ…',
                            message: `è®¢å•å·: ${response.id}, æ€»é‡‘é¢: Â¥${response.total_amount.toFixed(2)}`,
                            type: 'success',
                            duration: 5000
                        });

                        // é‡ç½®è´­ç‰©è½¦
                        cart.value = [];
                        currentStep.value = 1;
                        selectedTable.value = null;

                        // åˆ·æ–°è®¢å•åˆ—è¡¨
                        await loadOrders();

                    } catch (error) {
                        console.error('æäº¤è®¢å•å¤±è´¥:', error);
                        ElementPlus.ElMessage.error('æäº¤è®¢å•å¤±è´¥: ' + (error.response?.data?.detail || error.message));
                    } finally {
                        submitting.value = false;
                    }
                }

                // åˆ·æ–°è®¢å•
                function refreshOrders() {
                    loadOrders();
                    ElementPlus.ElMessage.success('è®¢å•å·²åˆ·æ–°');
                }

                // æŸ¥çœ‹è®¢å•è¯¦æƒ…
                function viewOrderDetail(order) {
                    selectedOrder.value = order;
                    orderDetailVisible.value = true;
                }

                // æ›´æ–°è®¢å•çŠ¶æ€
                async function updateOrderStatus(orderId, newStatus) {
                    try {
                        await apiRequest('PATCH', `/api/orders/${orderId}/status`, {
                            status: newStatus
                        });
                        ElementPlus.ElMessage.success('è®¢å•çŠ¶æ€æ›´æ–°æˆåŠŸ');
                        await loadOrders();
                        
                        if (selectedOrder.value && selectedOrder.value.id === orderId) {
                            selectedOrder.value.status = newStatus;
                            selectedOrder.value.items = selectedOrder.value.items.map(item => ({
                                ...item,
                                item_status: newStatus
                            }));
                        }
                    } catch (error) {
                        console.error('æ›´æ–°è®¢å•çŠ¶æ€å¤±è´¥:', error);
                        ElementPlus.ElMessage.error('æ›´æ–°è®¢å•çŠ¶æ€å¤±è´¥');
                    }
                }

                // æ£€æŸ¥æ˜¯å¦å¯ä»¥æ›´æ–°çŠ¶æ€
                function canUpdateStatus(currentStatus, newStatus) {
                    const statusFlow = {
                        pending: ['confirmed', 'cancelled'],
                        confirmed: ['preparing', 'cancelled'],
                        preparing: ['ready'],
                        ready: ['serving'],
                        serving: ['completed'],
                        completed: [],
                        cancelled: []
                    };
                    return statusFlow[currentStatus]?.includes(newStatus);
                }

                // æ‰“å°å°ç¥¨
                function printReceipt(order) {
                    selectedOrder.value = order;
                    receiptVisible.value = true;
                }

                function printReceiptConfirm() {
                    window.print();
                    receiptVisible.value = false;
                }

                // è·å–çŠ¶æ€æ–‡æœ¬
                function getStatusText(status) {
                    const statusMap = {
                        pending: 'å¾…ç¡®è®¤',
                        confirmed: 'å·²ç¡®è®¤',
                        preparing: 'åˆ¶ä½œä¸­',
                        ready: 'å¾…ä¼ èœ',
                        serving: 'ä¸Šèœä¸­',
                        completed: 'å·²å®Œæˆ',
                        cancelled: 'å·²å–æ¶ˆ'
                    };
                    return statusMap[status] || status;
                }

                function getItemStatusText(status) {
                    const statusMap = {
                        pending: 'å¾…åˆ¶ä½œ',
                        preparing: 'åˆ¶ä½œä¸­',
                        ready: 'å¾…ä¼ èœ',
                        served: 'å·²ä¸Šèœ'
                    };
                    return statusMap[status] || status;
                }

                function getPaymentMethodText(method) {
                    const methodMap = {
                        wechat: 'å¾®ä¿¡',
                        alipay: 'æ”¯ä»˜å®',
                        credit_card: 'ä¿¡ç”¨å¡',
                        debit_card: 'å€Ÿè®°å¡',
                        cash: 'ç°é‡‘'
                    };
                    return methodMap[method] || method;
                }

                function formatDateTime(dateStr) {
                    const date = new Date(dateStr);
                    return date.toLocaleString('zh-CN');
                }

                function formatTime(dateStr) {
                    const date = new Date(dateStr);
                    return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                }

                // å¨æˆ¿ç›¸å…³
                function refreshKitchenOrders() {
                    loadOrders();
                    kitchenOrders.value = orders.value.filter(order => 
                        ['confirmed', 'preparing', 'ready'].includes(order.status)
                    );
                    ElementPlus.ElMessage.success('å¨æˆ¿è®¢å•å·²åˆ·æ–°');
                }

                function updateItemStatus(orderId, itemId, newStatus) {
                    apiRequest('PATCH', `/api/orders/${orderId}/items/${itemId}/status`, {
                        item_status: newStatus
                    }).then(() => {
                        ElementPlus.ElMessage.success('èœå“çŠ¶æ€æ›´æ–°æˆåŠŸ');
                        loadOrders();
                        refreshKitchenOrders();
                    }).catch(error => {
                        console.error('æ›´æ–°èœå“çŠ¶æ€å¤±è´¥:', error);
                        ElementPlus.ElMessage.error('æ›´æ–°èœå“çŠ¶æ€å¤±è´¥');
                    });
                }

                function canUpdateItemStatus(currentStatus, newStatus) {
                    const statusFlow = {
                        pending: ['preparing'],
                        preparing: ['ready'],
                        ready: [],
                        served: []
                    };
                    return statusFlow[currentStatus]?.includes(newStatus);
                }

                function printKitchenReceipt(order) {
                    selectedOrder.value = order;
                    // å¯ä»¥æ‰“å¼€ä¸€ä¸ªå¼¹çª—æ˜¾ç¤ºå¨æˆ¿åˆ¶ä½œå•
                    ElementPlus.ElMessage.info('æ‰“å°å¨æˆ¿åˆ¶ä½œå• (è®¢å•å·: ' + order.id + ')');
                }

                // ä¼ èœç›¸å…³
                function refreshServingOrders() {
                    loadOrders();
                    servingOrders.value = orders.value.filter(order => 
                        order.status === 'serving' || order.status === 'ready'
                    );
                    ElementPlus.ElMessage.success('ä¼ èœè®¢å•å·²åˆ·æ–°');
                }

                function printServingReceipt(order) {
                    selectedServingOrder.value = order;
                    servingReceiptVisible.value = true;
                }

                function printServingReceiptConfirm() {
                    window.print();
                    servingReceiptVisible.value = false;
                }

                function confirmServeItem(orderId, itemId) {
                    apiRequest('PATCH', `/api/orders/${orderId}/items/${itemId}/status`, {
                        item_status: 'served'
                    }).then(() => {
                        ElementPlus.ElMessage.success('ç¡®è®¤ä¸ŠèœæˆåŠŸ');
                        loadOrders();
                        refreshServingOrders();
                    }).catch(error => {
                        console.error('ç¡®è®¤ä¸Šèœå¤±è´¥:', error);
                        ElementPlus.ElMessage.error('ç¡®è®¤ä¸Šèœå¤±è´¥');
                    });
                }

                function allItemsServed(items) {
                    return items.every(item => item.item_status === 'served');
                }

                function confirmAllServed(orderId) {
                    updateOrderStatus(orderId, 'completed');
                }

                // èœå“ç®¡ç†ç›¸å…³
                function showAddMenuItemDialog() {
                    editingMenuItem.value = null;
                    Object.assign(menuItemForm, {
                        name: '',
                        category_id: categories.value[0]?.id || null,
                        price: 0,
                        stock: 100,
                        description: '',
                        image_url: '',
                        is_recommended: false,
                        is_available: true
                    });
                    menuItemDialogVisible.value = true;
                }

                function editMenuItem(item) {
                    editingMenuItem.value = item;
                    Object.assign(menuItemForm, {
                        name: item.name,
                        category_id: item.category_id,
                        price: item.price,
                        stock: item.stock,
                        description: item.description,
                        image_url: item.image_url,
                        is_recommended: item.is_recommended,
                        is_available: item.is_available
                    });
                    menuItemDialogVisible.value = true;
                }

                async function saveMenuItem() {
                    try {
                        const data = { ...menuItemForm };
                        
                        if (editingMenuItem.value) {
                            await apiRequest('PATCH', `/api/menu-items/${editingMenuItem.value.id}`, data);
                            ElementPlus.ElMessage.success('èœå“æ›´æ–°æˆåŠŸ');
                        } else {
                            await apiRequest('POST', '/api/menu-items/', data);
                            ElementPlus.ElMessage.success('èœå“æ·»åŠ æˆåŠŸ');
                        }
                        
                        menuItemDialogVisible.value = false;
                        await loadMenuItems();
                    } catch (error) {
                        console.error('ä¿å­˜èœå“å¤±è´¥:', error);
                        ElementPlus.ElMessage.error('ä¿å­˜èœå“å¤±è´¥');
                    }
                }

                async function deleteMenuItem(itemId) {
                    try {
                        await ElementPlus.ElMessageBox.confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªèœå“å—ï¼Ÿ', 'ç¡®è®¤åˆ é™¤', {
                            type: 'warning'
                        });
                        
                        await apiRequest('DELETE', `/api/menu-items/${itemId}`);
                        ElementPlus.ElMessage.success('èœå“åˆ é™¤æˆåŠŸ');
                        await loadMenuItems();
                    } catch (error) {
                        if (error !== 'cancel') {
                            console.error('åˆ é™¤èœå“å¤±è´¥:', error);
                            ElementPlus.ElMessage.error('åˆ é™¤èœå“å¤±è´¥');
                        }
                    }
                }

                // æ¡Œå·ç®¡ç†ç›¸å…³
                function showAddTableDialog() {
                    editingTable.value = null;
                    Object.assign(tableForm, {
                        table_number: '',
                        seats: 4,
                        is_active: true
                    });
                    tableDialogVisible.value = true;
                }

                function editTable(table) {
                    editingTable.value = table;
                    Object.assign(tableForm, {
                        table_number: table.table_number,
                        seats: table.seats,
                        is_active: table.is_active
                    });
                    tableDialogVisible.value = true;
                }

                async function saveTable() {
                    try {
                        const data = { ...tableForm };
                        
                        if (editingTable.value) {
                            await apiRequest('PATCH', `/api/tables/${editingTable.value.id}`, data);
                            ElementPlus.ElMessage.success('æ¡Œå·æ›´æ–°æˆåŠŸ');
                        } else {
                            await apiRequest('POST', '/api/tables/', data);
                            ElementPlus.ElMessage.success('æ¡Œå·æ·»åŠ æˆåŠŸ');
                        }
                        
                        tableDialogVisible.value = false;
                        await loadTables();
                    } catch (error) {
                        console.error('ä¿å­˜æ¡Œå·å¤±è´¥:', error);
                        ElementPlus.ElMessage.error('ä¿å­˜æ¡Œå·å¤±è´¥');
                    }
                }

                async function deleteTable(tableId) {
                    try {
                        await ElementPlus.ElMessageBox.confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ¡Œå·å—ï¼Ÿ', 'ç¡®è®¤åˆ é™¤', {
                            type: 'warning'
                        });
                        
                        await apiRequest('DELETE', `/api/tables/${tableId}`);
                        ElementPlus.ElMessage.success('æ¡Œå·åˆ é™¤æˆåŠŸ');
                        await loadTables();
                    } catch (error) {
                        if (error !== 'cancel') {
                            console.error('åˆ é™¤æ¡Œå·å¤±è´¥:', error);
                            ElementPlus.ElMessage.error('åˆ é™¤æ¡Œå·å¤±è´¥');
                        }
                    }
                }

                async function generateQRCode(table) {
                    try {
                        const response = await apiRequest('POST', '/api/tables/generate-qr', {
                            table_id: table.id
                        });
                        
                        qrCodeTable.value = table;
                        qrCodeUrl.value = response.qr_code_url;
                        qrCodeVisible.value = true;
                    } catch (error) {
                        console.error('ç”ŸæˆäºŒç»´ç å¤±è´¥:', error);
                        ElementPlus.ElMessage.error('ç”ŸæˆäºŒç»´ç å¤±è´¥');
                    }
                }

                // ç³»ç»Ÿè®¾ç½®
                function saveStoreSettings() {
                    storeName.value = storeSettings.name;
                    storeAddress.value = storeSettings.address;
                    storePhone.value = storeSettings.phone;
                    ElementPlus.ElMessage.success('åº—é“ºè®¾ç½®å·²ä¿å­˜');
                }

                // Tabåˆ‡æ¢å¤„ç†
                function handleTabChange(tabName) {
                    activeTab.value = tabName;
                    
                    // æ ¹æ®ä¸åŒçš„Tabåˆ·æ–°æ•°æ®
                    switch(tabName) {
                        case 'orders':
                            loadOrders();
                            break;
                        case 'kitchen':
                            refreshKitchenOrders();
                            break;
                        case 'serving':
                            refreshServingOrders();
                            break;
                        case 'menu':
                            loadMenuItems();
                            loadCategories();
                            break;
                        case 'tables':
                            loadTables();
                            break;
                    }
                }

                // åˆå§‹åŒ–
                onMounted(() => {
                    loadInitialData();
                });

                return {
                    activeTab,
                    apiBaseUrl,
                    apiConnected,
                    currentStore,
                    storeName,
                    storeAddress,
                    storePhone,
                    storeSettings,
                    
                    // é¡¾å®¢ç«¯
                    tables,
                    selectedTable,
                    categories,
                    menuItems,
                    selectedCategory,
                    filteredMenuItems,
                    cart,
                    cartTotal,
                    currentStep,
                    paymentMethod,
                    memberPhone,
                    submitting,
                    
                    // è®¢å•ç®¡ç†
                    orders,
                    filteredOrders,
                    orderFilterStatus,
                    orderFilterTable,
                    orderDetailVisible,
                    selectedOrder,
                    receiptVisible,
                    
                    // å¨æˆ¿
                    kitchenOrders,
                    
                    // ä¼ èœ
                    servingOrders,
                    servingReceiptVisible,
                    selectedServingOrder,
                    
                    // èœå“ç®¡ç†
                    menuItemDialogVisible,
                    editingMenuItem,
                    menuItemForm,
                    
                    // æ¡Œå·ç®¡ç†
                    tableDialogVisible,
                    editingTable,
                    tableForm,
                    qrCodeVisible,
                    qrCodeUrl,
                    qrCodeTable,
                    
                    // æ–¹æ³•
                    handleTabChange,
                    selectTable,
                    addToCart,
                    updateCartQuantity,
                    submitOrder,
                    refreshOrders,
                    filterOrders,
                    viewOrderDetail,
                    updateOrderStatus,
                    canUpdateStatus,
                    printReceipt,
                    printReceiptConfirm,
                    getStatusText,
                    getItemStatusText,
                    getPaymentMethodText,
                    formatDateTime,
                    formatTime,
                    
                    refreshKitchenOrders,
                    updateItemStatus,
                    canUpdateItemStatus,
                    printKitchenReceipt,
                    
                    refreshServingOrders,
                    printServingReceipt,
                    printServingReceiptConfirm,
                    confirmServeItem,
                    allItemsServed,
                    confirmAllServed,
                    
                    showAddMenuItemDialog,
                    editMenuItem,
                    saveMenuItem,
                    deleteMenuItem,
                    
                    showAddTableDialog,
                    editTable,
                    saveTable,
                    deleteTable,
                    generateQRCode,
                    
                    saveStoreSettings
                };
            }
        });

        app.use(ElementPlus);
        app.mount('#app');
    </script>
</body>
</html>
