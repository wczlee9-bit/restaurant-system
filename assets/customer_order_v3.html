<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ½ï¸ é¤é¥®ç‚¹é¤ç³»ç»Ÿ - v3.1 ç”Ÿäº§ç‰ˆ</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <script src="https://unpkg.com/element-plus/dist/index.full.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'PingFang SC', 'Microsoft YaHei', Arial, sans-serif; background: #f0f2f5; }
        
        .mobile-container {
            max-width: 414px; margin: 0 auto; min-height: 100vh; background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 20px; text-align: center; position: sticky;
            top: 0; z-index: 100;
        }
        .header h1 { font-size: 22px; margin-bottom: 5px; }
        .header-info { font-size: 14px; opacity: 0.9; }
        
        .table-selector {
            padding: 40px 20px; text-align: center;
        }
        .table-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;
            margin-top: 20px;
        }
        .table-cell {
            padding: 25px 15px; border: 3px solid #eee; border-radius: 12px;
            cursor: pointer; transition: all 0.3s; font-size: 20px; font-weight: bold;
            color: #333;
        }
        .table-cell:hover { border-color: #667eea; transform: translateY(-3px); }
        .table-cell.selected { border-color: #667eea; background: #ecf5ff; }
        .table-cell.occupied { border-color: #f56c6c; background: #fef0f0; color: #f56c6c; }
        
        .category-tabs {
            display: flex; gap: 10px; overflow-x: auto; padding: 15px;
            border-bottom: 1px solid #eee; position: sticky; top: 80px;
            background: white; z-index: 90;
        }
        .category-tab {
            padding: 8px 16px; border-radius: 20px; white-space: nowrap;
            cursor: pointer; transition: all 0.3s; font-size: 14px;
            border: 1px solid #eee; background: white; flex-shrink: 0;
        }
        .category-tab.active { background: #667eea; color: white; border-color: #667eea; }
        
        .menu-list { padding: 15px; padding-bottom: 80px; }
        .menu-item {
            display: flex; gap: 15px; padding: 15px; margin-bottom: 15px;
            background: white; border-radius: 12px; border: 1px solid #eee;
            transition: all 0.3s;
        }
        .menu-item:hover { box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .menu-item-img {
            width: 80px; height: 80px; border-radius: 8px; object-fit: cover;
            flex-shrink: 0; background: #f0f0f0;
        }
        .menu-item-info { flex: 1; }
        .menu-item-name { font-size: 16px; font-weight: bold; margin-bottom: 8px; }
        .menu-item-desc { font-size: 12px; color: #909399; margin-bottom: 8px; }
        .menu-item-price { color: #f56c6c; font-size: 18px; font-weight: bold; }
        .menu-item-stock { font-size: 12px; color: #909399; margin-left: 10px; }
        
        .menu-item-actions {
            display: flex; align-items: center; gap: 10px; margin-top: 10px;
        }
        .qty-control {
            display: flex; align-items: center; gap: 10px;
        }
        .qty-btn {
            width: 30px; height: 30px; border-radius: 50%; border: none;
            background: #f0f0f0; cursor: pointer; font-size: 18px;
            display: flex; align-items: center; justify-content: center;
        }
        .qty-btn:active { transform: scale(0.95); }
        .qty-btn.add { background: #667eea; color: white; }
        .qty-btn.minus { background: #f0f0f0; }
        .qty-display { font-size: 16px; font-weight: bold; min-width: 30px; text-align: center; }
        
        .cart-bar {
            position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
            width: 100%; max-width: 414px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 15px 20px; display: flex; justify-content: space-between;
            align-items: center; cursor: pointer; box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
            z-index: 200;
        }
        .cart-info { flex: 1; }
        .cart-count { font-size: 16px; font-weight: bold; margin-bottom: 5px; }
        .cart-total { font-size: 14px; opacity: 0.9; }
        .cart-btn {
            padding: 10px 25px; background: white; color: #667eea;
            border-radius: 20px; font-weight: bold; border: none; cursor: pointer;
        }
        
        .cart-modal {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); z-index: 1000; display: flex;
            align-items: flex-end;
        }
        .cart-content {
            background: white; width: 100%; max-width: 414px; margin: 0 auto;
            border-radius: 20px 20px 0 0; max-height: 90vh; overflow-y: auto;
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        .cart-header {
            padding: 20px; border-bottom: 1px solid #eee; display: flex;
            justify-content: space-between; align-items: center;
            background: #f8f9fa; position: sticky; top: 0;
        }
        .cart-header h3 { font-size: 18px; display: flex; align-items: center; gap: 10px; }
        .step-number {
            width: 30px; height: 30px; background: #667eea; color: white;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 14px;
        }
        .cart-body { padding: 20px; }
        .cart-footer { padding: 20px; border-top: 1px solid #eee; }
        
        .cart-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 0; border-bottom: 1px solid #f0f0f0;
        }
        .cart-item-info { flex: 1; }
        .cart-item-name { font-size: 16px; font-weight: bold; margin-bottom: 5px; }
        .cart-item-price { color: #909399; font-size: 14px; }
        
        .order-summary { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 20px; }
        .summary-row {
            display: flex; justify-content: space-between; margin-bottom: 10px;
            font-size: 14px;
        }
        .summary-row.total { font-size: 18px; font-weight: bold; border-top: 1px solid #e0e0e0; padding-top: 10px; margin-bottom: 0; }
        .total-price { color: #f56c6c; font-size: 22px; }
        
        .payment-option {
            padding: 15px; border: 2px solid #e0e0e0; border-radius: 12px;
            margin-bottom: 15px; cursor: pointer; transition: all 0.3s;
        }
        .payment-option:hover { border-color: #667eea; background: #f0f7ff; }
        .payment-option.selected { border-color: #667eea; background: #ecf5ff; }
        .payment-option-header { display: flex; justify-content: space-between; align-items: center; }
        .payment-title { font-size: 16px; font-weight: bold; margin-bottom: 5px; }
        .payment-desc { font-size: 13px; color: #909399; }
        .payment-badge {
            padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: bold;
        }
        .badge-immediate { background: #67c23a; color: white; }
        .badge-counter { background: #e6a23c; color: white; }
        
        .empty-cart { text-align: center; padding: 60px 20px; }
        .empty-icon { font-size: 64px; margin-bottom: 20px; }
        .loading-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.9); display: flex; align-items: center;
            justify-content: center; z-index: 2000;
        }
        
        .order-status {
            margin: 15px; padding: 15px; background: #fff7e6; border-radius: 8px;
            border-left: 4px solid #e6a23c;
        }
        .order-status h3 { margin-bottom: 10px; font-size: 16px; }
    </style>
</head>
<body>
    <div id="app">
        <!-- åŠ è½½çŠ¶æ€ -->
        <div class="loading-overlay" v-if="loading">
            <div>
                <div style="font-size: 48px; margin-bottom: 20px;">ğŸ½ï¸</div>
                <div style="font-size: 18px; color: #666;">åŠ è½½ä¸­...</div>
            </div>
        </div>
        
        <div class="mobile-container">
            <!-- æ¡Œå·é€‰æ‹©å™¨ -->
            <div v-if="!selectedTable" class="table-selector">
                <h2 style="margin-bottom: 10px;">æ¬¢è¿å…‰ä¸´ï¼</h2>
                <p style="color: #909399; margin-bottom: 10px;">è¯·é€‰æ‹©æ‚¨çš„æ¡Œå·</p>

                <!-- è°ƒè¯•ä¿¡æ¯ -->
                <div v-if="tables.length === 0" style="margin-bottom: 20px; padding: 15px; background: #fff7e6; border-radius: 8px; border-left: 4px solid #e6a23c;">
                    <p style="font-size: 14px; color: #e6a23c; margin-bottom: 10px;">
                        âš ï¸ æœªåŠ è½½åˆ°æ¡Œå·æ•°æ®
                    </p>
                    <el-button type="primary" size="small" @click="reloadTables">
                        ğŸ”„ é‡æ–°åŠ è½½æ¡Œå·
                    </el-button>
                </div>

                <div class="table-grid">
                    <div v-for="table in tables" :key="table.id"
                         class="table-cell"
                         :class="{selected: tempTableId === table.id, occupied: table.is_occupied}"
                         @click="selectTable(table)">
                        {{ table.table_number }}å·
                    </div>
                </div>

                <el-button type="primary" size="large" style="width: 100%; margin-top: 30px; height: 50px;"
                           :disabled="!tempTableId" @click="confirmTable()">
                    ç¡®è®¤æ¡Œå·ï¼Œå¼€å§‹ç‚¹é¤
                </el-button>

                <div style="margin-top: 20px; font-size: 12px; color: #909399;">
                    <p style="margin-bottom: 5px;">* å·²è¢«å ç”¨çš„æ¡Œå·æ— æ³•é€‰æ‹©</p>
                    <p v-if="tables.length > 0">å½“å‰å…± {{ tables.length }} ä¸ªæ¡Œå·</p>
                </div>
            </div>
            
            <!-- èœå•å’Œè®¢å•çŠ¶æ€ -->
            <div v-else>
                <!-- å½“å‰è®¢å•çŠ¶æ€ -->
                <div v-if="currentOrder" class="order-status">
                    <h3>ğŸ“‹ è®¢å•çŠ¶æ€</h3>
                    <p style="margin-bottom: 5px;">è®¢å•å·ï¼š{{ currentOrder.order_id }}</p>
                    <p style="margin-bottom: 5px;">çŠ¶æ€ï¼š{{ getStatusText(currentOrder.status) }}</p>
                    <p>æäº¤æ—¶é—´ï¼š{{ formatTime(currentOrder.created_at) }}</p>
                </div>
                
                <!-- å¤´éƒ¨ -->
                <div class="header">
                    <h1>{{ selectedTable.table_number }}å·æ¡Œ</h1>
                    <div class="header-info">{{ currentOrder ? 'è®¢å•å·²æäº¤' : 'è¯·é€‰æ‹©èœå“' }}</div>
                </div>
                
                <!-- èœå“åˆ†ç±» -->
                <div class="category-tabs">
                    <div class="category-tab" :class="{active: selectedCategory === null}"
                         @click="selectedCategory = null">
                        å…¨éƒ¨
                    </div>
                    <div v-for="cat in categories" :key="cat.id"
                         class="category-tab" :class="{active: selectedCategory === cat.id}"
                         @click="selectedCategory = cat.id">
                        {{ cat.name }}
                    </div>
                </div>
                
                <!-- èœå“åˆ—è¡¨ -->
                <div class="menu-list">
                    <div v-if="filteredMenuItems.length === 0" style="text-align: center; padding: 40px; color: #909399;">
                        <div style="font-size: 48px;">ğŸ“­</div>
                        <p style="margin-top: 10px;">æš‚æ— èœå“</p>
                        <el-button type="primary" @click="reloadMenu" style="margin-top: 15px;">
                            ğŸ”„ é‡æ–°åŠ è½½
                        </el-button>
                    </div>
                    
                    <div v-else>
                        <div v-for="item in filteredMenuItems" :key="item.id" class="menu-item">
                            <div class="menu-item-info">
                                <div class="menu-item-name">{{ item.name }}</div>
                                <div class="menu-item-desc">{{ item.description || '' }}</div>
                                <div class="menu-item-price">Â¥{{ item.price }}
                                    <span class="menu-item-stock" v-if="item.stock <= 10">åº“å­˜ï¼š{{ item.stock }}</span>
                                </div>
                            </div>
                            <div v-if="item.is_available && item.stock > 0" class="qty-control">
                                <button class="qty-btn minus" @click="removeFromCart(item)">-</button>
                                <span class="qty-display">{{ getCartItemQty(item) }}</span>
                                <button class="qty-btn add" @click="addToCart(item)">+</button>
                            </div>
                            <div v-else class="qty-control">
                                <span style="color: #f56c6c; font-size: 12px;">
                                    {{ !item.is_available ? 'å·²ä¸‹æ¶' : 'å”®ç½„' }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- è´­ç‰©è½¦æ  -->
                <div class="cart-bar" v-if="cartTotal > 0" @click="openCartStep1()">
                    <div class="cart-info">
                        <div class="cart-count">{{ cartTotalQty }}ä»¶å•†å“</div>
                        <div class="cart-total">Â¥{{ cartTotal }}</div>
                    </div>
                    <button class="cart-btn">ç¡®è®¤è®¢å•</button>
                </div>
            </div>
        </div>
        
        <!-- è´­ç‰©è½¦å¼¹çª— - æ­¥éª¤1ï¼šç¡®è®¤è®¢å• -->
        <div class="cart-modal" v-if="showCartStep1" @click.self="closeCart()">
            <div class="cart-content">
                <div class="cart-header">
                    <h3><span class="step-number">1</span>ç¡®è®¤è®¢å•</h3>
                    <span style="cursor: pointer; font-size: 24px;" @click="closeCart()">Ã—</span>
                </div>
                
                <div class="cart-body">
                    <div v-if="cart.length === 0" class="empty-cart">
                        <div class="empty-icon">ğŸ›’</div>
                        <p>è´­ç‰©è½¦æ˜¯ç©ºçš„</p>
                    </div>
                    
                    <div v-else>
                        <div v-for="item in cart" :key="item.id" class="cart-item">
                            <div class="cart-item-info">
                                <div class="cart-item-name">{{ item.name }}</div>
                                <div class="cart-item-price">Â¥{{ item.price }} Ã— {{ item.qty }}</div>
                            </div>
                            <div style="font-weight: bold;">Â¥{{ (item.price * item.qty).toFixed(2) }}</div>
                        </div>
                        
                        <div class="order-summary">
                            <div class="summary-row">
                                <span>æ¡Œå·</span>
                                <span>{{ selectedTable.table_number }}å·æ¡Œ</span>
                            </div>
                            <div class="summary-row">
                                <span>å•†å“æ•°é‡</span>
                                <span>{{ cartTotalQty }}ä»¶</span>
                            </div>
                            <div class="summary-row total">
                                <span>åˆè®¡</span>
                                <span class="total-price">Â¥{{ cartTotal }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="cart-footer">
                    <el-button type="primary" size="large" style="width: 100%; height: 50px;"
                               :disabled="cart.length === 0"
                               @click="submitOrder()">
                        ç¡®è®¤ä¸‹å•
                    </el-button>
                </div>
            </div>
        </div>
        
        <!-- è®¢å•æ”¯ä»˜å¼¹çª— -->
        <div class="cart-modal" v-if="showPaymentModal" @click.self="closePaymentModal()">
            <div class="cart-content">
                <div class="cart-header">
                    <h3>ğŸ’° é€‰æ‹©æ”¯ä»˜æ–¹å¼</h3>
                    <span style="cursor: pointer; font-size: 24px;" @click="closePaymentModal()">Ã—</span>
                </div>
                
                <div class="cart-body">
                    <div class="order-summary">
                        <div class="summary-row">
                            <span>è®¢å•å·</span>
                            <span>{{ currentOrder.order_id }}</span>
                        </div>
                        <div class="summary-row">
                            <span>æ¡Œå·</span>
                            <span>{{ selectedTable.table_number }}å·æ¡Œ</span>
                        </div>
                        <div class="summary-row">
                            <span>å•†å“æ•°é‡</span>
                            <span>{{ cartTotalQty }}ä»¶</span>
                        </div>
                        <div class="summary-row total">
                            <span>éœ€æ”¯ä»˜</span>
                            <span class="total-price">Â¥{{ cartTotal }}</span>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <div style="margin-bottom: 15px; font-weight: bold; color: #333;">è¯·é€‰æ‹©æ”¯ä»˜æ–¹å¼ï¼š</div>

                        <div v-if="shopInfo.paymentMethods.length === 0" style="text-align: center; color: #999; padding: 20px;">
                            æš‚æ— å¯ç”¨çš„æ”¯ä»˜æ–¹å¼
                        </div>

                        <div class="payment-option"
                             v-for="method in shopInfo.paymentMethods"
                             :key="method"
                             :class="{selected: paymentMethod === method}"
                             @click="paymentMethod = method">
                            <div class="payment-option-header">
                                <div>
                                    <div class="payment-title" v-if="method === 'immediate'">ğŸ’³ é©¬ä¸Šä»˜æ¬¾</div>
                                    <div class="payment-title" v-else-if="method === 'counter'">ğŸª é¤åä»˜æ¬¾</div>
                                    <div class="payment-title" v-else>ğŸ’³ å…¶ä»–æ”¯ä»˜</div>

                                    <div class="payment-desc" v-if="method === 'immediate'">ä½¿ç”¨å¾®ä¿¡æˆ–æ”¯ä»˜å®åœ¨çº¿æ”¯ä»˜</div>
                                    <div class="payment-desc" v-else-if="method === 'counter'">ç”¨é¤ååˆ°æ”¶é“¶å°æ”¯ä»˜</div>
                                    <div class="payment-desc" v-else>å…¶ä»–æ”¯ä»˜æ–¹å¼</div>
                                </div>
                                <span class="payment-badge badge-immediate" v-if="method === 'immediate'">ç«‹å³æ”¯ä»˜</span>
                                <span class="payment-badge badge-counter" v-else-if="method === 'counter'">çµæ´»ä¾¿æ·</span>
                                <span class="payment-badge badge-immediate" v-else>å…¶ä»–</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="cart-footer">
                    <el-button type="warning" size="default" style="width: 48%; margin-right: 4%;" @click="goToConfirmStep()">
                        è¿”å›
                    </el-button>
                    <el-button type="primary" size="default" style="width: 48%;"
                               :disabled="!paymentMethod" @click="confirmPayment()">
                        {{ paymentMethod === 'immediate' ? 'é©¬ä¸Šä»˜æ¬¾' : 'é¤åä»˜æ¬¾' }}
                    </el-button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    loading: true,
                    tables: [],
                    categories: [],
                    menuItems: [],
                    selectedTable: null,
                    tempTableId: null,
                    selectedCategory: null,
                    cart: [],
                    showCartStep1: false,
                    showPaymentModal: false,  // æ”¹ä¸ºæ”¯ä»˜å¼¹çª—
                    currentOrder: null,
                    paymentMethod: '',
                    ws: null,
                    wsConnected: false,
                    shopInfo: {
                        name: 'ç¾å‘³é¤å…',
                        paymentMethods: ['immediate', 'counter']  // é»˜è®¤ä¸¤ç§æ”¯ä»˜æ–¹å¼
                    }
                };
            },
            computed: {
                filteredMenuItems() {
                    if (this.selectedCategory === null) {
                        return this.menuItems;
                    }
                    return this.menuItems.filter(item => item.category_id === this.selectedCategory);
                },
                cartTotal() {
                    return this.cart.reduce((sum, item) => sum + (item.price * item.qty), 0).toFixed(2);
                },
                cartTotalQty() {
                    return this.cart.reduce((sum, item) => sum + item.qty, 0);
                }
            },
            async mounted() {
                await this.initData();
                this.checkTableFromUrl();
            },
            methods: {
                async initData() {
                    this.loading = true;
                    try {
                        await Promise.all([
                            this.loadShopInfo(),
                            this.loadTables(),
                            this.loadCategories(),
                            this.loadMenuItems()
                        ]);
                        
                        // æ£€æŸ¥æ˜¯å¦æœ‰èœå“æ•°æ®
                        if (this.menuItems.length === 0) {
                            this.$message.warning('æš‚æ— èœå“æ•°æ®ï¼Œè¯·è”ç³»åº—å‘˜åˆå§‹åŒ–ç³»ç»Ÿ');
                        }
                    } catch (error) {
                        console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                        this.$message.error('åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢');
                    } finally {
                        this.loading = false;
                    }
                },

                loadShopInfo() {
                    // ä» localStorage åŠ è½½åº—é“ºä¿¡æ¯
                    const savedInfo = localStorage.getItem('shopInfo');
                    if (savedInfo) {
                        try {
                            const parsed = JSON.parse(savedInfo);
                            if (parsed.paymentMethods && parsed.paymentMethods.length > 0) {
                                this.shopInfo.paymentMethods = parsed.paymentMethods;
                            }
                            if (parsed.name) {
                                this.shopInfo.name = parsed.name;
                            }
                        } catch (error) {
                            console.error('åŠ è½½åº—é“ºä¿¡æ¯å¤±è´¥:', error);
                        }
                    }
                },
                
                async loadTables() {
                    try {
                        console.log('Loading tables...');
                        const response = await axios.get('/api/tables/');
                        this.tables = response.data;
                        console.log('åŠ è½½æ¡Œå·æˆåŠŸ:', this.tables);
                        console.log(`å…±åŠ è½½ ${this.tables.length} ä¸ªæ¡Œå·`);

                        if (this.tables.length === 0) {
                            console.warn('No tables loaded, this might be a data initialization issue');
                            this.$message.warning('æœªåŠ è½½åˆ°æ¡Œå·æ•°æ®ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡');
                        }
                    } catch (error) {
                        console.error('åŠ è½½æ¡Œå·å¤±è´¥:', error);
                        console.error('Error details:', {
                            message: error.message,
                            response: error.response?.data,
                            status: error.response?.status
                        });
                        this.$message.error('åŠ è½½æ¡Œå·å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                        throw error;
                    }
                },

                async reloadTables() {
                    this.$message.info('æ­£åœ¨é‡æ–°åŠ è½½æ¡Œå·...');
                    try {
                        await this.loadTables();
                        if (this.tables.length > 0) {
                            this.$message.success(`æˆåŠŸåŠ è½½ ${this.tables.length} ä¸ªæ¡Œå·`);
                            // å¦‚æœ URL ä¸­æœ‰æ¡Œå·å‚æ•°ï¼Œé‡æ–°å°è¯•åŒ¹é…
                            this.checkTableFromUrl();
                        } else {
                            this.$message.warning('ä»ç„¶æ²¡æœ‰æ¡Œå·æ•°æ®ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡æˆ–è”ç³»åº—å‘˜');
                        }
                    } catch (error) {
                        this.$message.error('é‡æ–°åŠ è½½æ¡Œå·å¤±è´¥');
                    }
                },
                
                async loadCategories() {
                    try {
                        const response = await axios.get('/api/menu-categories/');
                        this.categories = response.data;
                        console.log('åŠ è½½åˆ†ç±»æˆåŠŸ:', this.categories);
                    } catch (error) {
                        console.error('åŠ è½½åˆ†ç±»å¤±è´¥:', error);
                        throw error;
                    }
                },
                
                async loadMenuItems() {
                    try {
                        const response = await axios.get('/api/menu-items/');
                        this.menuItems = response.data;
                        console.log('åŠ è½½èœå“æˆåŠŸ:', this.menuItems);
                    } catch (error) {
                        console.error('åŠ è½½èœå“å¤±è´¥:', error);
                        throw error;
                    }
                },

                async reloadMenu() {
                    this.$message.info('æ­£åœ¨é‡æ–°åŠ è½½èœå“...');
                    try {
                        await this.loadMenuItems();
                        await this.loadCategories();
                        if (this.menuItems.length > 0) {
                            this.$message.success(`æˆåŠŸåŠ è½½ ${this.menuItems.length} é“èœå“`);
                        } else {
                            this.$message.warning('ä»ç„¶æ²¡æœ‰èœå“æ•°æ®ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡');
                        }
                    } catch (error) {
                        this.$message.error('é‡æ–°åŠ è½½å¤±è´¥');
                    }
                },
                
                checkTableFromUrl() {
                    const params = new URLSearchParams(window.location.search);
                    const tableNumber = params.get('table');

                    console.log('checkTableFromUrl called, tableNumber from URL:', tableNumber);
                    console.log('Available tables:', this.tables);

                    if (tableNumber && this.tables.length > 0) {
                        // å°è¯•å¤šç§åŒ¹é…æ–¹å¼
                        let table = null;

                        // 1. å°è¯•ç›´æ¥åŒ¹é…å­—ç¬¦ä¸²
                        table = this.tables.find(t => t.table_number === tableNumber);
                        if (table) {
                            console.log('Matched with direct string comparison');
                        }

                        // 2. å°è¯•å°† URL å‚æ•°è½¬æ¢ä¸ºæ•°å­—ååŒ¹é…
                        if (!table && !isNaN(tableNumber)) {
                            const numTableNumber = parseInt(tableNumber);
                            table = this.tables.find(t => t.table_number === String(numTableNumber) || t.table_number === numTableNumber);
                            if (table) {
                                console.log('Matched with number comparison');
                            }
                        }

                        // 3. å¦‚æœ URL å‚æ•°æ˜¯ "A01" æ ¼å¼ï¼Œå°è¯•æå–æ•°å­—éƒ¨åˆ†åŒ¹é…
                        if (!table && tableNumber.startsWith('A')) {
                            const numPart = tableNumber.substring(1);
                            if (!isNaN(numPart)) {
                                table = this.tables.find(t => t.table_number === numPart || t.table_number === parseInt(numPart));
                                if (table) {
                                    console.log('Matched with A-prefixed format');
                                }
                            }
                        }

                        // 4. å¦‚æœ URL å‚æ•°æ˜¯æ•°å­—ï¼Œå°è¯•åŒ¹é… "A01" æ ¼å¼çš„åç«¯æ•°æ®
                        if (!table && !isNaN(tableNumber)) {
                            const paddedNumber = String(tableNumber).padStart(2, '0');
                            table = this.tables.find(t => t.table_number === `A${paddedNumber}`);
                            if (table) {
                                console.log('Matched with A-prefixed backend format');
                            }
                        }

                        if (table) {
                            console.log('Table found from URL:', table);
                            this.selectTable(table);
                            this.confirmTable();
                        } else {
                            console.warn('No matching table found for tableNumber:', tableNumber);
                            this.$message.warning(`URL ä¸­çš„æ¡Œå· "${tableNumber}" æ— æ•ˆï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©æ¡Œå·`);
                        }
                    } else if (tableNumber && this.tables.length === 0) {
                        console.warn('Table number in URL but no tables loaded');
                        this.$message.warning('æ¡Œå·æ•°æ®æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢æˆ–è”ç³»åº—å‘˜');
                    }
                },
                
                selectTable(table) {
                    this.tempTableId = table.id;
                },
                
                confirmTable() {
                    console.log('confirmTable called, tempTableId:', this.tempTableId);
                    console.log('Available tables:', this.tables);

                    if (!this.tempTableId) {
                        this.$message.error('è¯·å…ˆé€‰æ‹©æ¡Œå·');
                        return;
                    }

                    const table = this.tables.find(t => t.id === this.tempTableId);
                    if (table) {
                        this.selectedTable = table;
                        this.$message.success(`å·²é€‰æ‹©${table.table_number}å·æ¡Œ`);
                        this.connectWebSocket(table.id);
                    } else {
                        console.error('Table not found with id:', this.tempTableId);
                        this.$message.error('ç¡®è®¤æ¡Œå·å¤±è´¥ï¼Œè¯·é‡æ–°é€‰æ‹©æ¡Œå·');
                    }
                },
                
                addToCart(item) {
                    const cartItem = this.cart.find(c => c.id === item.id);
                    if (cartItem) {
                        cartItem.qty++;
                    } else {
                        this.cart.push({
                            id: item.id,
                            name: item.name,
                            price: item.price,
                            qty: 1,
                            category_id: item.category_id
                        });
                    }
                },
                
                removeFromCart(item) {
                    const index = this.cart.findIndex(c => c.id === item.id);
                    if (index > -1) {
                        if (this.cart[index].qty > 1) {
                            this.cart[index].qty--;
                        } else {
                            this.cart.splice(index, 1);
                        }
                    }
                },
                
                getCartItemQty(item) {
                    const cartItem = this.cart.find(c => c.id === item.id);
                    return cartItem ? cartItem.qty : 0;
                },
                
                openCartStep1() {
                    this.showCartStep1 = true;
                    this.showPaymentModal = false;
                },
                
                openCartStep1() {
                    this.showCartStep1 = true;
                    this.showPaymentModal = false;
                },
                
                closeCart() {
                    this.showCartStep1 = false;
                    this.showPaymentModal = false;
                },

                closePaymentModal() {
                    this.showPaymentModal = false;
                },
                
                async submitOrder() {
                    if (this.cart.length === 0) {
                        this.$message.warning('è¯·å…ˆæ·»åŠ å•†å“åˆ°è´­ç‰©è½¦');
                        return;
                    }
                    
                    // ç¬¬ä¸€æ­¥ï¼šç¡®è®¤ä¸‹å•ï¼ˆä¸é€‰æ‹©æ”¯ä»˜æ–¹å¼ï¼‰
                    try {
                        // æ„é€ è®¢å•æ•°æ®ï¼ˆä¸å«æ”¯ä»˜æ–¹å¼ï¼‰
                        const orderData = {
                            table_id: this.selectedTable.id,
                            items: this.cart.map(item => ({
                                menu_item_id: item.id,
                                quantity: item.qty,
                                special_instructions: ''
                            }))
                        };
                        
                        console.log('æäº¤è®¢å•æ•°æ®:', orderData);
                        
                        // æäº¤è®¢å•
                        const response = await axios.post('/api/orders/', orderData);
                        
                        console.log('è®¢å•æäº¤æˆåŠŸ:', response.data);
                        
                        // ä¿å­˜å½“å‰è®¢å•ä¿¡æ¯
                        this.currentOrder = {
                            ...response.data,
                            status: response.data.status || 'pending',
                            order_id: response.data.order_number || response.data.id,
                            created_at: response.data.created_at || new Date().toISOString()
                        };
                        
                        // æ¸…ç©ºè´­ç‰©è½¦
                        this.cart = [];
                        
                        // å…³é—­è´­ç‰©è½¦å¼¹çª—ï¼Œæ˜¾ç¤ºæ”¯ä»˜å¼¹çª—
                        this.showCartStep1 = false;
                        this.showPaymentModal = true;
                        
                        // ä¿å­˜è®¢å•åˆ°æœ¬åœ°
                        const savedOrders = JSON.parse(localStorage.getItem('orders') || '[]');
                        savedOrders.unshift(this.currentOrder);
                        localStorage.setItem('orders', JSON.stringify(savedOrders));
                        
                        this.$message.success(`è®¢å•æäº¤æˆåŠŸï¼è®¢å•å·ï¼š${this.currentOrder.order_id}`);
                        
                    } catch (error) {
                        console.error('æäº¤è®¢å•å¤±è´¥:', error);
                        console.error('é”™è¯¯è¯¦æƒ…:', {
                            message: error.message,
                            response: error.response?.data,
                            status: error.response?.status
                        });
                        
                        let errorMsg = 'æäº¤è®¢å•å¤±è´¥';
                        if (error.response?.data?.detail) {
                            errorMsg += ': ' + error.response.data.detail;
                        } else if (error.message) {
                            errorMsg += ': ' + error.message;
                        } else {
                            errorMsg += 'ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–è”ç³»åº—å‘˜';
                        }
                        
                        this.$message.error(errorMsg);
                    }
                },
                
                async confirmPayment() {
                    // ç¬¬äºŒæ­¥ï¼šç¡®è®¤æ”¯ä»˜ï¼ˆé€‰æ‹©æ”¯ä»˜æ–¹å¼ï¼‰
                    if (!this.currentOrder) {
                        this.$message.warning('æ²¡æœ‰è®¢å•éœ€è¦æ”¯ä»˜');
                        return;
                    }
                    
                    if (!this.paymentMethod) {
                        this.$message.warning('è¯·é€‰æ‹©æ”¯ä»˜æ–¹å¼');
                        return;
                    }
                    
                    try {
                        // è°ƒç”¨ç¡®è®¤æ”¯ä»˜æ¥å£
                        const response = await axios.post(`/api/orders/${this.currentOrder.id}/confirm-payment`, {
                            payment_method: this.paymentMethod
                        });
                        
                        console.log('ç¡®è®¤æ”¯ä»˜æˆåŠŸ:', response.data);
                        
                        // æ›´æ–°å½“å‰è®¢å•ä¿¡æ¯
                        this.currentOrder.payment_method = response.data.payment_method;
                        this.currentOrder.payment_status = response.data.payment_status;
                        
                        // å…³é—­æ”¯ä»˜å¼¹çª—
                        this.closePaymentModal();
                        
                        const paymentText = this.paymentMethod === 'immediate' ? 'æ”¯ä»˜æˆåŠŸ' : 'å·²é€‰æ‹©é¤åæŸœå°æ”¯ä»˜';
                        this.$message.success(`${paymentText}ï¼è®¢å•å·ï¼š${this.currentOrder.order_id}`);
                        
                    } catch (error) {
                        console.error('ç¡®è®¤æ”¯ä»˜å¤±è´¥:', error);
                        console.error('é”™è¯¯è¯¦æƒ…:', {
                            message: error.message,
                            response: error.response?.data,
                            status: error.response?.status
                        });
                        
                        let errorMsg = 'ç¡®è®¤æ”¯ä»˜å¤±è´¥';
                        if (error.response?.data?.detail) {
                            errorMsg += ': ' + error.response.data.detail;
                        } else if (error.message) {
                            errorMsg += ': ' + error.message;
                        } else {
                            errorMsg += 'ï¼Œè¯·ç¨åé‡è¯•æˆ–è”ç³»åº—å‘˜';
                        }
                        
                        this.$message.error(errorMsg);
                    }
                        
                        this.$message.error(errorMsg);
                    }
                },
                
                connectWebSocket(tableId) {
                    if (this.ws) {
                        this.ws.close();
                    }
                    
                    const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const wsUrl = `${wsProtocol}//${window.location.host}/ws/orders/table/${tableId}`;
                    
                    console.log('å°è¯•è¿æ¥ WebSocket:', wsUrl);
                    
                    this.ws = new WebSocket(wsUrl);
                    
                    this.ws.onopen = () => {
                        this.wsConnected = true;
                        console.log('WebSocket connected');
                    };
                    
                    this.ws.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        if (data.order_id) {
                            this.currentOrder = data;
                            console.log('æ”¶åˆ°è®¢å•æ›´æ–°:', data);
                        }
                    };
                    
                    this.ws.onerror = (error) => {
                        console.error('WebSocket error:', error);
                        this.wsConnected = false;
                    };
                    
                    this.ws.onclose = () => {
                        this.wsConnected = false;
                        console.log('WebSocket closed');
                    };
                },
                
                formatTime(timestamp) {
                    if (!timestamp) return '-';
                    const date = new Date(timestamp);
                    return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                },
                
                getStatusText(status) {
                    const statusMap = {
                        'pending': 'å¾…ç¡®è®¤',
                        'preparing': 'åˆ¶ä½œä¸­',
                        'ready': 'å¾…ä¼ èœ',
                        'serving': 'ä¸Šèœä¸­',
                        'completed': 'å·²å®Œæˆ',
                        'paid': 'å·²æ”¯ä»˜',
                        'unpaid': 'å¾…æ”¯ä»˜'
                    };
                    return statusMap[status] || status;
                }
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>
