<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‰ºòÊÉ†ÁÆ°ÁêÜ</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <script src="https://unpkg.com/element-plus/dist/index.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', Arial, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .header h1 { font-size: 24px; color: #333; }

        .main-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .discount-type-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
        }
        .discount-type-badge.percentage { background: #e3f2fd; color: #1976d2; }
        .discount-type-badge.fixed { background: #fff3e0; color: #f57c00; }
        .discount-type-badge.points { background: #e8f5e9; color: #388e3c; }

        .discount-value {
            font-size: 20px;
            font-weight: bold;
            color: #f56c6c;
        }

        .discount-info {
            color: #666;
            font-size: 13px;
            margin-top: 8px;
        }

        .discount-info-item {
            margin-right: 15px;
        }

        .discount-conditions {
            margin-top: 10px;
            padding: 10px;
            background: #f5f7fa;
            border-radius: 5px;
            font-size: 12px;
            color: #666;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
        }
        .status-badge.active { background: #e8f5e9; color: #4caf50; }
        .status-badge.inactive { background: #ffebee; color: #f44336; }

        @media (max-width: 768px) {
            .container { padding: 10px; }
            .header { flex-direction: column; gap: 10px; align-items: flex-start; }
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <div class="header">
                <h1>üéÅ ‰ºòÊÉ†ÁÆ°ÁêÜ</h1>
                <div style="display: flex; gap: 10px;">
                    <el-button @click="loadDiscounts" :loading="loading">Âà∑Êñ∞</el-button>
                    <el-button type="primary" @click="showCreateDialog">ÂàõÂª∫‰ºòÊÉ†</el-button>
                </div>
            </div>

            <div class="main-card">
                <div v-loading="loading">
                    <!-- Á≠õÈÄâÊù°‰ª∂ -->
                    <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <el-select v-model="filters.is_active" placeholder="Áä∂ÊÄÅ" clearable style="width: 120px;">
                            <el-option label="ÂêØÁî®" :value="true"></el-option>
                            <el-option label="Á¶ÅÁî®" :value="false"></el-option>
                        </el-select>
                        <el-select v-model="filters.discount_type" placeholder="‰ºòÊÉ†Á±ªÂûã" clearable style="width: 150px;">
                            <el-option label="ÁôæÂàÜÊØîÊäòÊâ£" value="percentage"></el-option>
                            <el-option label="Âõ∫ÂÆöÈáëÈ¢ù" value="fixed"></el-option>
                            <el-option label="ÁßØÂàÜÊäµÊâ£" value="points"></el-option>
                        </el-select>
                        <el-button type="primary" @click="loadDiscounts">Êü•ËØ¢</el-button>
                    </div>

                    <!-- ‰ºòÊÉ†ÂàóË°® -->
                    <el-empty v-if="discounts.length === 0 && !loading" description="ÊöÇÊó†‰ºòÊÉ†ÈÖçÁΩÆ"></el-empty>
                    
                    <el-row v-else :gutter="20">
                        <el-col :xs="24" :sm="12" :md="8" :lg="6" v-for="discount in discounts" :key="discount.id" style="margin-bottom: 20px;">
                            <el-card shadow="hover">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                                    <span class="discount-type-badge" :class="discount.discount_type">
                                        {{ getDiscountTypeText(discount.discount_type) }}
                                    </span>
                                    <span class="status-badge" :class="discount.is_active ? 'active' : 'inactive'">
                                        {{ discount.is_active ? 'ÂêØÁî®' : 'Á¶ÅÁî®' }}
                                    </span>
                                </div>

                                <div class="discount-value">
                                    <span v-if="discount.discount_type === 'percentage'">{{ discount.discount_value }}%</span>
                                    <span v-else-if="discount.discount_type === 'fixed'">¬•{{ discount.discount_value }}</span>
                                    <span v-else-if="discount.discount_type === 'points'">{{ discount.discount_value }}ÁßØÂàÜ</span>
                                </div>

                                <div v-if="discount.description" class="discount-info">
                                    {{ discount.description }}
                                </div>

                                <div class="discount-conditions">
                                    <div v-if="discount.min_amount" class="discount-info-item">
                                        ÊúÄ‰ΩéÊ∂àË¥π: ¬•{{ discount.min_amount }}
                                    </div>
                                    <div v-if="discount.max_discount" class="discount-info-item">
                                        ÊúÄÂ§ß‰ºòÊÉ†: ¬•{{ discount.max_discount }}
                                    </div>
                                    <div v-if="discount.member_level" class="discount-info-item">
                                        ÈÄÇÁî®Á≠âÁ∫ß: Lv.{{ discount.member_level }}
                                    </div>
                                    <div v-if="discount.points_required" class="discount-info-item">
                                        ÊâÄÈúÄÁßØÂàÜ: {{ discount.points_required }}
                                    </div>
                                    <div v-if="discount.valid_from || discount.valid_until" class="discount-info-item">
                                        ÊúâÊïàÊúü: {{ formatDate(discount.valid_from) }} - {{ formatDate(discount.valid_until) }}
                                    </div>
                                </div>

                                <div style="margin-top: 15px; display: flex; gap: 10px;">
                                    <el-button size="small" @click="showEditDialog(discount)">ÁºñËæë</el-button>
                                    <el-button size="small" type="danger" @click="confirmDelete(discount)">Âà†Èô§</el-button>
                                </div>
                            </el-card>
                        </el-col>
                    </el-row>
                </div>
            </div>

            <!-- ÂàõÂª∫/ÁºñËæë‰ºòÊÉ†ÂØπËØùÊ°Ü -->
            <el-dialog
                v-model="showDialog"
                :title="isEditMode ? 'ÁºñËæë‰ºòÊÉ†' : 'ÂàõÂª∫‰ºòÊÉ†'"
                width="600px"
                :close-on-click-modal="false">
                <el-form :model="formData" :rules="formRules" ref="formRef" label-width="120px">
                    <el-form-item label="‰ºòÊÉ†Á±ªÂûã" prop="discount_type">
                        <el-select v-model="formData.discount_type" placeholder="ËØ∑ÈÄâÊã©‰ºòÊÉ†Á±ªÂûã" style="width: 100%;">
                            <el-option label="ÁôæÂàÜÊØîÊäòÊâ£" value="percentage"></el-option>
                            <el-option label="Âõ∫ÂÆöÈáëÈ¢ù" value="fixed"></el-option>
                            <el-option label="ÁßØÂàÜÊäµÊâ£" value="points"></el-option>
                        </el-select>
                    </el-form-item>

                    <el-form-item label="‰ºòÊÉ†ÂÄº" prop="discount_value">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <el-input-number 
                                v-model="formData.discount_value" 
                                :min="0.01" 
                                :max="formData.discount_type === 'percentage' ? 100 : 9999"
                                :precision="formData.discount_type === 'percentage' ? 2 : 0"
                                :step="0.01"
                                style="flex: 1;">
                            </el-input-number>
                            <span v-if="formData.discount_type === 'percentage'">%</span>
                            <span v-else-if="formData.discount_type === 'fixed'">ÂÖÉ</span>
                            <span v-else>ÁßØÂàÜ</span>
                        </div>
                    </el-form-item>

                    <el-form-item label="ÊúÄ‰ΩéÊ∂àË¥π" prop="min_amount">
                        <el-input-number 
                            v-model="formData.min_amount" 
                            :min="0" 
                            :precision="2"
                            placeholder="‰∏çÈôêÂà∂"
                            style="width: 100%;">
                        </el-input-number>
                    </el-form-item>

                    <el-form-item label="ÊúÄÂ§ß‰ºòÊÉ†" prop="max_discount">
                        <el-input-number 
                            v-model="formData.max_discount" 
                            :min="0" 
                            :precision="2"
                            placeholder="‰∏çÈôêÂà∂"
                            style="width: 100%;">
                        </el-input-number>
                    </el-form-item>

                    <el-form-item label="ÈÄÇÁî®‰ºöÂëòÁ≠âÁ∫ß" prop="member_level">
                        <el-select v-model="formData.member_level" placeholder="‰∏çÈôêÁ≠âÁ∫ß" clearable style="width: 100%;">
                            <el-option label="ÊôÆÈÄö‰ºöÂëò" :value="1"></el-option>
                            <el-option label="Èì∂Âç°‰ºöÂëò" :value="2"></el-option>
                            <el-option label="ÈáëÂç°‰ºöÂëò" :value="3"></el-option>
                            <el-option label="ÁôΩÈáë‰ºöÂëò" :value="4"></el-option>
                            <el-option label="ÈíªÁü≥‰ºöÂëò" :value="5"></el-option>
                        </el-select>
                    </el-form-item>

                    <el-form-item label="ÊâÄÈúÄÁßØÂàÜ" prop="points_required">
                        <el-input-number 
                            v-model="formData.points_required" 
                            :min="0"
                            placeholder="‰∏çÈúÄË¶Å"
                            style="width: 100%;">
                        </el-input-number>
                    </el-form-item>

                    <el-form-item label="ÁîüÊïàÊó•Êúü" prop="valid_from">
                        <el-date-picker
                            v-model="formData.valid_from"
                            type="datetime"
                            placeholder="‰∏çÈôê"
                            style="width: 100%;">
                        </el-date-picker>
                    </el-form-item>

                    <el-form-item label="Âà∞ÊúüÊó•Êúü" prop="valid_until">
                        <el-date-picker
                            v-model="formData.valid_until"
                            type="datetime"
                            placeholder="‰∏çÈôê"
                            style="width: 100%;">
                        </el-date-picker>
                    </el-form-item>

                    <el-form-item label="‰ºòÊÉ†ÊèèËø∞" prop="description">
                        <el-input
                            v-model="formData.description"
                            type="textarea"
                            :rows="3"
                            placeholder="ËØ∑ËæìÂÖ•‰ºòÊÉ†ÊèèËø∞">
                        </el-input>
                    </el-form-item>

                    <el-form-item label="ÊòØÂê¶ÂêØÁî®" prop="is_active">
                        <el-switch v-model="formData.is_active"></el-switch>
                    </el-form-item>
                </el-form>

                <template #footer>
                    <el-button @click="showDialog = false">ÂèñÊ∂à</el-button>
                    <el-button type="primary" @click="handleSubmit" :loading="submitting">Á°ÆÂÆö</el-button>
                </template>
            </el-dialog>
        </div>
    </div>

    <script>
        const { createApp, ref, reactive, onMounted } = Vue;

        const app = createApp({
            setup() {
                const loading = ref(false);
                const showDialog = ref(false);
                const isEditMode = ref(false);
                const submitting = ref(false);
                const formRef = ref(null);
                const discounts = ref([]);
                const editingId = ref(null);

                const apiBase = ref(window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
                    ? 'http://localhost:8007'
                    : '/api/enhanced');

                const filters = reactive({
                    is_active: null,
                    discount_type: null
                });

                const formData = reactive({
                    discount_type: 'percentage',
                    discount_value: 10,
                    min_amount: null,
                    max_discount: null,
                    member_level: null,
                    points_required: null,
                    valid_from: null,
                    valid_until: null,
                    description: '',
                    is_active: true
                });

                const formRules = {
                    discount_type: [{ required: true, message: 'ËØ∑ÈÄâÊã©‰ºòÊÉ†Á±ªÂûã', trigger: 'change' }],
                    discount_value: [{ required: true, message: 'ËØ∑ËæìÂÖ•‰ºòÊÉ†ÂÄº', trigger: 'blur' }]
                };

                // Âä†ËΩΩ‰ºòÊÉ†ÂàóË°®
                const loadDiscounts = async () => {
                    loading.value = true;
                    try {
                        let url = `${apiBase.value}/discount-config`;
                        const params = new URLSearchParams();
                        
                        if (filters.is_active !== null) {
                            params.append('is_active', filters.is_active);
                        }
                        if (filters.discount_type) {
                            // ÂâçÁ´ØËøáÊª§‰ºòÊÉ†Á±ªÂûã
                        }
                        
                        if (params.toString()) {
                            url += '?' + params.toString();
                        }
                        
                        const response = await fetch(url);
                        if (response.ok) {
                            let data = await response.json();
                            // ÂâçÁ´ØËøáÊª§‰ºòÊÉ†Á±ªÂûã
                            if (filters.discount_type) {
                                data = data.filter(d => d.discount_type === filters.discount_type);
                            }
                            discounts.value = data;
                        } else {
                            ElementPlus.ElMessage.error('Âä†ËΩΩ‰ºòÊÉ†ÈÖçÁΩÆÂ§±Ë¥•');
                        }
                    } catch (error) {
                        console.error('Âä†ËΩΩ‰ºòÊÉ†ÈÖçÁΩÆÂ§±Ë¥•:', error);
                        ElementPlus.ElMessage.error('Âä†ËΩΩ‰ºòÊÉ†ÈÖçÁΩÆÂ§±Ë¥•');
                    } finally {
                        loading.value = false;
                    }
                };

                // ÊòæÁ§∫ÂàõÂª∫ÂØπËØùÊ°Ü
                const showCreateDialog = () => {
                    isEditMode.value = false;
                    editingId.value = null;
                    Object.assign(formData, {
                        discount_type: 'percentage',
                        discount_value: 10,
                        min_amount: null,
                        max_discount: null,
                        member_level: null,
                        points_required: null,
                        valid_from: null,
                        valid_until: null,
                        description: '',
                        is_active: true
                    });
                    showDialog.value = true;
                };

                // ÊòæÁ§∫ÁºñËæëÂØπËØùÊ°Ü
                const showEditDialog = (discount) => {
                    isEditMode.value = true;
                    editingId.value = discount.id;
                    Object.assign(formData, {
                        discount_type: discount.discount_type,
                        discount_value: discount.discount_value,
                        min_amount: discount.min_amount,
                        max_discount: discount.max_discount,
                        member_level: discount.member_level,
                        points_required: discount.points_required,
                        valid_from: discount.valid_from ? new Date(discount.valid_from) : null,
                        valid_until: discount.valid_until ? new Date(discount.valid_until) : null,
                        description: discount.description || '',
                        is_active: discount.is_active
                    });
                    showDialog.value = true;
                };

                // Êèê‰∫§Ë°®Âçï
                const handleSubmit = async () => {
                    if (!formRef.value) return;
                    
                    try {
                        await formRef.value.validate();
                    } catch {
                        return;
                    }

                    submitting.value = true;
                    try {
                        const submitData = { ...formData };
                        
                        // Ê†ºÂºèÂåñÊó•Êúü
                        if (submitData.valid_from) {
                            submitData.valid_from = submitData.valid_from.toISOString();
                        }
                        if (submitData.valid_until) {
                            submitData.valid_until = submitData.valid_until.toISOString();
                        }
                        
                        // Ê∏ÖÁêÜÁ©∫ÂÄº
                        if (!submitData.min_amount) delete submitData.min_amount;
                        if (!submitData.max_discount) delete submitData.max_discount;
                        if (!submitData.member_level) delete submitData.member_level;
                        if (!submitData.points_required) delete submitData.points_required;
                        if (!submitData.valid_from) delete submitData.valid_from;
                        if (!submitData.valid_until) delete submitData.valid_until;
                        if (!submitData.description) delete submitData.description;

                        let url = `${apiBase.value}/discount-config`;
                        let method = 'POST';

                        if (isEditMode.value) {
                            url += `/${editingId.value}`;
                            method = 'PATCH';
                        }

                        const response = await fetch(url, {
                            method: method,
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(submitData)
                        });

                        if (response.ok) {
                            ElementPlus.ElMessage.success(isEditMode.value ? 'Êõ¥Êñ∞ÊàêÂäü' : 'ÂàõÂª∫ÊàêÂäü');
                            showDialog.value = false;
                            loadDiscounts();
                        } else {
                            const error = await response.json();
                            ElementPlus.ElMessage.error(error.detail || 'Êìç‰ΩúÂ§±Ë¥•');
                        }
                    } catch (error) {
                        console.error('Êèê‰∫§Â§±Ë¥•:', error);
                        ElementPlus.ElMessage.error('Êìç‰ΩúÂ§±Ë¥•');
                    } finally {
                        submitting.value = false;
                    }
                };

                // Á°ÆËÆ§Âà†Èô§
                const confirmDelete = (discount) => {
                    ElementPlus.ElMessageBox.confirm(
                        `Á°ÆÂÆöË¶ÅÂà†Èô§‰ºòÊÉ†"${discount.description || discount.discount_type}"ÂêóÔºü`,
                        'Á°ÆËÆ§Âà†Èô§',
                        {
                            confirmButtonText: 'Á°ÆÂÆö',
                            cancelButtonText: 'ÂèñÊ∂à',
                            type: 'warning'
                        }
                    ).then(async () => {
                        try {
                            const response = await fetch(`${apiBase.value}/discount-config/${discount.id}`, {
                                method: 'DELETE'
                            });

                            if (response.ok) {
                                ElementPlus.ElMessage.success('Âà†Èô§ÊàêÂäü');
                                loadDiscounts();
                            } else {
                                ElementPlus.ElMessage.error('Âà†Èô§Â§±Ë¥•');
                            }
                        } catch (error) {
                            console.error('Âà†Èô§Â§±Ë¥•:', error);
                            ElementPlus.ElMessage.error('Âà†Èô§Â§±Ë¥•');
                        }
                    }).catch(() => {});
                };

                // Ëé∑Âèñ‰ºòÊÉ†Á±ªÂûãÊñáÊú¨
                const getDiscountTypeText = (type) => {
                    const typeMap = {
                        'percentage': 'ÁôæÂàÜÊØîÊäòÊâ£',
                        'fixed': 'Âõ∫ÂÆöÈáëÈ¢ù',
                        'points': 'ÁßØÂàÜÊäµÊâ£'
                    };
                    return typeMap[type] || type;
                };

                // Ê†ºÂºèÂåñÊó•Êúü
                const formatDate = (dateStr) => {
                    if (!dateStr) return '‰∏çÈôê';
                    const date = new Date(dateStr);
                    return date.toLocaleDateString('zh-CN');
                };

                // È°µÈù¢Âä†ËΩΩ
                onMounted(() => {
                    loadDiscounts();
                });

                return {
                    loading,
                    showDialog,
                    isEditMode,
                    submitting,
                    formRef,
                    discounts,
                    filters,
                    formData,
                    formRules,
                    loadDiscounts,
                    showCreateDialog,
                    showEditDialog,
                    handleSubmit,
                    confirmDelete,
                    getDiscountTypeText,
                    formatDate
                };
            }
        });

        app.use(ElementPlus);
        app.mount('#app');
    </script>
</body>
</html>
