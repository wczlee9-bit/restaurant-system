<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‰ºòÊÉ†ÁÆ°ÁêÜ</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <script src="https://unpkg.com/element-plus/dist/index.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', Arial, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .discount-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        }
        .discount-type-tag {
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <div class="header">
                <h1>‰ºòÊÉ†ÁÆ°ÁêÜ</h1>
                <el-button type="primary" @click="showAddDialog">Ê∑ªÂä†‰ºòÊÉ†</el-button>
            </div>

            <div v-loading="loading">
                <div v-if="discounts.length === 0" style="text-align: center; padding: 60px; color: #999;">
                    <div style="font-size: 48px; margin-bottom: 20px;">üéÅ</div>
                    <p>ÊöÇÊó†‰ºòÊÉ†ÈÖçÁΩÆ</p>
                    <el-button type="primary" @click="showAddDialog" style="margin-top: 20px;">
                        Ê∑ªÂä†Á¨¨‰∏Ä‰∏™‰ºòÊÉ†
                    </el-button>
                </div>

                <div v-else>
                    <div class="discount-card" v-for="discount in discounts" :key="discount.id">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                    <el-tag 
                                        :type="discount.is_active ? 'success' : 'info'"
                                        size="large"
                                        class="discount-type-tag">
                                        {{ getDiscountTypeText(discount.discount_type) }}
                                    </el-tag>
                                    <span style="font-size: 20px; font-weight: bold;">
                                        {{ formatDiscountValue(discount) }}
                                    </span>
                                    <el-tag v-if="discount.member_level" type="warning" style="margin-left: 10px;">
                                        Lv.{{ discount.member_level }}‰ºöÂëò‰∏ì‰∫´
                                    </el-tag>
                                </div>
                                <p v-if="discount.description" style="color: #666; margin-bottom: 10px;">
                                    {{ discount.description }}
                                </p>
                                <div style="color: #999; font-size: 14px;">
                                    <span v-if="discount.min_amount">
                                        ÊúÄ‰ΩéÊ∂àË¥π: ¬•{{ discount.min_amount }} |
                                    </span>
                                    <span v-if="discount.max_discount">
                                        ÊúÄÂ§ß‰ºòÊÉ†: ¬•{{ discount.max_discount }} |
                                    </span>
                                    <span v-if="discount.points_required">
                                        ÈúÄÁßØÂàÜ: {{ discount.points_required }} |
                                    </span>
                                    <span v-if="discount.valid_from || discount.valid_until">
                                        ÊúâÊïàÊúü: {{ discount.valid_from ? formatDate(discount.valid_from) : 'ÂºÄÂßã' }} 
                                        ~ {{ discount.valid_until ? formatDate(discount.valid_until) : 'Ê∞∏‰πÖ' }}
                                    </span>
                                </div>
                            </div>
                            <div>
                                <el-button-group>
                                    <el-button size="small" @click="editDiscount(discount)">ÁºñËæë</el-button>
                                    <el-button 
                                        size="small" 
                                        :type="discount.is_active ? 'warning' : 'success'"
                                        @click="toggleStatus(discount)">
                                        {{ discount.is_active ? 'Á¶ÅÁî®' : 'ÂêØÁî®' }}
                                    </el-button>
                                    <el-button size="small" type="danger" @click="deleteDiscount(discount)">Âà†Èô§</el-button>
                                </el-button-group>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ê∑ªÂä†/ÁºñËæë‰ºòÊÉ†ÂØπËØùÊ°Ü -->
        <el-dialog
            v-model="dialogVisible"
            :title="isEdit ? 'ÁºñËæë‰ºòÊÉ†' : 'Ê∑ªÂä†‰ºòÊÉ†'"
            width="500px">
            <el-form :model="form" label-width="100px">
                <el-form-item label="‰ºòÊÉ†Á±ªÂûã" required>
                    <el-select v-model="form.discount_type" placeholder="ÈÄâÊã©‰ºòÊÉ†Á±ªÂûã">
                        <el-option label="ÁôæÂàÜÊØîÊäòÊâ£" value="percentage"></el-option>
                        <el-option label="Âõ∫ÂÆöÈáëÈ¢ù" value="fixed"></el-option>
                        <el-option label="ÁßØÂàÜÂÖëÊç¢" value="points"></el-option>
                    </el-select>
                </el-form-item>
                <el-form-item label="‰ºòÊÉ†ÂÄº" required>
                    <el-input-number 
                        v-model="form.discount_value" 
                        :min="0" 
                        :step="0.01"
                        :precision="form.discount_type === 'percentage' ? 0 : 2"
                        style="width: 100%;">
                    </el-input-number>
                    <span style="margin-left: 10px; color: #999;">
                        {{ form.discount_type === 'percentage' ? '%' : 'ÂÖÉ' }}
                    </span>
                </el-form-item>
                <el-form-item label="ÊúÄ‰ΩéÊ∂àË¥π">
                    <el-input-number 
                        v-model="form.min_amount" 
                        :min="0" 
                        :precision="2"
                        style="width: 100%;">
                    </el-input-number>
                </el-form-item>
                <el-form-item label="ÊúÄÂ§ß‰ºòÊÉ†">
                    <el-input-number 
                        v-model="form.max_discount" 
                        :min="0" 
                        :precision="2"
                        style="width: 100%;">
                    </el-input-number>
                </el-form-item>
                <el-form-item label="‰ºöÂëòÁ≠âÁ∫ß">
                    <el-select v-model="form.member_level" placeholder="‰∏çÈôêÂà∂" clearable>
                        <el-option label="‰∏çÈôêÂà∂" :value="null"></el-option>
                        <el-option label="1Á∫ß‰ºöÂëò" :value="1"></el-option>
                        <el-option label="2Á∫ß‰ºöÂëò" :value="2"></el-option>
                        <el-option label="3Á∫ß‰ºöÂëò" :value="3"></el-option>
                        <el-option label="4Á∫ß‰ºöÂëò" :value="4"></el-option>
                        <el-option label="5Á∫ß‰ºöÂëò" :value="5"></el-option>
                    </el-select>
                </el-form-item>
                <el-form-item label="ÊâÄÈúÄÁßØÂàÜ">
                    <el-input-number 
                        v-model="form.points_required" 
                        :min="0"
                        style="width: 100%;">
                    </el-input-number>
                </el-form-item>
                <el-form-item label="ÁîüÊïàÊó•Êúü">
                    <el-date-picker
                        v-model="form.valid_from"
                        type="datetime"
                        placeholder="ÈÄâÊã©ÁîüÊïàÊó•Êúü"
                        style="width: 100%;">
                    </el-date-picker>
                </el-form-item>
                <el-form-item label="Âà∞ÊúüÊó•Êúü">
                    <el-date-picker
                        v-model="form.valid_until"
                        type="datetime"
                        placeholder="ÈÄâÊã©Âà∞ÊúüÊó•Êúü"
                        style="width: 100%;">
                    </el-date-picker>
                </el-form-item>
                <el-form-item label="ÊèèËø∞">
                    <el-input 
                        v-model="form.description"
                        type="textarea"
                        :rows="3"
                        placeholder="ËØ∑ËæìÂÖ•‰ºòÊÉ†ÊèèËø∞">
                    </el-input>
                </el-form-item>
            </el-form>
            <template #footer>
                <el-button @click="dialogVisible = false">ÂèñÊ∂à</el-button>
                <el-button type="primary" @click="handleSubmit" :loading="submitting">Á°ÆÂÆö</el-button>
            </template>
        </el-dialog>
    </div>

    <script>
        const { createApp, ref, reactive, onMounted } = Vue;

        const app = createApp({
            setup() {
                const loading = ref(false);
                const dialogVisible = ref(false);
                const isEdit = ref(false);
                const submitting = ref(false);
                const discounts = ref([]);
                const editingId = ref(null);

                const apiBase = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
                    ? 'http://localhost:8007'
                    : '/api/enhanced';

                const form = reactive({
                    discount_type: 'percentage',
                    discount_value: 10,
                    min_amount: null,
                    max_discount: null,
                    member_level: null,
                    points_required: null,
                    valid_from: null,
                    valid_until: null,
                    description: '',
                    is_active: true
                });

                const loadDiscounts = async () => {
                    loading.value = true;
                    try {
                        const response = await fetch(`${apiBase}/discount-config`);
                        if (response.ok) {
                            discounts.value = await response.json();
                        }
                    } catch (error) {
                        console.error('Âä†ËΩΩ‰ºòÊÉ†Â§±Ë¥•:', error);
                        ElementPlus.ElMessage.error('Âä†ËΩΩ‰ºòÊÉ†Â§±Ë¥•');
                    } finally {
                        loading.value = false;
                    }
                };

                const showAddDialog = () => {
                    isEdit.value = false;
                    editingId.value = null;
                    Object.assign(form, {
                        discount_type: 'percentage',
                        discount_value: 10,
                        min_amount: null,
                        max_discount: null,
                        member_level: null,
                        points_required: null,
                        valid_from: null,
                        valid_until: null,
                        description: '',
                        is_active: true
                    });
                    dialogVisible.value = true;
                };

                const editDiscount = (discount) => {
                    isEdit.value = true;
                    editingId.value = discount.id;
                    Object.assign(form, discount);
                    dialogVisible.value = true;
                };

                const handleSubmit = async () => {
                    submitting.value = true;
                    try {
                        const data = {
                            ...form,
                            valid_from: form.valid_from ? form.valid_from.toISOString() : null,
                            valid_until: form.valid_until ? form.valid_until.toISOString() : null
                        };

                        if (isEdit.value) {
                            const response = await fetch(`${apiBase}/discount-config/${editingId.value}`, {
                                method: 'PATCH',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(data)
                            });
                            if (response.ok) {
                                ElementPlus.ElMessage.success('Êõ¥Êñ∞ÊàêÂäü');
                            } else {
                                throw new Error('Êõ¥Êñ∞Â§±Ë¥•');
                            }
                        } else {
                            const response = await fetch(`${apiBase}/discount-config`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(data)
                            });
                            if (response.ok) {
                                ElementPlus.ElMessage.success('Ê∑ªÂä†ÊàêÂäü');
                            } else {
                                throw new Error('Ê∑ªÂä†Â§±Ë¥•');
                            }
                        }

                        dialogVisible.value = false;
                        await loadDiscounts();
                    } catch (error) {
                        console.error('Êèê‰∫§Â§±Ë¥•:', error);
                        ElementPlus.ElMessage.error('Êìç‰ΩúÂ§±Ë¥•');
                    } finally {
                        submitting.value = false;
                    }
                };

                const toggleStatus = async (discount) => {
                    try {
                        const response = await fetch(`${apiBase}/discount-config/${discount.id}`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ is_active: !discount.is_active })
                        });
                        if (response.ok) {
                            ElementPlus.ElMessage.success(discount.is_active ? 'Â∑≤Á¶ÅÁî®' : 'Â∑≤ÂêØÁî®');
                            await loadDiscounts();
                        }
                    } catch (error) {
                        console.error('Êõ¥Êñ∞Áä∂ÊÄÅÂ§±Ë¥•:', error);
                        ElementPlus.ElMessage.error('Êìç‰ΩúÂ§±Ë¥•');
                    }
                };

                const deleteDiscount = async (discount) => {
                    try {
                        await ElementPlus.ElMessageBox.confirm(
                            `Á°ÆÂÆöË¶ÅÂà†Èô§‰ºòÊÉ†"${formatDiscountValue(discount)}"ÂêóÔºü`,
                            'Á°ÆËÆ§Âà†Èô§',
                            { type: 'warning' }
                        );

                        const response = await fetch(`${apiBase}/discount-config/${discount.id}`, {
                            method: 'DELETE'
                        });
                        if (response.ok) {
                            ElementPlus.ElMessage.success('Âà†Èô§ÊàêÂäü');
                            await loadDiscounts();
                        }
                    } catch (error) {
                        if (error !== 'cancel') {
                            console.error('Âà†Èô§Â§±Ë¥•:', error);
                            ElementPlus.ElMessage.error('Âà†Èô§Â§±Ë¥•');
                        }
                    }
                };

                const getDiscountTypeText = (type) => {
                    const map = {
                        'percentage': 'ÁôæÂàÜÊØî',
                        'fixed': 'Âõ∫ÂÆöÈáëÈ¢ù',
                        'points': 'ÁßØÂàÜÂÖëÊç¢'
                    };
                    return map[type] || type;
                };

                const formatDiscountValue = (discount) => {
                    if (discount.discount_type === 'percentage') {
                        return `${discount.discount_value}%`;
                    } else if (discount.discount_type === 'fixed') {
                        return `¬•${discount.discount_value}`;
                    } else {
                        return `${discount.discount_value}ÁßØÂàÜ`;
                    }
                };

                const formatDate = (dateStr) => {
                    const date = new Date(dateStr);
                    return date.toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                };

                onMounted(() => {
                    loadDiscounts();
                });

                return {
                    loading,
                    dialogVisible,
                    isEdit,
                    submitting,
                    discounts,
                    form,
                    loadDiscounts,
                    showAddDialog,
                    editDiscount,
                    handleSubmit,
                    toggleStatus,
                    deleteDiscount,
                    getDiscountTypeText,
                    formatDiscountValue,
                    formatDate
                };
            }
        });

        app.use(ElementPlus);
        app.mount('#app');
    </script>
</body>
</html>