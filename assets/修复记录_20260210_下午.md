# 修复记录 - 2026年2月10日（下午）

## 修复的问题

### 问题1：传菜员打印订单包含已取消的菜品 ✅

**问题描述：**
- 传菜员打印订单时，已取消的菜品（`item_status === 'cancelled'`）依然显示在小票上
- 导致传菜员可能传了不存在的菜品

**根本原因：**
- `printWaiterOrder` 函数遍历所有订单项，没有过滤 `cancelled` 状态的菜品

**修复方案：**
在打印订单时，只显示 `item_status !== 'cancelled'` 的菜品

**修改位置：**
- 文件：`assets/staff_workflow.html`
- 行号：1284-1291

**修改代码：**
```javascript
order.items.forEach(item => {
    // 过滤掉已取消的菜品，只打印需要传菜的菜品
    if (item.item_status !== 'cancelled') {
        html += `
            <div class="item">
                <div class="item-name">${item.menu_item_name}</div>
                <div class="item-qty">x${item.quantity}</div>
            </div>
        `;
    }
});
```

**影响：**
- 传菜员打印的小票只包含需要传菜的菜品
- 已取消的菜品不会显示在打印订单中

---

### 问题2：收银员看不到订单 ✅

**问题描述：**
- 收银员界面显示"暂无待支付订单"
- 收银员无法处理订单支付

**根本原因：**
- 收银员过滤逻辑中使用了后端不存在的状态值：
  - `o.status === 'serving'` - 后端没有此状态
  - `o.status === 'ready'` - 后端没有此状态
- 后端实际订单状态流程：
  - `pending` → `preparing` → `completed`
- 菜品状态流程：
  - `pending` → `preparing` → `ready` → `served` → `cancelled`

**修复方案：**
修改收银员订单过滤条件，使其与后端实际状态一致：
1. 显示状态为 `preparing` 的订单（制作中/上菜中）
2. 显示状态为 `completed` 但支付状态为 `unpaid` 的订单（已完成但未支付）

**修改位置：**
- 文件：`assets/staff_workflow.html`
- 行号：509-517

**修改前代码：**
```javascript
} else if (this.currentRole === 'cashier') {
    // 收银员看到待支付的订单
    // 1. 状态为'serving'的订单（上菜中）
    // 2. 状态为'ready'的订单（待传菜）
    // 3. 状态为'completed'但支付状态为'unpaid'的订单（已完成但未支付）
    result = result.filter(o => 
        o.status === 'serving' || 
        o.status === 'ready' ||
        (o.status === 'completed' && o.payment_status === 'unpaid')
    );
}
```

**修改后代码：**
```javascript
} else if (this.currentRole === 'cashier') {
    // 收银员看到待支付的订单
    // 1. 状态为'preparing'的订单（制作中，上菜后）
    // 2. 状态为'completed'但支付状态为'unpaid'的订单（已完成但未支付）
    result = result.filter(o => 
        o.status === 'preparing' || 
        (o.status === 'completed' && o.payment_status === 'unpaid')
    );
}
```

**影响：**
- 收银员可以看到所有待支付的订单
- 可以正常处理支付流程

---

## 测试建议

### 测试场景1：传菜员打印订单
1. 创建订单
2. 厨师取消部分菜品
3. 传菜员打印订单
4. 验证：打印的订单不包含已取消的菜品

### 测试场景2：收银员查看订单
1. 创建订单并完成所有菜品制作
2. 订单状态变为 `completed`，支付状态为 `unpaid`
3. 收银员切换角色查看订单列表
4. 验证：可以看到该订单并处理支付

---

## 文件信息

**修改文件：**
- `assets/staff_workflow.html`
- 文件大小：66KB
- 修改时间：2026-02-10 21:26

**需要同步的文件：**
1. `assets/staff_workflow.html` → `/var/www/restaurant-system/frontend/staff_workflow.html`

---

## 部署步骤

### 1. 在服务器上拉取最新代码
```bash
cd /var/www/restaurant-system
git pull origin main
```

### 2. 复制文件到Nginx目录
```bash
cp assets/staff_workflow.html /var/www/restaurant-system/frontend/staff_workflow.html
```

### 3. 重启Nginx（如果需要）
```bash
sudo systemctl reload nginx
```

### 4. 强制刷新浏览器
- 按 `Ctrl + Shift + R` 或 `Cmd + Shift + R` 清除缓存

---

## 后续优化建议

### 1. 订单状态统一
- 建议明确前端和后端的订单状态定义
- 在文档中说明订单状态流转逻辑
- 避免使用不存在的状态值

### 2. 状态映射
- 考虑在后端添加状态映射层
- 确保前端和后端使用一致的状态值
- 添加状态转换的验证逻辑

### 3. 单元测试
- 为过滤逻辑添加单元测试
- 测试各种订单状态组合
- 确保不同角色看到正确的订单列表

---

**修复时间**：2026年2月10日 21:26
**修复人**：Coze Coding
**状态**：已完成，待部署验证
