# 腾讯服务器更新指南

## 更新概述

本次更新包含两个主要功能：
1. **移除pending状态**：订单创建时直接进入制作流程
2. **添加菜品取消功能**：厨师可以取消缺货菜品，系统自动重新计算金额

## 修改的文件

```
src/api/restaurant_api.py           # 后端API（订单创建、状态流转、金额计算）
assets/staff_workflow.html           # 工作人员端UI（取消按钮、通知功能）
frontend/customer/order/order-detail.html  # 顾客端（显示已取消菜品）
assets/update_pending_orders.sql     # 数据库更新脚本
```

---

## 更新步骤（按顺序执行）

### 1. 进入项目目录

```bash
cd /var/www/restaurant-system
```

### 2. 查看当前状态

```bash
# 查看当前分支
git branch

# 查看远程更新
git fetch origin

# 查看差异（可选）
git log origin/main..HEAD --oneline
```

### 3. 拉取最新代码

```bash
# 拉取最新代码
git pull origin main

# 验证文件是否更新
ls -lh assets/staff_workflow.html src/api/restaurant_api.py
```

### 4. 执行数据库更新脚本

```bash
# 执行SQL脚本，将pending状态的订单和订单项改为preparing
sudo -u postgres psql -d restaurant_system < assets/update_pending_orders.sql
```

### 5. 验证数据库更新

```bash
# 查看订单状态分布
sudo -u postgres psql -d restaurant_system -c "SELECT order_status, COUNT(*) FROM orders GROUP BY order_status;"

# 查看订单项状态分布
sudo -u postgres psql -d restaurant_system -c "SELECT status, COUNT(*) FROM order_items GROUP BY status;"
```

### 6. 重启后端服务

```bash
# 查找并停止当前服务
ps aux | grep "uvicorn.*restaurant_api"
pkill -f "uvicorn.*restaurant_api"

# 确认服务已停止
ps aux | grep "uvicorn.*restaurant_api"

# 启动新服务
cd /var/www/restaurant-system
nohup python3 -m uvicorn src.api.restaurant_api:app --host 0.0.0.0 --port 8000 > /var/log/restaurant_api.log 2>&1 &

# 确认服务已启动
ps aux | grep "uvicorn.*restaurant_api" | grep -v grep

# 查看服务日志（检查是否有错误）
tail -f /var/log/restaurant_api.log
```

按 `Ctrl+C` 退出日志查看。

### 7. 测试后端API

```bash
# 测试API是否正常
curl http://localhost:8000/api/ | python3 -m json.tool

# 查看订单列表
curl http://localhost:8000/api/orders/ | python3 -m json.tool | head -30
```

### 8. 清理浏览器缓存

**重要**：前端HTML文件更新后，需要强制刷新浏览器缓存：

- **Windows**: `Ctrl + F5`
- **Mac**: `Cmd + Shift + R`

---

## 功能验证

### 验证1：订单创建（移除pending状态）

1. 打开顾客端，创建一个新订单
2. 订单状态应该是 `preparing`（制作中）
3. 订单项状态应该是 `preparing`（制作中）

### 验证2：厨师取消菜品

1. 切换到厨师角色
2. 找到一个制作中的订单
3. 点击"❌ 缺货取消"按钮
4. 确认取消
5. 菜品状态变为 `cancelled`（已取消）
6. 订单金额自动重新计算（排除取消的菜品）

### 验证3：传菜员通知

1. 切换到传菜员角色
2. 找到有取消菜品的订单
3. 看到"⚠️ 已取消菜品"按钮
4. 点击按钮，查看已取消的菜品列表
5. 点击"已通知"

### 验证4：顾客端显示

1. 切换到顾客角色
2. 查看订单详情
3. 已取消的菜品显示为灰色，带删除线
4. 状态显示"已取消（缺货）"

### 验证5：收银员收费

1. 传菜完成所有可传菜品后，订单状态变为 `completed`
2. 收银员可以看到订单
3. 订单金额是最终金额（排除取消的菜品）
4. 进行支付，支付成功

---

## 回滚方案（如果出现问题）

如果更新后出现问题，可以回滚到上一个版本：

```bash
# 查看提交历史
git log --oneline -10

# 回滚到上一个版本（假设上一个版本是 dd5d3e4）
git reset --hard dd5d3e4

# 重启服务
pkill -f "uvicorn.*restaurant_api"
nohup python3 -m uvicorn src.api.restaurant_api:app --host 0.0.0.0 --port 8000 > /var/log/restaurant_api.log 2>&1 &
```

---

## 注意事项

1. **数据库更新**：SQL脚本只更新 `pending` 状态，不会影响其他订单
2. **现有功能**：所有已测试的功能保持不变
3. **浏览器缓存**：更新后需要强制刷新浏览器缓存
4. **后端服务**：必须重启才能生效
5. **测试环境**：建议先在测试环境验证后再应用到生产环境

---

## 技术支持

如果遇到问题，请查看：

1. **后端日志**：`/var/log/restaurant_api.log`
2. **Nginx日志**：`/var/log/nginx/error.log`
3. **数据库日志**：`/var/log/postgresql/postgresql-14-main.log`

---

更新时间：2026-02-10
