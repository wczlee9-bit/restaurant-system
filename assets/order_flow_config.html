<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¢å•æµç¨‹é…ç½® - æ‰«ç ç‚¹é¤ç³»ç»Ÿ</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <script src="https://unpkg.com/element-plus/dist/index.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', Arial, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            font-size: 24px;
        }
        .back-btn {
            color: white;
            text-decoration: none;
            font-size: 16px;
        }
        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }
        .tabs {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .tab-content {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        }
        .section-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .role-card {
            border: 1px solid #e4e7ed;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background: #fafafa;
        }
        .role-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .role-name {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        .role-description {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }
        .action-mode-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
        }
        .badge-per-item {
            background: #e6f7ff;
            color: #1890ff;
            border: 1px solid #91d5ff;
        }
        .badge-per-order {
            background: #f6ffed;
            color: #52c41a;
            border: 1px solid #b7eb8f;
        }
        .badge-skip {
            background: #fff7e6;
            color: #fa8c16;
            border: 1px solid #ffd591;
        }
        .badge-ignore {
            background: #f5f5f5;
            color: #8c8c8c;
            border: 1px solid #d9d9d9;
        }
        .info-card {
            background: #f0f9ff;
            border-left: 4px solid #1890ff;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .info-card h4 {
            color: #1890ff;
            margin-bottom: 10px;
        }
        .info-card p {
            color: #666;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="header">
            <div>
                <h1>è®¢å•æµç¨‹é…ç½®</h1>
                <p>çµæ´»é…ç½®è§’è‰²å’Œè®¢å•æµç¨‹ï¼Œæ”¯æŒè‡ªå®šä¹‰è§’è‰²å’ŒåŠŸèƒ½åˆ†é…</p>
            </div>
            <a href="shop_settings.html" class="back-btn">â† è¿”å›åº—é“ºè®¾ç½®</a>
        </div>

        <div class="container">
            <div class="tabs">
                <el-tabs v-model="activeTab" type="border-card">
                    <el-tab-pane label="è§’è‰²ç®¡ç†" name="roles">
                        <template #label>
                            <span>ğŸ‘¥ è§’è‰²ç®¡ç†</span>
                        </template>
                    </el-tab-pane>
                    <el-tab-pane label="æµç¨‹é…ç½®" name="flow">
                        <template #label>
                            <span>âš™ï¸ æµç¨‹é…ç½®</span>
                        </template>
                    </el-tab-pane>
                </el-tabs>
            </div>

            <!-- è§’è‰²ç®¡ç† -->
            <div class="tab-content" v-show="activeTab === 'roles'">
                <div class="section-title">
                    <span>è§’è‰²åˆ—è¡¨</span>
                    <el-button type="primary" @click="showAddRoleDialog">+ æ–°å¢è§’è‰²</el-button>
                </div>

                <div class="info-card">
                    <h4>ğŸ’¡ è§’è‰²ç®¡ç†è¯´æ˜</h4>
                    <p>â€¢ æ”¯æŒè‡ªå®šä¹‰åˆ›å»ºè§’è‰²ï¼Œæ¯ä¸ªåº—é“ºå¯ä»¥æœ‰ç‹¬ç«‹çš„è§’è‰²é…ç½®</p>
                    <p>â€¢ è§’è‰²å¯ä»¥åˆ†é…ä¸åŒçš„è®¢å•æµç¨‹åŠŸèƒ½ï¼ˆå¦‚ï¼šä¼ èœåŠŸèƒ½å¯ä»¥åˆ†é…ç»™æ”¶é“¶å‘˜ï¼‰</p>
                    <p>â€¢ å¯ä»¥å¯ç”¨/ç¦ç”¨è§’è‰²ï¼Œä¸ä½¿ç”¨çš„è§’è‰²å¯ä»¥ç¦ç”¨è€Œä¸åˆ é™¤</p>
                </div>

                <div class="role-card" v-for="role in roles" :key="role.id">
                    <div class="role-header">
                        <div>
                            <div class="role-name">{{ role.è§’è‰²åç§° }}</div>
                            <div class="role-description">{{ role.è§’è‰²æè¿° || 'æš‚æ— æè¿°' }}</div>
                        </div>
                        <div>
                            <el-tag :type="role.æ˜¯å¦å¯ç”¨ ? 'success' : 'info'" style="margin-right: 10px;">
                                {{ role.æ˜¯å¦å¯ç”¨ ? 'å¯ç”¨' : 'ç¦ç”¨' }}
                            </el-tag>
                            <el-button size="small" @click="editRole(role)">ç¼–è¾‘</el-button>
                            <el-button size="small" type="danger" @click="deleteRole(role.id)">åˆ é™¤</el-button>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <el-tag size="small">æ’åº: {{ role.æ’åº }}</el-tag>
                        <el-tag size="small" type="info">ID: {{ role.id }}</el-tag>
                    </div>
                </div>
            </div>

            <!-- æµç¨‹é…ç½® -->
            <div class="tab-content" v-show="activeTab === 'flow'">
                <div class="section-title">
                    <span>è®¢å•æµç¨‹é…ç½®</span>
                    <div>
                        <el-button @click="resetToDefault" type="warning">é‡ç½®ä¸ºé»˜è®¤</el-button>
                        <el-button type="primary" @click="saveFlowConfigs" :loading="saving">ä¿å­˜é…ç½®</el-button>
                    </div>
                </div>

                <div class="info-card">
                    <h4>ğŸ’¡ é…ç½®è¯´æ˜</h4>
                    <p>â€¢ <strong>æ“ä½œæ–¹å¼</strong>ï¼šé€é¡¹ç¡®è®¤ï¼ˆæ¯é“èœå•ç‹¬ç¡®è®¤ï¼‰ã€è®¢å•ç¡®è®¤ï¼ˆæ•´ä¸ªè®¢å•ä¸€èµ·ç¡®è®¤ï¼‰ã€è‡ªåŠ¨è·³è¿‡ï¼ˆè¯¥è§’è‰²ä¸éœ€è¦å¤„ç†æ­¤çŠ¶æ€ï¼‰ã€å¿½ç•¥ä¸æ˜¾ç¤ºï¼ˆå¯ä»¥çœ‹åˆ°ä½†ä¸éœ€è¦æ“ä½œï¼‰</p>
                    <p>â€¢ <strong>çµæ´»åˆ†é…</strong>ï¼šä¼ èœå‘˜è§’è‰²å¯ä»¥ä¸é…ç½®ï¼Œä¼ èœåŠŸèƒ½å¯ä»¥åˆ†é…ç»™æ”¶é“¶å‘˜</p>
                    <p>â€¢ <strong>å¤šè§’è‰²é…ç½®</strong>ï¼šä¸€ä¸ªè®¢å•çŠ¶æ€å¯ä»¥åˆ†é…ç»™å¤šä¸ªè§’è‰²ï¼Œæ¯ä¸ªè§’è‰²å¯ä»¥æœ‰ä¸åŒçš„æ“ä½œæ–¹å¼</p>
                </div>

                <el-alert
                    title="é…ç½®ç¤ºä¾‹"
                    type="success"
                    description="ä¾‹å¦‚ï¼šå¦‚æœä¸ä½¿ç”¨ä¼ èœå‘˜è§’è‰²ï¼Œå¯ä»¥å°†'å¾…ä¼ èœ'å’Œ'ä¸Šèœä¸­'çŠ¶æ€çš„'è‡ªåŠ¨è·³è¿‡'æˆ–åˆ†é…ç»™æ”¶é“¶å‘˜ã€‚"
                    :closable="false"
                    style="margin-bottom: 20px;">
                </el-alert>

                <div v-for="(roleConfigs, roleName) in groupedFlowConfigs" :key="roleName" class="role-card">
                    <div class="role-header">
                        <div class="role-name">{{ roleName }}</div>
                        <el-tag :type="isRoleEnabled(roleName) ? 'success' : 'info'" size="small">
                            {{ isRoleEnabled(roleName) ? 'å¯ç”¨' : 'ç¦ç”¨' }}
                        </el-tag>
                    </div>

                    <el-table :data="roleConfigs" style="width: 100%; background: white;">
                        <el-table-column prop="è®¢å•çŠ¶æ€" label="è®¢å•çŠ¶æ€" width="150"></el-table-column>
                        <el-table-column label="æ“ä½œæ–¹å¼" width="250">
                            <template #default="scope">
                                <el-select v-model="scope.row.æ“ä½œæ–¹å¼" placeholder="è¯·é€‰æ‹©" style="width: 100%;">
                                    <el-option label="é€é¡¹ç¡®è®¤" value="é€é¡¹ç¡®è®¤"></el-option>
                                    <el-option label="è®¢å•ç¡®è®¤" value="è®¢å•ç¡®è®¤"></el-option>
                                    <el-option label="è‡ªåŠ¨è·³è¿‡" value="è‡ªåŠ¨è·³è¿‡"></el-option>
                                    <el-option label="å¿½ç•¥ä¸æ˜¾ç¤º" value="å¿½ç•¥ä¸æ˜¾ç¤º"></el-option>
                                </el-select>
                            </template>
                        </el-table-column>
                        <el-table-column label="æ˜¯å¦å¯ç”¨" width="100">
                            <template #default="scope">
                                <el-switch v-model="scope.row.æ˜¯å¦å¯ç”¨"></el-switch>
                            </template>
                        </el-table-column>
                        <el-table-column label="è¯´æ˜">
                            <template #default="scope">
                                <el-tag :class="getActionModeClass(scope.row.æ“ä½œæ–¹å¼)" class="action-mode-badge">
                                    {{ getActionModeDescription(scope.row.æ“ä½œæ–¹å¼) }}
                                </el-tag>
                            </template>
                        </el-table-column>
                    </el-table>
                </div>
            </div>
        </div>

        <!-- æ·»åŠ /ç¼–è¾‘è§’è‰²å¯¹è¯æ¡† -->
        <el-dialog
            v-model="showRoleDialog"
            :title="editingRole ? 'ç¼–è¾‘è§’è‰²' : 'æ–°å¢è§’è‰²'"
            width="500px">
            <el-form :model="roleForm" label-width="100px">
                <el-form-item label="è§’è‰²åç§°">
                    <el-input v-model="roleForm.è§’è‰²åç§°" placeholder="è¯·è¾“å…¥è§’è‰²åç§°"></el-input>
                </el-form-item>
                <el-form-item label="è§’è‰²æè¿°">
                    <el-input v-model="roleForm.è§’è‰²æè¿°" type="textarea" :rows="3" placeholder="è¯·è¾“å…¥è§’è‰²æè¿°"></el-input>
                </el-form-item>
                <el-form-item label="æ˜¯å¦å¯ç”¨">
                    <el-switch v-model="roleForm.æ˜¯å¦å¯ç”¨"></el-switch>
                </el-form-item>
                <el-form-item label="æ’åº">
                    <el-input-number v-model="roleForm.æ’åº" :min="0"></el-input-number>
                </el-form-item>
            </el-form>
            <template #footer>
                <el-button @click="showRoleDialog = false">å–æ¶ˆ</el-button>
                <el-button type="primary" @click="saveRole" :loading="saving">ç¡®å®š</el-button>
            </template>
        </el-dialog>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        createApp({
            setup() {
                const activeTab = ref('roles');
                const storeId = 1; // é»˜è®¤åº—é“ºID
                const roles = ref([]);
                const flowConfigs = ref([]);
                const groupedFlowConfigs = ref({});
                const saving = ref(false);
                const showRoleDialog = ref(false);
                const editingRole = ref(null);
                const roleForm = ref({
                    è§’è‰²åç§°: '',
                    è§’è‰²æè¿°: '',
                    æ˜¯å¦å¯ç”¨: true,
                    æ’åº: 0
                });

                const API_BASE = 'http://localhost:8000';

                // åŠ è½½è§’è‰²åˆ—è¡¨
                const loadRoles = async () => {
                    try {
                        const response = await fetch(`${API_BASE}/order-flow/stores/${storeId}/roles`);
                        roles.value = await response.json();
                    } catch (error) {
                        console.error('åŠ è½½è§’è‰²åˆ—è¡¨å¤±è´¥:', error);
                        ElementPlus.ElMessage.error('åŠ è½½è§’è‰²åˆ—è¡¨å¤±è´¥');
                    }
                };

                // åŠ è½½æµç¨‹é…ç½®
                const loadFlowConfigs = async () => {
                    try {
                        const response = await fetch(`${API_BASE}/order-flow/stores/${storeId}/flow-configs/grouped`);
                        groupedFlowConfigs.value = await response.json();
                        
                        // å±•å¹³ä¸ºåˆ—è¡¨æ–¹ä¾¿æ“ä½œ
                        flowConfigs.value = [];
                        Object.keys(groupedFlowConfigs.value).forEach(roleName => {
                            groupedFlowConfigs.value[roleName].forEach(config => {
                                flowConfigs.value.push(config);
                            });
                        });
                    } catch (error) {
                        console.error('åŠ è½½æµç¨‹é…ç½®å¤±è´¥:', error);
                        ElementPlus.ElMessage.error('åŠ è½½æµç¨‹é…ç½®å¤±è´¥');
                    }
                };

                // æ˜¾ç¤ºæ·»åŠ è§’è‰²å¯¹è¯æ¡†
                const showAddRoleDialog = () => {
                    editingRole.value = null;
                    roleForm.value = {
                        è§’è‰²åç§°: '',
                        è§’è‰²æè¿°: '',
                        æ˜¯å¦å¯ç”¨: true,
                        æ’åº: roles.value.length
                    };
                    showRoleDialog.value = true;
                };

                // ç¼–è¾‘è§’è‰²
                const editRole = (role) => {
                    editingRole.value = role;
                    roleForm.value = {
                        è§’è‰²åç§°: role.è§’è‰²åç§°,
                        è§’è‰²æè¿°: role.è§’è‰²æè¿°,
                        æ˜¯å¦å¯ç”¨: role.æ˜¯å¦å¯ç”¨,
                        æ’åº: role.æ’åº
                    };
                    showRoleDialog.value = true;
                };

                // ä¿å­˜è§’è‰²
                const saveRole = async () => {
                    saving.value = true;
                    try {
                        const url = editingRole.value
                            ? `${API_BASE}/order-flow/stores/${storeId}/roles/${editingRole.value.id}`
                            : `${API_BASE}/order-flow/stores/${storeId}/roles`;
                        
                        const method = editingRole.value ? 'PUT' : 'POST';
                        const response = await fetch(url, {
                            method: method,
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(roleForm.value)
                        });

                        if (response.ok) {
                            ElementPlus.ElMessage.success(editingRole.value ? 'è§’è‰²æ›´æ–°æˆåŠŸ' : 'è§’è‰²åˆ›å»ºæˆåŠŸ');
                            showRoleDialog.value = false;
                            await loadRoles();
                            await loadFlowConfigs();
                        } else {
                            const error = await response.json();
                            ElementPlus.ElMessage.error(error.detail || 'æ“ä½œå¤±è´¥');
                        }
                    } catch (error) {
                        console.error('ä¿å­˜è§’è‰²å¤±è´¥:', error);
                        ElementPlus.ElMessage.error('ä¿å­˜è§’è‰²å¤±è´¥');
                    } finally {
                        saving.value = false;
                    }
                };

                // åˆ é™¤è§’è‰²
                const deleteRole = async (roleId) => {
                    try {
                        await ElementPlus.ElMessageBox.confirm(
                            'åˆ é™¤è§’è‰²å°†åŒæ—¶åˆ é™¤è¯¥è§’è‰²çš„æ‰€æœ‰æµç¨‹é…ç½®ï¼Œç¡®å®šè¦åˆ é™¤å—ï¼Ÿ',
                            'ç¡®è®¤åˆ é™¤',
                            { type: 'warning' }
                        );

                        const response = await fetch(`${API_BASE}/order-flow/stores/${storeId}/roles/${roleId}`, {
                            method: 'DELETE'
                        });

                        if (response.ok) {
                            ElementPlus.ElMessage.success('è§’è‰²åˆ é™¤æˆåŠŸ');
                            await loadRoles();
                            await loadFlowConfigs();
                        } else {
                            ElementPlus.ElMessage.error('åˆ é™¤å¤±è´¥');
                        }
                    } catch (error) {
                        if (error !== 'cancel') {
                            console.error('åˆ é™¤è§’è‰²å¤±è´¥:', error);
                            ElementPlus.ElMessage.error('åˆ é™¤è§’è‰²å¤±è´¥');
                        }
                    }
                };

                // ä¿å­˜æµç¨‹é…ç½®
                const saveFlowConfigs = async () => {
                    saving.value = true;
                    try {
                        // å±•å¹³æ‰€æœ‰é…ç½®
                        const configsToUpdate = [];
                        Object.keys(groupedFlowConfigs.value).forEach(roleName => {
                            groupedFlowConfigs.value[roleName].forEach(config => {
                                configsToUpdate.push({
                                    id: config.id,
                                    ...config
                                });
                            });
                        });

                        const response = await fetch(`${API_BASE}/order-flow/stores/${storeId}/flow-configs/batch`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(configsToUpdate)
                        });

                        if (response.ok) {
                            ElementPlus.ElMessage.success('æµç¨‹é…ç½®ä¿å­˜æˆåŠŸ');
                        } else {
                            ElementPlus.ElMessage.error('ä¿å­˜å¤±è´¥');
                        }
                    } catch (error) {
                        console.error('ä¿å­˜æµç¨‹é…ç½®å¤±è´¥:', error);
                        ElementPlus.ElMessage.error('ä¿å­˜æµç¨‹é…ç½®å¤±è´¥');
                    } finally {
                        saving.value = false;
                    }
                };

                // é‡ç½®ä¸ºé»˜è®¤é…ç½®
                const resetToDefault = async () => {
                    try {
                        await ElementPlus.ElMessageBox.confirm(
                            'ç¡®å®šè¦é‡ç½®ä¸ºé»˜è®¤é…ç½®å—ï¼Ÿè¿™å°†è¦†ç›–æ‰€æœ‰è‡ªå®šä¹‰é…ç½®ã€‚',
                            'ç¡®è®¤é‡ç½®',
                            { type: 'warning' }
                        );

                        const response = await fetch(`${API_BASE}/order-flow/stores/${storeId}/reset`, {
                            method: 'POST'
                        });

                        if (response.ok) {
                            ElementPlus.ElMessage.success('å·²é‡ç½®ä¸ºé»˜è®¤é…ç½®');
                            await loadFlowConfigs();
                        } else {
                            ElementPlus.ElMessage.error('é‡ç½®å¤±è´¥');
                        }
                    } catch (error) {
                        if (error !== 'cancel') {
                            console.error('é‡ç½®é…ç½®å¤±è´¥:', error);
                            ElementPlus.ElMessage.error('é‡ç½®é…ç½®å¤±è´¥');
                        }
                    }
                };

                // åˆ¤æ–­è§’è‰²æ˜¯å¦å¯ç”¨
                const isRoleEnabled = (roleName) => {
                    const role = roles.value.find(r => r.è§’è‰²åç§° === roleName);
                    return role ? role.æ˜¯å¦å¯ç”¨ : false;
                };

                // è·å–æ“ä½œæ–¹å¼æè¿°
                const getActionModeDescription = (mode) => {
                    const descriptions = {
                        'é€é¡¹ç¡®è®¤': 'æ¯é“èœå•ç‹¬ç¡®è®¤',
                        'è®¢å•ç¡®è®¤': 'æ•´ä¸ªè®¢å•ä¸€èµ·ç¡®è®¤',
                        'è‡ªåŠ¨è·³è¿‡': 'è¯¥è§’è‰²ä¸éœ€è¦å¤„ç†æ­¤çŠ¶æ€',
                        'å¿½ç•¥ä¸æ˜¾ç¤º': 'å¯ä»¥çœ‹åˆ°ä½†ä¸éœ€è¦æ“ä½œ'
                    };
                    return descriptions[mode] || mode;
                };

                // è·å–æ“ä½œæ–¹å¼æ ·å¼ç±»
                const getActionModeClass = (mode) => {
                    const classes = {
                        'é€é¡¹ç¡®è®¤': 'badge-per-item',
                        'è®¢å•ç¡®è®¤': 'badge-per-order',
                        'è‡ªåŠ¨è·³è¿‡': 'badge-skip',
                        'å¿½ç•¥ä¸æ˜¾ç¤º': 'badge-ignore'
                    };
                    return classes[mode] || '';
                };

                onMounted(() => {
                    loadRoles();
                    loadFlowConfigs();
                });

                return {
                    activeTab,
                    roles,
                    flowConfigs,
                    groupedFlowConfigs,
                    saving,
                    showRoleDialog,
                    editingRole,
                    roleForm,
                    showAddRoleDialog,
                    editRole,
                    saveRole,
                    deleteRole,
                    saveFlowConfigs,
                    resetToDefault,
                    isRoleEnabled,
                    getActionModeDescription,
                    getActionModeClass
                };
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>
