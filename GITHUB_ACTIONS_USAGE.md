# GitHub Actions è‡ªåŠ¨éƒ¨ç½²ä½¿ç”¨æŒ‡å—

æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»å¦‚ä½•ä½¿ç”¨ GitHub Actions å®ç°è‡ªåŠ¨éƒ¨ç½²åˆ°æœåŠ¡å™¨ã€‚

## ğŸ“– ç›®å½•

- [æ¦‚è¿°](#æ¦‚è¿°)
- [å·¥ä½œåŸç†](#å·¥ä½œåŸç†)
- [é¦–æ¬¡é…ç½®](#é¦–æ¬¡é…ç½®)
- [æ—¥å¸¸ä½¿ç”¨](#æ—¥å¸¸ä½¿ç”¨)
- [ç›‘æ§å’Œè°ƒè¯•](#ç›‘æ§å’Œè°ƒè¯•)
- [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

## æ¦‚è¿°

GitHub Actions è‡ªåŠ¨éƒ¨ç½²ç³»ç»Ÿä¼šåœ¨ä»¥ä¸‹æƒ…å†µè‡ªåŠ¨è§¦å‘éƒ¨ç½²ï¼š

1. **ä»£ç æ¨é€åˆ° main åˆ†æ”¯**ï¼šè‡ªåŠ¨è§¦å‘éƒ¨ç½²
2. **æ‰‹åŠ¨è§¦å‘**ï¼šåœ¨ GitHub ç½‘é¡µä¸Šæ‰‹åŠ¨è§¦å‘éƒ¨ç½²

éƒ¨ç½²æµç¨‹åŒ…æ‹¬ï¼š
- æ‹‰å–æœ€æ–°ä»£ç 
- æ›´æ–° Python ä¾èµ–
- é‡å¯æ‰€æœ‰ API æœåŠ¡
- éªŒè¯æœåŠ¡è¿è¡ŒçŠ¶æ€

## å·¥ä½œåŸç†

### éƒ¨ç½²æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¨é€ä»£ç åˆ°     â”‚
â”‚  main åˆ†æ”¯      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GitHub Actions â”‚
â”‚  è§¦å‘å·¥ä½œæµ     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é€šè¿‡ SSH è¿æ¥  â”‚
â”‚  åˆ°æœåŠ¡å™¨       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ‰§è¡Œè‡ªåŠ¨éƒ¨ç½²   â”‚
â”‚  è„šæœ¬           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ‹‰å–æœ€æ–°ä»£ç    â”‚
â”‚  æ›´æ–°ä¾èµ–       â”‚
â”‚  é‡å¯æœåŠ¡       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  éªŒè¯æœåŠ¡çŠ¶æ€   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  éƒ¨ç½²å®Œæˆ       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å·¥ä½œæµæ–‡ä»¶

å·¥ä½œæµé…ç½®æ–‡ä»¶ä½äº `.github/workflows/deploy.yml`ï¼Œå®šä¹‰äº†éƒ¨ç½²çš„æ•´ä¸ªæµç¨‹ã€‚

**è§¦å‘æ¡ä»¶ï¼š**
```yaml
on:
  push:
    branches:
      - main
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
```

**ä¸»è¦æ­¥éª¤ï¼š**
1. æ£€å‡ºä»£ç 
2. é…ç½® SSH è¿æ¥
3. æ‰§è¡Œéƒ¨ç½²è„šæœ¬
4. éªŒè¯éƒ¨ç½²ç»“æœ

## é¦–æ¬¡é…ç½®

### å‰ç½®æ¡ä»¶

1. âœ… æœåŠ¡å™¨å·²é…ç½®å¥½è¿è¡Œç¯å¢ƒ
2. âœ… æœåŠ¡å™¨ä¸Šå·²å…‹éš†ä»£ç ä»“åº“
3. âœ… å·²é…ç½® GitHub Secretsï¼ˆå‚è€ƒ [GITHUB_SECRETS_SETUP.md](GITHUB_SECRETS_SETUP.md)ï¼‰

### é…ç½®æ­¥éª¤

#### 1. åˆå§‹åŒ–æœåŠ¡å™¨ç¯å¢ƒ

åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼š

```bash
# 1. å…‹éš†ä»£ç ä»“åº“ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
git clone <ä½ çš„ä»“åº“åœ°å€> /workspace/projects
cd /workspace/projects

# 2. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python3 -m venv venv
source venv/bin/activate

# 3. å®‰è£…ä¾èµ–
pip install -r requirements.txt

# 4. åˆå§‹åŒ–æ•°æ®åº“ï¼ˆå¦‚æœéœ€è¦ï¼‰
python -c "from src.database import init_db; init_db()"

# 5. é…ç½®ç¯å¢ƒå˜é‡ï¼ˆå¤åˆ¶ .env.example ä¸º .env å¹¶ä¿®æ”¹ï¼‰
cp .env.example .env
vi .env  # æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹é…ç½®

# 6. å¯åŠ¨æœåŠ¡ï¼ˆæµ‹è¯•æ˜¯å¦æ­£å¸¸ï¼‰
bash scripts/auto_deploy.sh
```

#### 2. é…ç½® GitHub Secrets

å‚è€ƒ [GITHUB_SECRETS_SETUP.md](GITHUB_SECRETS_SETUP.md) å®Œæˆä»¥ä¸‹ Secrets çš„é…ç½®ï¼š

- `SSH_PRIVATE_KEY`: æœåŠ¡å™¨çš„ SSH ç§é’¥
- `SERVER_USER`: SSH ç”¨æˆ·åï¼ˆå¦‚ `root`ï¼‰
- `SERVER_HOST`: æœåŠ¡å™¨ IP åœ°å€ï¼ˆå¦‚ `115.191.1.219`ï¼‰

#### 3. éªŒè¯é…ç½®

1. åœ¨ GitHub ä¸Šè¿›å…¥ **Actions** æ ‡ç­¾
2. ç‚¹å‡»å·¦ä¾§çš„ **"ğŸš€ Auto Deploy to Server"** å·¥ä½œæµ
3. ç‚¹å‡» **"Run workflow"** æŒ‰é’®
4. é€‰æ‹© `main` åˆ†æ”¯ï¼Œç‚¹å‡» **"Run workflow"**
5. è§‚å¯Ÿå·¥ä½œæµæ‰§è¡ŒçŠ¶æ€

## æ—¥å¸¸ä½¿ç”¨

### è‡ªåŠ¨éƒ¨ç½²ï¼ˆæ¨èï¼‰

**æœ€ç®€å•çš„æ–¹å¼ï¼š**

```bash
# 1. æäº¤ä»£ç 
git add .
git commit -m "æè¿°ä½ çš„æ›´æ”¹"
git push origin main
```

æ¨é€åï¼ŒGitHub Actions ä¼šè‡ªåŠ¨è§¦å‘éƒ¨ç½²æµç¨‹ï¼Œæ— éœ€ä»»ä½•é¢å¤–æ“ä½œã€‚

### æ‰‹åŠ¨è§¦å‘éƒ¨ç½²

å¦‚æœä½ æƒ³æ‰‹åŠ¨è§¦å‘éƒ¨ç½²ï¼ˆä¸æ¨é€æ–°ä»£ç ï¼‰ï¼š

1. æ‰“å¼€ GitHub ä»“åº“
2. è¿›å…¥ **Actions** æ ‡ç­¾
3. é€‰æ‹© **"ğŸš€ Auto Deploy to Server"** å·¥ä½œæµ
4. ç‚¹å‡»å³ä¾§çš„ **"Run workflow"** æŒ‰é’®
5. é€‰æ‹© `main` åˆ†æ”¯ï¼Œç‚¹å‡»ç»¿è‰²çš„ **"Run workflow"** æŒ‰é’®

### æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€

#### æ–¹æ³• 1: GitHub ç½‘é¡µ

1. è¿›å…¥ GitHub ä»“åº“
2. ç‚¹å‡»é¡¶éƒ¨çš„ **Actions** æ ‡ç­¾
3. å¯ä»¥çœ‹åˆ°æ‰€æœ‰å·¥ä½œæµçš„æ‰§è¡Œè®°å½•
4. ç‚¹å‡»å…·ä½“çš„å·¥ä½œæµå¯ä»¥æŸ¥çœ‹è¯¦ç»†æ—¥å¿—

#### æ–¹æ³• 2: æ£€æŸ¥æœåŠ¡å™¨æœåŠ¡çŠ¶æ€

åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼š

```bash
# æ£€æŸ¥æ‰€æœ‰æœåŠ¡çŠ¶æ€
systemctl status restaurant-api
systemctl status restaurant-enhanced-api
systemctl status member-api
systemctl status headquarters-api
systemctl status settlement-api
systemctl status websocket-api

# æˆ–è€…ä½¿ç”¨ç»Ÿä¸€çš„æ£€æŸ¥è„šæœ¬
bash scripts/verify_system.sh
```

## ç›‘æ§å’Œè°ƒè¯•

### æŸ¥çœ‹éƒ¨ç½²æ—¥å¿—

#### GitHub Actions æ—¥å¿—

1. è¿›å…¥ GitHub ä»“åº“
2. ç‚¹å‡» **Actions** æ ‡ç­¾
3. ç‚¹å‡»å…·ä½“çš„å·¥ä½œæµè¿è¡Œè®°å½•
4. ç‚¹å‡»æ¯ä¸ªæ­¥éª¤æŸ¥çœ‹è¯¦ç»†æ—¥å¿—

#### æœåŠ¡å™¨æœåŠ¡æ—¥å¿—

åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼š

```bash
# æŸ¥çœ‹é¤å… API æ—¥å¿—
tail -f /workspace/projects/logs/api.log

# æŸ¥çœ‹å¢å¼º API æ—¥å¿—
tail -f /workspace/projects/logs/enhanced_api.log

# æŸ¥çœ‹ä¼šå‘˜ API æ—¥å¿—
tail -f /workspace/projects/logs/member_api.log

# æŸ¥çœ‹ systemd æœåŠ¡æ—¥å¿—
journalctl -u restaurant-api -f
```

### å¸¸è§é—®é¢˜è¯Šæ–­

#### é—®é¢˜ 1: éƒ¨ç½²æˆåŠŸä½†æœåŠ¡æœªå¯åŠ¨

**è¯Šæ–­æ­¥éª¤ï¼š**

```bash
# 1. æ£€æŸ¥æœåŠ¡çŠ¶æ€
systemctl status restaurant-api

# 2. æŸ¥çœ‹æœåŠ¡æ—¥å¿—
journalctl -u restaurant-api -n 50

# 3. æ£€æŸ¥ç«¯å£å ç”¨
lsof -i :8000

# 4. æ‰‹åŠ¨å¯åŠ¨æœåŠ¡æŸ¥çœ‹é”™è¯¯
cd /workspace/projects
source venv/bin/activate
python -m uvicorn src.api.restaurant_api:app --host 0.0.0.0 --port 8000
```

#### é—®é¢˜ 2: éƒ¨ç½²å¤±è´¥ï¼ŒSSH è¿æ¥é”™è¯¯

**è¯Šæ–­æ­¥éª¤ï¼š**

1. æ£€æŸ¥ GitHub Secrets æ˜¯å¦é…ç½®æ­£ç¡®
2. ç¡®è®¤æœåŠ¡å™¨çš„ SSH æœåŠ¡æ˜¯å¦è¿è¡Œï¼š`systemctl status sshd`
3. æµ‹è¯• SSH è¿æ¥ï¼š
   ```bash
   ssh -i ~/.ssh/github_actions root@115.191.1.219 "echo 'SSH è¿æ¥æˆåŠŸ'"
   ```
4. æ£€æŸ¥æœåŠ¡å™¨é˜²ç«å¢™è§„åˆ™

#### é—®é¢˜ 3: ä¾èµ–å®‰è£…å¤±è´¥

**è¯Šæ–­æ­¥éª¤ï¼š**

```bash
# 1. æ£€æŸ¥ Python ç‰ˆæœ¬
python3 --version  # éœ€è¦ Python 3.8+

# 2. æ‰‹åŠ¨å®‰è£…ä¾èµ–
cd /workspace/projects
source venv/bin/activate
pip install -r requirements.txt

# 3. æŸ¥çœ‹è¯¦ç»†çš„å®‰è£…æ—¥å¿—
pip install -r requirements.txt -v
```

## æ•…éšœæ’æŸ¥

### å¸¸è§é”™è¯¯ä»£ç 

| é”™è¯¯ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|----------|
| `Permission denied (publickey)` | SSH å¯†é’¥é…ç½®é”™è¯¯ | é‡æ–°é…ç½® GitHub Secrets ä¸­çš„ SSH_PRIVATE_KEY |
| `Host key verification failed` | æœåŠ¡å™¨ä¸»æœºå¯†é’¥æœªéªŒè¯ | åœ¨å·¥ä½œæµä¸­æ·»åŠ  `ssh-keyscan` æˆ–ç¦ç”¨ä¸¥æ ¼æ£€æŸ¥ |
| `Port 8000 already in use` | ç«¯å£è¢«å ç”¨ | æŸ¥æ‰¾å¹¶åœæ­¢å ç”¨ç«¯å£çš„è¿›ç¨‹ |
| `Module not found` | Python ä¾èµ–æœªå®‰è£… | æ£€æŸ¥ requirements.txt å¹¶é‡æ–°å®‰è£…ä¾èµ– |
| `Database connection failed` | æ•°æ®åº“é…ç½®é”™è¯¯ | æ£€æŸ¥ .env æ–‡ä»¶ä¸­çš„æ•°æ®åº“é…ç½® |

### åº”æ€¥æ¢å¤æ–¹æ¡ˆ

å¦‚æœéƒ¨ç½²å¯¼è‡´æœåŠ¡ä¸å¯ç”¨ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹åº”æ€¥æ–¹æ¡ˆï¼š

#### æ–¹æ¡ˆ 1: æ‰‹åŠ¨å›æ»šä»£ç 

```bash
# åœ¨æœåŠ¡å™¨ä¸Š
cd /workspace/projects
git log --oneline  # æŸ¥çœ‹æäº¤å†å²
git reset --hard <ä¸Šä¸€ä¸ªç¨³å®šçš„æäº¤ç‰ˆæœ¬å·>
bash scripts/auto_deploy.sh
```

#### æ–¹æ¡ˆ 2: æ¢å¤å¤‡ä»½

```bash
# éƒ¨ç½²è„šæœ¬ä¼šè‡ªåŠ¨å¤‡ä»½åˆ° .backup ç›®å½•
cd /workspace/projects/.backup
ls -lt  # åˆ—å‡ºæ‰€æœ‰å¤‡ä»½
# é€‰æ‹©æœ€è¿‘çš„å¤‡ä»½æ¢å¤
cp <å¤‡ä»½æ–‡ä»¶> /workspace/projects/
```

#### æ–¹æ¡ˆ 3: å¿«é€Ÿé‡å¯æœåŠ¡

```bash
# å¦‚æœä»£ç æ²¡æœ‰é—®é¢˜ï¼Œåªæ˜¯æœåŠ¡å¼‚å¸¸
systemctl restart restaurant-api
systemctl restart restaurant-enhanced-api
systemctl restart member-api
systemctl restart headquarters-api
systemctl restart settlement-api
systemctl restart websocket-api
```

## æœ€ä½³å®è·µ

### 1. åˆ†æ”¯ç®¡ç†

- **main åˆ†æ”¯**: ç”Ÿäº§ç¯å¢ƒä»£ç ï¼Œç›´æ¥è§¦å‘è‡ªåŠ¨éƒ¨ç½²
- **develop åˆ†æ”¯**: å¼€å‘ç¯å¢ƒä»£ç ï¼Œä¸è§¦å‘è‡ªåŠ¨éƒ¨ç½²
- **feature åˆ†æ”¯**: åŠŸèƒ½å¼€å‘åˆ†æ”¯ï¼Œä» develop åˆ†æ”¯åˆ›å»º

å»ºè®®å·¥ä½œæµï¼š
```bash
# å¼€å‘æ–°åŠŸèƒ½
git checkout -b feature/new-feature
# ... å¼€å‘ ...
git add .
git commit -m "feat: æ·»åŠ æ–°åŠŸèƒ½"
git push origin feature/new-feature

# åˆå¹¶åˆ° develop
git checkout develop
git merge feature/new-feature
git push origin develop

# æµ‹è¯•é€šè¿‡åï¼Œåˆå¹¶åˆ° mainï¼ˆè§¦å‘éƒ¨ç½²ï¼‰
git checkout main
git merge develop
git push origin main  # è§¦å‘è‡ªåŠ¨éƒ¨ç½²
```

### 2. æäº¤ä¿¡æ¯è§„èŒƒ

ä½¿ç”¨æ¸…æ™°çš„æäº¤ä¿¡æ¯ï¼Œæ–¹ä¾¿è¿½æº¯éƒ¨ç½²å†å²ï¼š

```bash
feat: æ·»åŠ ä¼šå‘˜äºŒç»´ç ç”ŸæˆåŠŸèƒ½
fix: ä¿®å¤è®¢å•çŠ¶æ€æ›´æ–°å¤±è´¥é—®é¢˜
refactor: é‡æ„æ•°æ®åº“è¿æ¥æ± 
docs: æ›´æ–°éƒ¨ç½²æ–‡æ¡£
chore: æ›´æ–°ä¾èµ–ç‰ˆæœ¬
```

### 3. æµ‹è¯•å…ˆè¡Œ

åœ¨æ¨é€åˆ° main åˆ†æ”¯å‰ï¼Œç¡®ä¿ï¼š

1. âœ… æœ¬åœ°æµ‹è¯•é€šè¿‡
2. âœ… æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡
3. âœ… ä»£ç å®¡æŸ¥å®Œæˆ
4. âœ… æ–‡æ¡£å·²æ›´æ–°

### 4. ç›‘æ§éƒ¨ç½²

å»ºè®®è®¾ç½®ä»¥ä¸‹ç›‘æ§ï¼š

- **GitHub Actions é€šçŸ¥**: åœ¨å·¥ä½œæµå¤±è´¥æ—¶å‘é€é‚®ä»¶é€šçŸ¥
- **æœåŠ¡å™¨å¥åº·æ£€æŸ¥**: å®šæœŸæ£€æŸ¥æœåŠ¡è¿è¡ŒçŠ¶æ€
- **åº”ç”¨ç›‘æ§**: ä½¿ç”¨ APM å·¥å…·ç›‘æ§åº”ç”¨æ€§èƒ½

### 5. å®‰å…¨æ€§

- å®šæœŸè½®æ¢ SSH å¯†é’¥ï¼ˆæ¯ 3-6 ä¸ªæœˆï¼‰
- ä½¿ç”¨å¼ºå¯†ç å’Œå¤æ‚çš„ SSH å¯†é’¥
- é™åˆ¶æœåŠ¡å™¨çš„ SSH è®¿é—® IP
- å®šæœŸæ›´æ–°ç³»ç»Ÿå’Œä¾èµ–åŒ…

### 6. å¤‡ä»½ç­–ç•¥

è‡ªåŠ¨éƒ¨ç½²è„šæœ¬å·²ç»é›†æˆäº†ä»¥ä¸‹å¤‡ä»½æœºåˆ¶ï¼š

- é…ç½®æ–‡ä»¶è‡ªåŠ¨å¤‡ä»½ï¼ˆ.env, agent_llm_config.jsonï¼‰
- æŒ‰æ—¶é—´æˆ³å‘½åå¤‡ä»½ç›®å½•
- éƒ¨ç½²å‰è‡ªåŠ¨å¤‡ä»½ï¼Œéƒ¨ç½²åè‡ªåŠ¨æ¢å¤é…ç½®

å»ºè®®é¢å¤–è®¾ç½®ï¼š

- æ•°æ®åº“å®šæœŸå¤‡ä»½
- ä»£ç ä»“åº“å®šæœŸå¤‡ä»½
- æ—¥å¿—æ–‡ä»¶å®šæœŸå½’æ¡£

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [GitHub Secrets é…ç½®æŒ‡å—](GITHUB_SECRETS_SETUP.md)
- [ç³»ç»Ÿéƒ¨ç½²æ–‡æ¡£](COMMERCIAL_DEPLOYMENT.md)
- [å¿«é€Ÿå¼€å§‹æŒ‡å—](QUICK_START.md)
- [æ•…éšœæ’æŸ¥æŒ‡å—](TROUBLESHOOTING.md)

---

**å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ GitHub Actions æ—¥å¿—æˆ–è”ç³»æŠ€æœ¯æ”¯æŒã€‚**
