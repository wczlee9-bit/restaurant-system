<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾å‘³é¤å… - è®¢å•ç®¡ç†</title>
    <link rel="stylesheet" href="../../common/css/style.css">
    <style>
        body {
            display: flex;
            min-height: 100vh;
        }
        
        .sidebar {
            width: 250px;
            background: #2c3e50;
            color: white;
            padding: 20px 0;
            flex-shrink: 0;
        }
        
        .sidebar-title {
            font-size: 20px;
            font-weight: bold;
            padding: 0 20px 20px;
            border-bottom: 1px solid #3d566e;
        }
        
        .sidebar-menu {
            margin-top: 20px;
        }
        
        .sidebar-item {
            padding: 15px 20px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .sidebar-item:hover, .sidebar-item.active {
            background: #34495e;
        }
        
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .filters {
            display: flex;
            gap: 10px;
        }
        
        .filters select, .filters input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .orders-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .orders-table th, .orders-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .orders-table th {
            background: #f5f5f5;
            font-weight: bold;
        }
        
        .orders-table tr:hover {
            background: #f9f9f9;
        }
        
        .order-status {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .status-pending { background: #fff3cd; color: #856404; }
        .status-confirmed { background: #d1ecf1; color: #0c5460; }
        .status-completed { background: #d4edda; color: #155724; }
        .status-cancelled { background: #f8d7da; color: #721c24; }
        
        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }
        
        .order-detail {
            display: none;
            background: #f9f9f9;
            padding: 15px;
        }
        
        .order-detail.active {
            display: block;
        }
        
        .order-items-list {
            margin: 10px 0;
        }
        
        .order-items-list li {
            padding: 5px 0;
            border-bottom: 1px dashed #ddd;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-title">ğŸ½ï¸ ç¾å‘³é¤å…</div>
        <div class="sidebar-menu">
            <div class="sidebar-item" onclick="window.location.href='../dashboard/index.html'">
                ğŸ“Š ä»ªè¡¨ç›˜
            </div>
            <div class="sidebar-item" onclick="window.location.href='../dishes/index.html'">
                ğŸœ èœå“ç®¡ç†
            </div>
            <div class="sidebar-item active">
                ğŸ“‹ è®¢å•ç®¡ç†
            </div>
            <div class="sidebar-item" onclick="window.location.href='../members/index.html'">
                ğŸ‘¥ ä¼šå‘˜ç®¡ç†
            </div>
        </div>
    </div>
    
    <div class="main-content">
        <div class="toolbar">
            <h2>è®¢å•ç®¡ç†</h2>
            <div class="filters">
                <select id="status-filter" onchange="filterOrders()">
                    <option value="">å…¨éƒ¨çŠ¶æ€</option>
                    <option value="pending">å¾…ç¡®è®¤</option>
                    <option value="confirmed">å·²ç¡®è®¤</option>
                    <option value="completed">å·²å®Œæˆ</option>
                    <option value="cancelled">å·²å–æ¶ˆ</option>
                </select>
                <input type="text" id="search-input" placeholder="æœç´¢è®¢å•å·..." onkeyup="filterOrders()">
            </div>
        </div>
        
        <table class="orders-table">
            <thead>
                <tr>
                    <th>è®¢å•å·</th>
                    <th>é¤æ¡Œ</th>
                    <th>é‡‘é¢</th>
                    <th>çŠ¶æ€</th>
                    <th>åˆ›å»ºæ—¶é—´</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="orders-list"></tbody>
        </table>
    </div>
    
    <script src="../../common/js/api.js"></script>
    <script>
        let orders = [];
        
        // åŠ è½½è®¢å•
        async function loadOrders() {
            const container = document.getElementById('orders-list');
            container.innerHTML = '<tr><td colspan="6" class="loading">åŠ è½½ä¸­...</td></tr>';
            
            try {
                const data = await apiRequest('/api/orders/');
                orders = data.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                renderOrders();
            } catch (error) {
                container.innerHTML = '<tr><td colspan="6" class="error">åŠ è½½è®¢å•å¤±è´¥</td></tr>';
            }
        }
        
        // æ¸²æŸ“è®¢å•
        function renderOrders(ordersToRender = orders) {
            const container = document.getElementById('orders-list');
            
            if (ordersToRender.length === 0) {
                container.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;">æš‚æ— è®¢å•</td></tr>';
                return;
            }
            
            container.innerHTML = ordersToRender.map(order => `
                <tr>
                    <td>
                        <strong>${order.order_number}</strong>
                        <div class="order-detail" id="detail-${order.id}">
                            <strong>è®¢å•æ˜ç»†ï¼š</strong>
                            <ul class="order-items-list">
                                ${order.items.map(item => `
                                    <li>${item.menu_item_name} x${item.quantity} = Â¥${(item.price * item.quantity).toFixed(2)}</li>
                                `).join('')}
                            </ul>
                        </div>
                    </td>
                    <td>${order.table_number}</td>
                    <td><strong>Â¥${order.total_amount.toFixed(2)}</strong></td>
                    <td>
                        <span class="order-status status-${order.status}">
                            ${getStatusText(order.status)}
                        </span>
                    </td>
                    <td>${formatTime(order.created_at)}</td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="toggleDetail(${order.id})">è¯¦æƒ…</button>
                        ${order.status === 'pending' ? `
                            <button class="btn btn-sm btn-success" onclick="updateStatus(${order.id}, 'confirmed')">ç¡®è®¤</button>
                        ` : ''}
                        ${order.status === 'confirmed' ? `
                            <button class="btn btn-sm btn-primary" onclick="updateStatus(${order.id}, 'completed')">å®Œæˆ</button>
                        ` : ''}
                    </td>
                </tr>
            `).join('');
        }
        
        // è·å–çŠ¶æ€æ–‡æœ¬
        function getStatusText(status) {
            const statusMap = {
                'pending': 'å¾…ç¡®è®¤',
                'confirmed': 'å·²ç¡®è®¤',
                'completed': 'å·²å®Œæˆ',
                'cancelled': 'å·²å–æ¶ˆ'
            };
            return statusMap[status] || status;
        }
        
        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(timeStr) {
            const date = new Date(timeStr);
            return date.toLocaleString('zh-CN', {
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // åˆ‡æ¢è¯¦æƒ…æ˜¾ç¤º
        function toggleDetail(orderId) {
            const detail = document.getElementById(`detail-${orderId}`);
            detail.classList.toggle('active');
        }
        
        // è¿‡æ»¤è®¢å•
        function filterOrders() {
            const status = document.getElementById('status-filter').value;
            const keyword = document.getElementById('search-input').value.toLowerCase();
            
            let filtered = orders;
            
            if (status) {
                filtered = filtered.filter(o => o.status === status);
            }
            
            if (keyword) {
                filtered = filtered.filter(o => o.order_number.toLowerCase().includes(keyword));
            }
            
            renderOrders(filtered);
        }
        
        // æ›´æ–°çŠ¶æ€
        async function updateStatus(orderId, newStatus) {
            try {
                await apiRequest(`/api/orders/${orderId}/status`, {
                    method: 'PATCH',
                    body: JSON.stringify({ status: newStatus })
                });
                
                showMessage('çŠ¶æ€æ›´æ–°æˆåŠŸ', 'success');
                loadOrders();
            } catch (error) {
                showMessage('çŠ¶æ€æ›´æ–°å¤±è´¥', 'error');
            }
        }
        
        // åˆå§‹åŒ–
        loadOrders();
    </script>
</body>
</html>
