<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾å‘³é¤å… - ä¼šå‘˜ç®¡ç†</title>
    <link rel="stylesheet" href="../../common/css/style.css">
    <style>
        body {
            display: flex;
            min-height: 100vh;
        }
        
        .sidebar {
            width: 250px;
            background: #2c3e50;
            color: white;
            padding: 20px 0;
            flex-shrink: 0;
        }
        
        .sidebar-title {
            font-size: 20px;
            font-weight: bold;
            padding: 0 20px 20px;
            border-bottom: 1px solid #3d566e;
        }
        
        .sidebar-menu {
            margin-top: 20px;
        }
        
        .sidebar-item {
            padding: 15px 20px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .sidebar-item:hover, .sidebar-item.active {
            background: #34495e;
        }
        
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .search-box {
            display: flex;
            gap: 10px;
        }
        
        .search-box input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 300px;
        }
        
        .members-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .members-table th, .members-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .members-table th {
            background: #f5f5f5;
            font-weight: bold;
        }
        
        .members-table tr:hover {
            background: #f9f9f9;
        }
        
        .level-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            background: #ffc107;
            color: #333;
        }
        
        .points {
            color: #ff6b35;
            font-weight: bold;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            width: 500px;
            max-width: 90%;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: bold;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .form-actions button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #ff6b35;
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-title">ğŸ½ï¸ ç¾å‘³é¤å…</div>
        <div class="sidebar-menu">
            <div class="sidebar-item" onclick="window.location.href='../dashboard/index.html'">
                ğŸ“Š ä»ªè¡¨ç›˜
            </div>
            <div class="sidebar-item" onclick="window.location.href='../dishes/index.html'">
                ğŸœ èœå“ç®¡ç†
            </div>
            <div class="sidebar-item" onclick="window.location.href='../orders/index.html'">
                ğŸ“‹ è®¢å•ç®¡ç†
            </div>
            <div class="sidebar-item active">
                ğŸ‘¥ ä¼šå‘˜ç®¡ç†
            </div>
        </div>
    </div>
    
    <div class="main-content">
        <div class="toolbar">
            <h2>ä¼šå‘˜ç®¡ç†</h2>
            <div class="search-box">
                <input type="text" id="search-input" placeholder="æœç´¢æ‰‹æœºå·..." onkeyup="searchMembers()">
                <button class="btn btn-primary" onclick="openAddModal()">+ æ³¨å†Œä¼šå‘˜</button>
            </div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="total-members">0</div>
                <div class="stat-label">ä¼šå‘˜æ€»æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-points">0</div>
                <div class="stat-label">æ€»ç§¯åˆ†</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="new-today">0</div>
                <div class="stat-label">ä»Šæ—¥æ–°å¢</div>
            </div>
        </div>
        
        <table class="members-table">
            <thead>
                <tr>
                    <th>ä¼šå‘˜ID</th>
                    <th>æ‰‹æœºå·</th>
                    <th>ä¼šå‘˜ç­‰çº§</th>
                    <th>ç§¯åˆ†</th>
                    <th>æ³¨å†Œæ—¶é—´</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="members-list"></tbody>
        </table>
    </div>
    
    <!-- æ·»åŠ ä¼šå‘˜æ¨¡æ€æ¡† -->
    <div class="modal" id="member-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modal-title">æ³¨å†Œä¼šå‘˜</div>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <form id="member-form">
                <div class="form-group">
                    <label>æ‰‹æœºå·</label>
                    <input type="tel" id="member-phone" required pattern="[0-9]{11}" placeholder="è¯·è¾“å…¥11ä½æ‰‹æœºå·">
                </div>
                <div class="form-group">
                    <label>ä¼šå‘˜ç­‰çº§</label>
                    <select id="member-level" required>
                        <option value="">è¯·é€‰æ‹©ç­‰çº§</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">æ³¨å†Œ</button>
                </div>
            </form>
        </div>
    </div>
    
    <script src="../../common/js/api.js"></script>
    <script>
        let members = [];
        let levels = [];
        
        // åŠ è½½ä¼šå‘˜ç­‰çº§
        async function loadLevels() {
            try {
                const data = await apiRequest('/api/member/levels');
                levels = data;
                renderLevelOptions();
            } catch (error) {
                console.error('åŠ è½½ä¼šå‘˜ç­‰çº§å¤±è´¥:', error);
            }
        }
        
        // æ¸²æŸ“ç­‰çº§é€‰é¡¹
        function renderLevelOptions() {
            const select = document.getElementById('member-level');
            select.innerHTML = '<option value="">è¯·é€‰æ‹©ç­‰çº§</option>' + 
                levels.map(l => `<option value="${l.id}">${l.name} (æŠ˜æ‰£: ${l.discount * 100}%)</option>`).join('');
        }
        
        // åŠ è½½ä¼šå‘˜
        async function loadMembers() {
            const container = document.getElementById('members-list');
            container.innerHTML = '<tr><td colspan="6" class="loading">åŠ è½½ä¸­...</td></tr>';
            
            try {
                // æš‚æ—¶åªåŠ è½½ä¸€ä¸ªæµ‹è¯•ä¼šå‘˜
                const data = await apiRequest('/api/member/1');
                members = [data];
                renderMembers();
                updateStats();
            } catch (error) {
                container.innerHTML = '<tr><td colspan="6" class="error">åŠ è½½ä¼šå‘˜å¤±è´¥</td></tr>';
            }
        }
        
        // æ¸²æŸ“ä¼šå‘˜
        function renderMembers(membersToRender = members) {
            const container = document.getElementById('members-list');
            
            if (membersToRender.length === 0) {
                container.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;">æš‚æ— ä¼šå‘˜</td></tr>';
                return;
            }
            
            container.innerHTML = membersToRender.map(member => `
                <tr>
                    <td>${member.id}</td>
                    <td>${member.phone}</td>
                    <td>
                        <span class="level-badge">${member.level_name || 'æ™®é€šä¼šå‘˜'}</span>
                    </td>
                    <td class="points">${member.points}</td>
                    <td>${formatTime(member.created_at)}</td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="showDetail(${member.id})">è¯¦æƒ…</button>
                        <button class="btn btn-sm btn-success" onclick="addPoints(${member.id})">å……å€¼</button>
                    </td>
                </tr>
            `).join('');
        }
        
        // æ›´æ–°ç»Ÿè®¡
        function updateStats() {
            document.getElementById('total-members').textContent = members.length;
            document.getElementById('total-points').textContent = members.reduce((sum, m) => sum + m.points, 0);
            document.getElementById('new-today').textContent = '0';
        }
        
        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(timeStr) {
            const date = new Date(timeStr);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }
        
        // æœç´¢ä¼šå‘˜
        function searchMembers() {
            const keyword = document.getElementById('search-input').value;
            // TODO: å®ç°æœç´¢åŠŸèƒ½
        }
        
        // æ‰“å¼€æ·»åŠ æ¨¡æ€æ¡†
        function openAddModal() {
            document.getElementById('modal-title').textContent = 'æ³¨å†Œä¼šå‘˜';
            document.getElementById('member-form').reset();
            document.getElementById('member-modal').classList.add('active');
        }
        
        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('member-modal').classList.remove('active');
        }
        
        // æ³¨å†Œä¼šå‘˜
        async function registerMember(e) {
            e.preventDefault();
            
            const phone = document.getElementById('member-phone').value;
            const levelId = parseInt(document.getElementById('member-level').value);
            
            try {
                await apiRequest('/api/restaurant/register-member', {
                    method: 'POST',
                    body: JSON.stringify({ phone, level_id: levelId })
                });
                
                showMessage('æ³¨å†ŒæˆåŠŸ', 'success');
                closeModal();
                loadMembers();
            } catch (error) {
                showMessage('æ³¨å†Œå¤±è´¥', 'error');
            }
        }
        
        // æ˜¾ç¤ºè¯¦æƒ…
        function showDetail(memberId) {
            const member = members.find(m => m.id === memberId);
            alert(`ä¼šå‘˜ä¿¡æ¯\n\næ‰‹æœºå·: ${member.phone}\nç­‰çº§: ${member.level_name}\nç§¯åˆ†: ${member.points}\næŠ˜æ‰£: ${(member.discount * 100).toFixed(0)}%`);
        }
        
        // å……å€¼ç§¯åˆ†
        function addPoints(memberId) {
            const points = prompt('è¯·è¾“å…¥å……å€¼ç§¯åˆ†æ•°ï¼š');
            if (!points) return;
            
            const pointsNum = parseInt(points);
            if (isNaN(pointsNum) || pointsNum <= 0) {
                showMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„ç§¯åˆ†å€¼', 'error');
                return;
            }
            
            // TODO: è°ƒç”¨å……å€¼ç§¯åˆ† API
            showMessage('å……å€¼æˆåŠŸ', 'success');
            loadMembers();
        }
        
        // è¡¨å•æäº¤
        document.getElementById('member-form').addEventListener('submit', registerMember);
        
        // åˆå§‹åŒ–
        loadLevels();
        loadMembers();
    </script>
</body>
</html>
