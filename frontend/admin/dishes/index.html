<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾å‘³é¤å… - èœå“ç®¡ç†</title>
    <link rel="stylesheet" href="../../common/css/style.css">
    <style>
        body {
            display: flex;
            min-height: 100vh;
        }
        
        .sidebar {
            width: 250px;
            background: #2c3e50;
            color: white;
            padding: 20px 0;
            flex-shrink: 0;
        }
        
        .sidebar-title {
            font-size: 20px;
            font-weight: bold;
            padding: 0 20px 20px;
            border-bottom: 1px solid #3d566e;
        }
        
        .sidebar-menu {
            margin-top: 20px;
        }
        
        .sidebar-item {
            padding: 15px 20px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .sidebar-item:hover, .sidebar-item.active {
            background: #34495e;
        }
        
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .search-box {
            display: flex;
            gap: 10px;
        }
        
        .search-box input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 300px;
        }
        
        .dishes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }
        
        .dish-card {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .dish-image {
            width: 100%;
            height: 180px;
            background: #eee;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 40px;
        }
        
        .dish-info {
            padding: 15px;
        }
        
        .dish-name {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 8px;
        }
        
        .dish-price {
            color: #ff6b35;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .dish-category {
            display: inline-block;
            background: #e9ecef;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            margin-bottom: 10px;
        }
        
        .dish-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .dish-actions button {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            width: 500px;
            max-width: 90%;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: bold;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        .form-group textarea {
            height: 100px;
            resize: vertical;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .form-actions button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-title">ğŸ½ï¸ ç¾å‘³é¤å…</div>
        <div class="sidebar-menu">
            <div class="sidebar-item" onclick="window.location.href='../dashboard/index.html'">
                ğŸ“Š ä»ªè¡¨ç›˜
            </div>
            <div class="sidebar-item active">
                ğŸœ èœå“ç®¡ç†
            </div>
            <div class="sidebar-item" onclick="window.location.href='../orders/index.html'">
                ğŸ“‹ è®¢å•ç®¡ç†
            </div>
            <div class="sidebar-item" onclick="window.location.href='../members/index.html'">
                ğŸ‘¥ ä¼šå‘˜ç®¡ç†
            </div>
        </div>
    </div>
    
    <div class="main-content">
        <div class="toolbar">
            <h2>èœå“ç®¡ç†</h2>
            <div class="search-box">
                <input type="text" id="search-input" placeholder="æœç´¢èœå“åç§°..." onkeyup="searchDishes()">
                <button class="btn btn-primary" onclick="openAddModal()">+ æ·»åŠ èœå“</button>
            </div>
        </div>
        
        <div class="dishes-grid" id="dishes-grid"></div>
    </div>
    
    <!-- æ·»åŠ /ç¼–è¾‘èœå“æ¨¡æ€æ¡† -->
    <div class="modal" id="dish-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modal-title">æ·»åŠ èœå“</div>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <form id="dish-form">
                <div class="form-group">
                    <label>èœå“åç§°</label>
                    <input type="text" id="dish-name" required>
                </div>
                <div class="form-group">
                    <label>ä»·æ ¼ (å…ƒ)</label>
                    <input type="number" id="dish-price" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>åˆ†ç±»</label>
                    <select id="dish-category" required>
                        <option value="">è¯·é€‰æ‹©åˆ†ç±»</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>æè¿°</label>
                    <textarea id="dish-description"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>
    
    <script src="../../common/js/api.js"></script>
    <script>
        let dishes = [];
        let categories = [];
        
        // åŠ è½½åˆ†ç±»
        async function loadCategories() {
            try {
                const data = await apiRequest('/api/menu-categories/');
                categories = data;
                renderCategoryOptions();
            } catch (error) {
                console.error('åŠ è½½åˆ†ç±»å¤±è´¥:', error);
            }
        }
        
        // æ¸²æŸ“åˆ†ç±»é€‰é¡¹
        function renderCategoryOptions() {
            const select = document.getElementById('dish-category');
            select.innerHTML = '<option value="">è¯·é€‰æ‹©åˆ†ç±»</option>' + 
                categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }
        
        // åŠ è½½èœå“
        async function loadDishes() {
            const container = document.getElementById('dishes-grid');
            showLoading(container);
            
            try {
                const data = await apiRequest('/api/menu-items/');
                dishes = data;
                renderDishes();
            } catch (error) {
                showError(container, 'åŠ è½½èœå“å¤±è´¥');
            }
        }
        
        // æ¸²æŸ“èœå“
        function renderDishes(dishesToRender = dishes) {
            const container = document.getElementById('dishes-grid');
            
            container.innerHTML = dishesToRender.map(dish => {
                const category = categories.find(c => c.id === dish.category_id);
                return `
                    <div class="dish-card">
                        <div class="dish-image">ğŸ“·</div>
                        <div class="dish-info">
                            <div class="dish-name">${dish.name}</div>
                            <div class="dish-price">Â¥${dish.price.toFixed(2)}</div>
                            <span class="dish-category">${category ? category.name : 'æœªåˆ†ç±»'}</span>
                            <div class="dish-actions">
                                <button class="btn btn-secondary" onclick="openEditModal(${dish.id})">ç¼–è¾‘</button>
                                <button class="btn btn-danger" onclick="deleteDish(${dish.id})">åˆ é™¤</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // æœç´¢èœå“
        function searchDishes() {
            const keyword = document.getElementById('search-input').value.toLowerCase();
            const filtered = dishes.filter(d => 
                d.name.toLowerCase().includes(keyword)
            );
            renderDishes(filtered);
        }
        
        // æ‰“å¼€æ·»åŠ æ¨¡æ€æ¡†
        function openAddModal() {
            document.getElementById('modal-title').textContent = 'æ·»åŠ èœå“';
            document.getElementById('dish-form').reset();
            document.getElementById('dish-modal').classList.add('active');
        }
        
        // æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†
        function openEditModal(dishId) {
            const dish = dishes.find(d => d.id === dishId);
            if (!dish) return;
            
            document.getElementById('modal-title').textContent = 'ç¼–è¾‘èœå“';
            document.getElementById('dish-name').value = dish.name;
            document.getElementById('dish-price').value = dish.price;
            document.getElementById('dish-category').value = dish.category_id;
            document.getElementById('dish-description').value = dish.description || '';
            document.getElementById('dish-modal').classList.add('active');
        }
        
        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('dish-modal').classList.remove('active');
        }
        
        // ä¿å­˜èœå“
        async function saveDish(e) {
            e.preventDefault();
            
            const dishData = {
                name: document.getElementById('dish-name').value,
                price: parseFloat(document.getElementById('dish-price').value),
                category_id: parseInt(document.getElementById('dish-category').value),
                description: document.getElementById('dish-description').value
            };
            
            try {
                // TODO: è°ƒç”¨æ·»åŠ /ç¼–è¾‘èœå“ API
                showMessage('ä¿å­˜æˆåŠŸ', 'success');
                closeModal();
                loadDishes();
            } catch (error) {
                showMessage('ä¿å­˜å¤±è´¥', 'error');
            }
        }
        
        // åˆ é™¤èœå“
        async function deleteDish(dishId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªèœå“å—ï¼Ÿ')) return;
            
            try {
                // TODO: è°ƒç”¨åˆ é™¤èœå“ API
                showMessage('åˆ é™¤æˆåŠŸ', 'success');
                loadDishes();
            } catch (error) {
                showMessage('åˆ é™¤å¤±è´¥', 'error');
            }
        }
        
        // è¡¨å•æäº¤
        document.getElementById('dish-form').addEventListener('submit', saveDish);
        
        // åˆå§‹åŒ–
        loadCategories();
        loadDishes();
    </script>
</body>
</html>
