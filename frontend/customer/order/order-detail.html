<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾å‘³é¤å… - è®¢å•è¯¦æƒ…</title>
    <link rel="stylesheet" href="../../common/css/style.css">
    <style>
        .order-status-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .order-status-icon {
            font-size: 60px;
            margin-bottom: 15px;
        }
        
        .order-status-text {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .order-status-desc {
            font-size: 14px;
            color: #666;
        }
        
        .order-info-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .order-info-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .order-info-row:last-child {
            border-bottom: none;
        }
        
        .order-items-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ff6b35;
        }
        
        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px dashed #eee;
        }
        
        .order-item:last-child {
            border-bottom: none;
        }
        
        .order-item-name {
            flex: 1;
            font-weight: bold;
        }
        
        .order-item-qty {
            color: #666;
            margin: 0 10px;
        }
        
        .order-item-price {
            color: #ff6b35;
            font-weight: bold;
        }
        
        .order-total-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .total-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            font-size: 16px;
        }
        
        .total-final {
            font-size: 24px;
            font-weight: bold;
            color: #ff6b35;
        }
        
        .action-buttons {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 15px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex;
            gap: 10px;
        }
        
        .btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .btn-add {
            background: #ff6b35;
            color: white;
        }
        
        .btn-back {
            background: #f0f0f0;
            color: #333;
        }
        
        .status-pending { color: #ff6b35; }
        .status-confirmed { color: #667eea; }
        .status-preparing { color: #33d5ff; }
        .status-ready { color: #33e891; }
        .status-serving { color: #7a67ff; }
        .status-completed { color: #10b981; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“‹ è®¢å•è¯¦æƒ…</h1>
        <div class="nav">
            <a href="../menu/index.html">ğŸ½ï¸ èœå•</a>
            <a href="../cart/index.html">ğŸ›’ è´­ç‰©è½¦</a>
            <a href="index.html">ğŸ“‹ æˆ‘çš„è®¢å•</a>
        </div>
    </div>
    
    <div class="container">
        <!-- è®¢å•çŠ¶æ€ -->
        <div class="order-status-card" id="order-status">
            <div class="order-status-icon">â³</div>
            <div class="order-status-text">åŠ è½½ä¸­...</div>
            <div class="order-status-desc">æ­£åœ¨è·å–è®¢å•ä¿¡æ¯</div>
        </div>
        
        <!-- è®¢å•ä¿¡æ¯ -->
        <div class="order-info-card">
            <div class="section-title">è®¢å•ä¿¡æ¯</div>
            <div id="order-info"></div>
        </div>
        
        <!-- è®¢å•èœå“ -->
        <div class="order-items-section">
            <div class="section-title">å·²ç‚¹èœå“</div>
            <div id="order-items"></div>
        </div>
        
        <!-- è®¢å•é‡‘é¢ -->
        <div class="order-total-section">
            <div class="section-title">è®¢å•é‡‘é¢</div>
            <div id="order-total"></div>
        </div>
        
        <!-- åº•éƒ¨ç•™ç™½ -->
        <div style="height: 80px;"></div>
    </div>
    
    <!-- æ“ä½œæŒ‰é’® -->
    <div class="action-buttons">
        <button class="btn btn-back" onclick="goBack()">è¿”å›</button>
        <button class="btn btn-add" onclick="addItems()">ç»§ç»­ç‚¹é¤</button>
    </div>
    
    <script src="../../common/js/api.js"></script>
    <script>
        let currentOrder = null;
        let orderId = null;
        
        // è·å–URLå‚æ•°
        function getUrlParam(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }
        
        // åˆå§‹åŒ–
        async function init() {
            orderId = getUrlParam('order_id');
            
            if (!orderId) {
                showError('è®¢å•IDä¸å­˜åœ¨');
                return;
            }
            
            await loadOrderDetail();
        }
        
        // åŠ è½½è®¢å•è¯¦æƒ…
        async function loadOrderDetail() {
            try {
                currentOrder = await apiRequest(`/api/orders/${orderId}/`);
                renderOrder();
            } catch (error) {
                showError('åŠ è½½è®¢å•å¤±è´¥');
            }
        }
        
        // æ¸²æŸ“è®¢å•
        function renderOrder() {
            // æ¸²æŸ“çŠ¶æ€
            renderStatus();
            
            // æ¸²æŸ“è®¢å•ä¿¡æ¯
            renderOrderInfo();
            
            // æ¸²æŸ“è®¢å•èœå“
            renderOrderItems();
            
            // æ¸²æŸ“è®¢å•é‡‘é¢
            renderOrderTotal();
        }
        
        // æ¸²æŸ“çŠ¶æ€
        function renderStatus() {
            const statusContainer = document.getElementById('order-status');
            const statusInfo = getStatusInfo(currentOrder.status);
            
            statusContainer.innerHTML = `
                <div class="order-status-icon">${statusInfo.icon}</div>
                <div class="order-status-text status-${currentOrder.status}">${statusInfo.text}</div>
                <div class="order-status-desc">${statusInfo.desc}</div>
            `;
        }
        
        // æ¸²æŸ“è®¢å•ä¿¡æ¯
        function renderOrderInfo() {
            const infoContainer = document.getElementById('order-info');
            
            infoContainer.innerHTML = `
                <div class="order-info-row">
                    <span>è®¢å•å·</span>
                    <span style="font-weight: bold;">${currentOrder.order_number}</span>
                </div>
                <div class="order-info-row">
                    <span>æ¡Œå·</span>
                    <span style="font-weight: bold; color: #ff6b35;">${currentOrder.table_number}å·æ¡Œ</span>
                </div>
                <div class="order-info-row">
                    <span>ä¸‹å•æ—¶é—´</span>
                    <span>${formatTime(currentOrder.created_at)}</span>
                </div>
                <div class="order-info-row">
                    <span>æ”¯ä»˜æ–¹å¼</span>
                    <span>${getPaymentMethodText(currentOrder.payment_method)}</span>
                </div>
            `;
        }
        
        // æ¸²æŸ“è®¢å•èœå“
        function renderOrderItems() {
            const itemsContainer = document.getElementById('order-items');
            
            itemsContainer.innerHTML = currentOrder.items.map(item => {
                const itemStatus = getItemStatusText(item.item_status);
                return `
                    <div class="order-item">
                        <div class="order-item-name">${item.menu_item_name}</div>
                        <div class="order-item-qty">x${item.quantity}</div>
                        <div class="order-item-price">Â¥${item.subtotal.toFixed(2)}</div>
                    </div>
                `;
            }).join('');
        }
        
        // æ¸²æŸ“è®¢å•é‡‘é¢
        function renderOrderTotal() {
            const totalContainer = document.getElementById('order-total');
            
            totalContainer.innerHTML = `
                <div class="total-row">
                    <span>å°è®¡</span>
                    <span>Â¥${currentOrder.total_amount.toFixed(2)}</span>
                </div>
                <div class="total-row">
                    <span>ä¼˜æƒ </span>
                    <span>-Â¥${currentOrder.discount_amount.toFixed(2)}</span>
                </div>
                <div class="total-row total-final">
                    <span>åˆè®¡</span>
                    <span>Â¥${currentOrder.final_amount.toFixed(2)}</span>
                </div>
            `;
        }
        
        // è·å–çŠ¶æ€ä¿¡æ¯
        function getStatusInfo(status) {
            const statusMap = {
                'pending': { icon: 'â³', text: 'å¾…ç¡®è®¤', desc: 'é¤å…æ­£åœ¨å¤„ç†æ‚¨çš„è®¢å•' },
                'confirmed': { icon: 'âœ…', text: 'å·²ç¡®è®¤', desc: 'æ‚¨çš„è®¢å•å·²ç¡®è®¤ï¼Œæ­£åœ¨å‡†å¤‡ä¸­' },
                'preparing': { icon: 'ğŸ‘¨â€ğŸ³', text: 'åˆ¶ä½œä¸­', desc: 'å¨å¸ˆæ­£åœ¨åˆ¶ä½œæ‚¨çš„èœå“' },
                'ready': { icon: 'ğŸ””', text: 'å¾…ä¼ èœ', desc: 'èœå“å·²åˆ¶ä½œå®Œæˆï¼Œå‡†å¤‡ä¸Šèœ' },
                'serving': { icon: 'ğŸ½ï¸', text: 'ä¸Šèœä¸­', desc: 'èœå“æ­£åœ¨é™†ç»­ä¸Šæ¡Œ' },
                'completed': { icon: 'âœ¨', text: 'å·²å®Œæˆ', desc: 'èœå“å·²å…¨éƒ¨ä¸Šå®Œï¼Œè¯·æ…¢ç”¨' }
            };
            return statusMap[status] || { icon: 'â“', text: status, desc: '' };
        }
        
        // è·å–èœå“çŠ¶æ€æ–‡æœ¬
        function getItemStatusText(status) {
            const statusMap = {
                'pending': 'å¾…åˆ¶ä½œ',
                'preparing': 'åˆ¶ä½œä¸­',
                'ready': 'å¾…ä¼ èœ',
                'serving': 'ä¸Šèœä¸­',
                'served': 'å·²ä¸Šèœ'
            };
            return statusMap[status] || status;
        }
        
        // è·å–æ”¯ä»˜æ–¹å¼æ–‡æœ¬
        function getPaymentMethodText(method) {
            const methodMap = {
                'cash': 'ç°é‡‘æ”¯ä»˜',
                'wechat': 'å¾®ä¿¡æ”¯ä»˜',
                'alipay': 'æ”¯ä»˜å®',
                'counter': 'æŸœå°æ”¯ä»˜',
                'immediate': 'åœ¨çº¿æ”¯ä»˜'
            };
            return methodMap[method] || method || 'æœªæ”¯ä»˜';
        }
        
        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(timeStr) {
            const date = new Date(timeStr);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            document.getElementById('order-status').innerHTML = `
                <div class="order-status-icon">âŒ</div>
                <div class="order-status-text">å‡ºé”™äº†</div>
                <div class="order-status-desc">${message}</div>
            `;
        }
        
        // è¿”å›
        function goBack() {
            window.location.href = 'index.html';
        }
        
        // ç»§ç»­ç‚¹é¤ï¼ˆåŠ èœï¼‰
        function addItems() {
            // ä¿å­˜å½“å‰è®¢å•IDï¼Œç”¨äºåç»­åŠ èœ
            localStorage.setItem('current_order_id', orderId);
            
            // è·³è½¬åˆ°èœå•é¡µé¢
            window.location.href = '../menu/index.html?mode=add_dish&order_id=' + orderId;
        }
        
        // åˆå§‹åŒ–
        init();
    </script>
</body>
</html>
