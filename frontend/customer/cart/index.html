<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾å‘³é¤å… - è´­ç‰©è½¦</title>
    <link rel="stylesheet" href="../../common/css/style.css">
    <style>
        .cart-item {
            display: flex;
            align-items: center;
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .cart-item-name {
            flex: 1;
            font-weight: bold;
        }
        
        .cart-item-price {
            color: #ff6b35;
            font-weight: bold;
            margin: 0 15px;
        }
        
        .cart-item-action {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .qty-btn {
            width: 28px;
            height: 28px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .cart-summary {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 15px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .summary-total {
            font-size: 20px;
            font-weight: bold;
            color: #ff6b35;
        }
        
        .checkout-btn {
            width: 100%;
            padding: 15px;
            background: #ff6b35;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .checkout-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .empty-cart {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-cart-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ›’ è´­ç‰©è½¦</h1>
        <div class="nav">
            <a href="menu/index.html">ğŸ½ï¸ èœå•</a>
            <a href="order.html">ğŸ“‹ è®¢å•</a>
            <a href="profile.html">ğŸ‘¤ æˆ‘çš„</a>
        </div>
    </div>
    
    <div class="container" style="padding-bottom: 200px;">
        <div id="cart-items"></div>
    </div>
    
    <div class="cart-summary" id="cart-summary">
        <div class="summary-row">
            <span>å…± <span id="total-count">0</span> ä»¶</span>
            <span class="summary-total">åˆè®¡: Â¥<span id="total-price">0.00</span></span>
        </div>
        <button class="checkout-btn" onclick="checkout()" id="checkout-btn" disabled>
            ç«‹å³ä¸‹å•
        </button>
    </div>
    
    <script src="../../common/js/api.js"></script>
    <script>
        let cart = getStorage('cart', []);
        
        // æ¸²æŸ“è´­ç‰©è½¦
        function renderCart() {
            const container = document.getElementById('cart-items');
            
            if (cart.length === 0) {
                container.innerHTML = `
                    <div class="empty-cart">
                        <div class="empty-cart-icon">ğŸ›’</div>
                        <p>è´­ç‰©è½¦æ˜¯ç©ºçš„</p>
                        <button class="btn btn-primary" onclick="window.location.href='menu/index.html'" style="margin-top: 20px;">
                            å»ç‚¹é¤
                        </button>
                    </div>
                `;
                document.getElementById('checkout-btn').disabled = true;
                return;
            }
            
            container.innerHTML = cart.map(item => `
                <div class="cart-item">
                    <div class="cart-item-name">${item.name}</div>
                    <div class="cart-item-price">Â¥${(item.price * item.quantity).toFixed(2)}</div>
                    <div class="cart-item-action">
                        <button class="qty-btn" onclick="updateQty(${item.menu_item_id}, -1)">-</button>
                        <span>${item.quantity}</span>
                        <button class="qty-btn" onclick="updateQty(${item.menu_item_id}, 1)">+</button>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('checkout-btn').disabled = false;
            updateSummary();
        }
        
        // æ›´æ–°æ•°é‡
        function updateQty(itemId, delta) {
            const cartItem = cart.find(c => c.menu_item_id === itemId);
            
            if (cartItem) {
                cartItem.quantity += delta;
                if (cartItem.quantity <= 0) {
                    cart = cart.filter(c => c.menu_item_id !== itemId);
                }
                
                setStorage('cart', cart);
                renderCart();
            }
        }
        
        // æ›´æ–°æ±‡æ€»
        function updateSummary() {
            const totalCount = cart.reduce((sum, item) => sum + item.quantity, 0);
            const totalPrice = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
            
            document.getElementById('total-count').textContent = totalCount;
            document.getElementById('total-price').textContent = totalPrice.toFixed(2);
        }
        
        // ä¸‹å•
        async function checkout() {
            if (cart.length === 0) {
                showMessage('è´­ç‰©è½¦æ˜¯ç©ºçš„', 'error');
                return;
            }
            
            try {
                const orderData = {
                    table_id: 1, // TODO: ä»æ‰«ç è·å–é¤æ¡ŒID
                    customer_name: "é¡¾å®¢", // TODO: ä»ç™»å½•ä¿¡æ¯è·å–
                    items: cart.map(item => ({
                        menu_item_id: item.menu_item_id,
                        quantity: item.quantity
                    }))
                };
                
                const result = await apiRequest('/api/orders/', {
                    method: 'POST',
                    body: JSON.stringify(orderData)
                });
                
                showMessage('ä¸‹å•æˆåŠŸï¼', 'success');
                
                // æ¸…ç©ºè´­ç‰©è½¦
                cart = [];
                setStorage('cart', cart);
                
                // è·³è½¬åˆ°è®¢å•è¯¦æƒ…é¡µ
                setTimeout(() => {
                    window.location.href = `order/order-detail.html?order_id=${result.id}`;
                }, 1000);
            } catch (error) {
                showMessage('ä¸‹å•å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }
        
        // åˆå§‹åŒ–
        renderCart();
    </script>
</body>
</html>
