# 🍽️ 实时工作流系统 - 使用指南

## 概述

本系统实现了完整的**实时工作流管理**，包括：
- ✅ 顾客扫码点餐，自动识别桌号
- ✅ 工作人员端实时接收工作提醒
- ✅ 订单全流程状态跟踪（待确认→制作中→待传菜→上菜中→已完成）
- ✅ 不同角色针对性的工作视图

## 服务架构

```
API服务 (8000)        - 提供RESTful API接口
WebSocket服务 (8001)  - 提供实时推送服务
HTTP文件服务 (8080)   - 提供静态页面访问
```

## 启动服务

### 方式一：使用启动脚本（推荐）

```bash
# 启动所有服务
./scripts/start_all_services.sh

# 停止所有服务
./scripts/stop_all_services.sh
```

### 方式二：手动启动

```bash
# 启动API服务
python -m uvicorn src.api.restaurant_api:app --host 0.0.0.0 --port 8000

# 启动WebSocket服务
python -m uvicorn src.api.websocket_api:app --host 0.0.0.0 --port 8001

# 启动HTTP文件服务
python -m http.server 8080 --directory assets
```

## 访问地址

| 服务 | 地址 | 说明 |
|------|------|------|
| 主入口 | http://localhost:8080 | 系统主页面 |
| 顾客点餐 | http://localhost:8080/customer_order.html | 顾客扫码点餐页面 |
| 工作人员端 | http://localhost:8080/staff_workflow.html | 店长、厨师、传菜员、收银员 |
| 店铺设置 | http://localhost:8080/shop_settings.html | 桌号管理和二维码生成 |
| API文档 | http://localhost:8000/docs | Swagger API文档 |
| WebSocket文档 | http://localhost:8001 | WebSocket服务信息 |

## 使用流程

### 1. 顾客扫码点餐

**步骤：**
1. 顾客扫描桌号二维码（如：8号桌）
2. 自动跳转到点餐页面，显示桌号：`customer_order.html?table=8`
3. 浏览菜单，添加菜品到购物车
4. 提交订单
5. 实时查看订单状态变化

**特点：**
- ✅ 自动识别桌号（通过URL参数）
- ✅ 实时接收订单状态更新（WebSocket）
- ✅ 移动端优化，类似微信小程序体验

### 2. 厨师端工作流程

**步骤：**
1. 访问工作人员端：`http://localhost:8080/staff_workflow.html`
2. 切换到"厨师"角色
3. 查看待制作订单
4. 点击"开始制作" → 标记菜品为制作中
5. 完成制作后点击"完成制作" → 标记菜品为待传菜
6. 全部完成后点击"全部完成"

**实时提醒：**
- 🔔 新订单提醒（自动推送）
- 🔔 紧急订单标识（超过10分钟未处理）
- 🔔 音频提示（可开启/关闭）

### 3. 传菜员工作流程

**步骤：**
1. 访问工作人员端：`http://localhost:8080/staff_workflow.html`
2. 切换到"传菜员"角色
3. 查看待传菜品（已制作完成的菜品）
4. 点击"上菜" → 标记菜品为已上菜
5. 全部上完后点击"完成传菜"

### 4. 收银员工作流程

**步骤：**
1. 访问工作人员端：`http://localhost:8080/staff_workflow.html`
2. 切换到"收银员"角色
3. 查看待支付订单
4. 点击"处理支付" → 标记订单为已完成
5. 点击"打印小票"（功能待实现）

### 5. 店长管理工作流程

**步骤：**
1. 访问工作人员端：`http://localhost:8080/staff_workflow.html`
2. 切换到"店长"角色
3. 查看所有订单（支持筛选）
4. 查看统计数据（待确认、制作中、待传菜、上菜中、已完成）
5. 查看订单详情
6. 取消订单（仅限待确认状态）

## 订单状态流转

```
待确认 (pending) 
    ↓
制作中 (preparing) - 厨师开始制作
    ↓
待传菜 (ready) - 厨师完成制作
    ↓
上菜中 (serving) - 传菜员开始上菜
    ↓
已完成 (completed) - 全部上完并支付
```

## WebSocket实时推送

### 连接方式

**店铺连接（店员端）：**
```
ws://localhost:8001/ws/store/{store_id}
```

**订单连接（顾客端）：**
```
ws://localhost:8001/ws/order/{order_id}
```

**桌号连接（顾客端）：**
```
ws://localhost:8001/ws/table/{table_id}
```

### 消息类型

**1. 连接成功：**
```json
{
  "type": "connected",
  "message": "连接成功",
  "store_id": 1,
  "connection_id": "store_1_1234567890",
  "timestamp": "2024-01-01T12:00:00"
}
```

**2. 新订单提醒：**
```json
{
  "type": "new_order",
  "order": {
    "id": 123,
    "table_number": "8",
    "total_amount": 99.00,
    "items": [...]
  },
  "timestamp": "2024-01-01T12:00:00"
}
```

**3. 订单状态更新：**
```json
{
  "type": "order_status_update",
  "order": {
    "id": 123,
    "status": "preparing",
    "items": [...]
  },
  "timestamp": "2024-01-01T12:00:00"
}
```

**4. 心跳响应：**
```json
{
  "type": "pong",
  "timestamp": "2024-01-01T12:00:00"
}
```

## 角色权限说明

| 角色 | 可见订单 | 可执行操作 |
|------|---------|-----------|
| **顾客** | 仅自己桌号的订单 | 查看订单状态、点餐 |
| **厨师** | 待制作和制作中的订单 | 开始制作、完成制作 |
| **传菜员** | 待传菜和上菜中的订单 | 上菜、完成传菜 |
| **收银员** | 待支付的订单 | 处理支付、打印小票 |
| **店长** | 所有订单 | 查看详情、取消订单 |

## 技术特点

1. **实时通信**
   - 使用WebSocket实现低延迟推送
   - 支持多客户端同时连接
   - 自动重连机制

2. **移动端优化**
   - 响应式设计，适配各种屏幕尺寸
   - 触摸友好的交互
   - 流畅的动画效果

3. **状态管理**
   - 订单状态机确保流程正确
   - 菜品级别的状态跟踪
   - 操作日志记录

4. **可扩展性**
   - 模块化设计
   - 清晰的接口定义
   - 易于添加新角色

## 常见问题

**Q: 顾客如何扫码点餐？**
A: 顾客扫描桌号二维码后，会自动跳转到点餐页面，URL中包含桌号参数（如：`?table=8`）。

**Q: 工作人员如何实时接收新订单提醒？**
A: 工作人员端页面会自动连接WebSocket，当有新订单时会收到实时推送和音频提示。

**Q: 订单状态如何流转？**
A: 订单状态严格按照：待确认→制作中→待传菜→上菜中→已完成的顺序流转，确保流程规范。

**Q: 如何测试完整流程？**
A: 
1. 打开顾客点餐页面：`http://localhost:8080/customer_order.html?table=8`
2. 选择菜品并提交订单
3. 打开工作人员端：`http://localhost:8080/staff_workflow.html`
4. 切换到厨师角色，开始制作
5. 切换到传菜员角色，开始上菜
6. 切换到收银员角色，处理支付

**Q: 如何生成桌号二维码？**
A: 访问店铺设置页面：`http://localhost:8080/shop_settings.html`，可以管理桌号并生成二维码。

## 后续优化方向

1. **功能增强**
   - 实现小票打印功能
   - 添加语音播报
   - 支持订单修改和退菜

2. **用户体验**
   - 优化移动端交互
   - 添加订单历史记录
   - 支持会员登录和积分

3. **系统性能**
   - 添加缓存机制
   - 优化数据库查询
   - 实现负载均衡

## 技术支持

如有问题，请查看：
- API文档：http://localhost:8000/docs
- 日志文件：`logs/` 目录

---

**祝使用愉快！** 🍽️
