# å¤šåº—é“ºæ‰«ç ç‚¹é¤ç³»ç»Ÿ - æœåŠ¡å™¨éƒ¨ç½²æŒ‡å—

æœ¬æŒ‡å—å°†å¸®åŠ©æ‚¨åœ¨è…¾è®¯äº‘æœåŠ¡å™¨ä¸Šå¿«é€Ÿéƒ¨ç½²å¤šåº—é“ºæ‰«ç ç‚¹é¤ç³»ç»Ÿã€‚

---

## ğŸ“‹ ç›®å½•

1. [å‡†å¤‡å·¥ä½œ](#å‡†å¤‡å·¥ä½œ)
2. [éƒ¨ç½²æ–¹å¼](#éƒ¨ç½²æ–¹å¼)
3. [å¿«é€Ÿéƒ¨ç½²ï¼ˆæ¨èï¼‰](#å¿«é€Ÿéƒ¨ç½²æ¨è)
4. [æ‰‹åŠ¨éƒ¨ç½²](#æ‰‹åŠ¨éƒ¨ç½²)
5. [éªŒè¯éƒ¨ç½²](#éªŒè¯éƒ¨ç½²)
6. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## å‡†å¤‡å·¥ä½œ

### æœåŠ¡å™¨è¦æ±‚

- **æ“ä½œç³»ç»Ÿ**: Ubuntu 20.04/22.04 LTSï¼ˆæ¨èï¼‰
- **CPU**: 2æ ¸æˆ–ä»¥ä¸Š
- **å†…å­˜**: 4GB æˆ–ä»¥ä¸Š
- **ç£ç›˜**: 40GB æˆ–ä»¥ä¸Š
- **ç½‘ç»œ**: å…¬ç½‘IPï¼Œå¼€æ”¾ 80/443 ç«¯å£

### æœ¬åœ°å‡†å¤‡

åœ¨æ‚¨çš„ç”µè„‘ä¸Šï¼Œéœ€è¦å‡†å¤‡ï¼š

1. **SSH å®¢æˆ·ç«¯**
   - Windows: ä½¿ç”¨ PowerShellã€PuTTY æˆ– Git Bash
   - Mac/Linux: ä½¿ç”¨ç»ˆç«¯

2. **é¡¹ç›®ä»£ç **
   - ç¡®ä¿é¡¹ç›®ä»£ç å®Œæ•´
   - åŒ…å«æ‰€æœ‰ä¾èµ–æ–‡ä»¶

---

## éƒ¨ç½²æ–¹å¼

### æ–¹å¼ä¸€ï¼šè‡ªåŠ¨åŒ–éƒ¨ç½²ï¼ˆæ¨èï¼‰
ä½¿ç”¨ä¸€é”®éƒ¨ç½²è„šæœ¬ï¼Œå…¨ç¨‹è‡ªåŠ¨åŒ–ï¼Œé€‚åˆå¿«é€Ÿéƒ¨ç½²ã€‚

### æ–¹å¼äºŒï¼šæ‰‹åŠ¨éƒ¨ç½²
é€æ­¥æ‰§è¡Œæ¯ä¸ªæ­¥éª¤ï¼Œé€‚åˆéœ€è¦å®šåˆ¶åŒ–çš„åœºæ™¯ã€‚

---

## å¿«é€Ÿéƒ¨ç½²ï¼ˆæ¨èï¼‰

### æ­¥éª¤ 1ï¼šè¿æ¥åˆ°æœåŠ¡å™¨

ä½¿ç”¨ SSH è¿æ¥åˆ°æ‚¨çš„è…¾è®¯äº‘æœåŠ¡å™¨ï¼š

```bash
# æ›¿æ¢ä¸ºæ‚¨çš„æœåŠ¡å™¨IP
ssh root@your-server-ip

# è¾“å…¥å¯†ç ï¼ˆæˆ–ä½¿ç”¨SSHå¯†é’¥ï¼‰
```

**æç¤º**ï¼š
- é¦–æ¬¡è¿æ¥ä¼šæç¤ºä¿å­˜ä¸»æœºæŒ‡çº¹ï¼Œè¾“å…¥ `yes`
- å¯†ç è¾“å…¥æ—¶ä¸ä¼šæ˜¾ç¤ºï¼Œè¿™æ˜¯æ­£å¸¸çš„

---

### æ­¥éª¤ 2ï¼šä¸Šä¼ é¡¹ç›®ä»£ç 

åœ¨æ‚¨çš„æœ¬åœ°ç”µè„‘ä¸Šæ‰§è¡Œï¼ˆæ–°å¼€ä¸€ä¸ªç»ˆç«¯ï¼‰ï¼š

#### æ–¹å¼ Aï¼šä½¿ç”¨ scpï¼ˆæ¨èï¼‰

```bash
# å‹ç¼©é¡¹ç›®
cd /path/to/your/project
tar -czf restaurant-system.tar.gz \
    src/ \
    requirements.txt \
    scripts/ \
    docs/ \
    .coze

# ä¸Šä¼ åˆ°æœåŠ¡å™¨
scp restaurant-system.tar.gz root@your-server-ip:/opt/

# ä¸Šä¼ éƒ¨ç½²è„šæœ¬
scp scripts/deploy_to_server.sh root@your-server-ip:/opt/
```

#### æ–¹å¼ Bï¼šä½¿ç”¨ Git

```bash
# åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼ˆå¦‚æœé¡¹ç›®å·²æ¨é€åˆ°Gitä»“åº“ï¼‰
cd /opt
git clone your-git-repository-url.git restaurant-system
cd restaurant-system
```

---

### æ­¥éª¤ 3ï¼šåœ¨æœåŠ¡å™¨ä¸Šè§£å‹å¹¶éƒ¨ç½²

è¿æ¥åˆ°æœåŠ¡å™¨åæ‰§è¡Œï¼š

```bash
# è¿›å…¥ç›®æ ‡ç›®å½•
cd /opt

# è§£å‹é¡¹ç›®
tar -xzf restaurant-system.tar.gz
cd restaurant-system  # æˆ–è§£å‹åçš„ç›®å½•å

# èµ‹äºˆéƒ¨ç½²è„šæœ¬æ‰§è¡Œæƒé™
chmod +x deploy_to_server.sh
```

---

### æ­¥éª¤ 4ï¼šè¿è¡Œéƒ¨ç½²è„šæœ¬

```bash
# æ‰§è¡Œéƒ¨ç½²è„šæœ¬
bash deploy_to_server.sh
```

**éƒ¨ç½²è¿‡ç¨‹ä¸­ä¼šè‡ªåŠ¨æ‰§è¡Œ**ï¼š
- âœ… æ›´æ–°ç³»ç»Ÿè½¯ä»¶åŒ…
- âœ… å®‰è£… Pythonã€PostgreSQLã€Nginx ç­‰ä¾èµ–
- âœ… é…ç½®æ•°æ®åº“
- âœ… åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
- âœ… å®‰è£… Python ä¾èµ–
- âœ… åˆå§‹åŒ–æ•°æ®åº“å’Œæµ‹è¯•æ•°æ®
- âœ… é…ç½® systemd æœåŠ¡
- âœ… é…ç½® Nginx åå‘ä»£ç†
- âœ… é…ç½®é˜²ç«å¢™
- âœ… å¯åŠ¨æ‰€æœ‰æœåŠ¡

**è‡ªå®šä¹‰é…ç½®**ï¼ˆå¯é€‰ï¼‰ï¼š

```bash
# è‡ªå®šä¹‰æ•°æ®åº“å¯†ç 
export DB_PASSWORD="YourSecurePassword123"

# è‡ªå®šä¹‰æ•°æ®åº“åç§°
export DB_NAME="my_restaurant_db"

# è‡ªå®šä¹‰æ•°æ®åº“ç”¨æˆ·å
export DB_USER="my_restaurant_user"

# è‡ªå®šä¹‰åŸŸå
export DOMAIN="your-domain.com"

# ç„¶åæ‰§è¡Œéƒ¨ç½²
bash deploy_to_server.sh
```

---

### æ­¥éª¤ 5ï¼šç­‰å¾…éƒ¨ç½²å®Œæˆ

éƒ¨ç½²å¤§çº¦éœ€è¦ 5-10 åˆ†é’Ÿï¼Œè¯·è€å¿ƒç­‰å¾…ã€‚

**æˆåŠŸæ ‡å¿—**ï¼š
```
ğŸ‰ éƒ¨ç½²å®Œæˆï¼
============================================================

æœåŠ¡ä¿¡æ¯:
  - åç«¯æœåŠ¡: http://127.0.0.1:8080
  - Nginx: http://127.0.0.1 (æˆ–æ‚¨çš„åŸŸå)

æ•°æ®åº“ä¿¡æ¯:
  - æ•°æ®åº“å: restaurant_db
  - ç”¨æˆ·å: restaurant_user
  - å¯†ç : Restaurant@2024

ç®¡ç†å‘½ä»¤:
  - æŸ¥çœ‹çŠ¶æ€: systemctl status restaurant
  - å¯åŠ¨æœåŠ¡: systemctl start restaurant
  - åœæ­¢æœåŠ¡: systemctl stop restaurant
  - é‡å¯æœåŠ¡: systemctl restart restaurant
  - æŸ¥çœ‹æ—¥å¿—: journalctl -u restaurant -f

æµ‹è¯•API:
  - å¥åº·æ£€æŸ¥: curl http://127.0.0.1:8080/health
  - åº—é“ºä¿¡æ¯: curl http://127.0.0.1:8080/api/store
============================================================
```

---

## éªŒè¯éƒ¨ç½²

### 1. æ£€æŸ¥æœåŠ¡çŠ¶æ€

```bash
# æ£€æŸ¥åç«¯æœåŠ¡
systemctl status restaurant

# æ£€æŸ¥ Nginx
systemctl status nginx

# æ£€æŸ¥ PostgreSQL
systemctl status postgresql
```

**é¢„æœŸè¾“å‡º**ï¼š
```
â— restaurant.service - Restaurant Ordering System
   Loaded: loaded (/etc/systemd/system/restaurant.service; enabled; vendor preset: enabled)
   Active: active (running) since Mon 2024-xx-xx xx:xx:xx CST; 1min ago
```

---

### 2. æµ‹è¯• API æ¥å£

```bash
# å¥åº·æ£€æŸ¥
curl http://127.0.0.1:8080/health

# é¢„æœŸè¾“å‡º
# {"status":"healthy","service":"restaurant-system"}

# è·å–åº—é“ºä¿¡æ¯
curl http://127.0.0.1:8080/api/store

# è·å–èœå“åˆ—è¡¨
curl http://127.0.0.1:8080/api/menu-items/

# è·å–æ¡Œå·åˆ—è¡¨
curl http://127.0.0.1:8080/api/tables/
```

---

### 3. æŸ¥çœ‹æœåŠ¡æ—¥å¿—

```bash
# å®æ—¶æŸ¥çœ‹åç«¯æ—¥å¿—
journalctl -u restaurant -f

# æŸ¥çœ‹ Nginx æ—¥å¿—
tail -f /var/log/nginx/restaurant_access.log
tail -f /var/log/nginx/restaurant_error.log
```

---

### 4. æµè§ˆå™¨è®¿é—®

æ‰“å¼€æµè§ˆå™¨ï¼Œè®¿é—®ï¼š

```
http://your-server-ip
# æˆ–
http://your-domain.com
```

---

## æ‰‹åŠ¨éƒ¨ç½²

å¦‚æœæ‚¨éœ€è¦æ›´ç²¾ç»†çš„æ§åˆ¶ï¼Œå¯ä»¥æ‰‹åŠ¨æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š

### 1. æ›´æ–°ç³»ç»Ÿ

```bash
apt update
apt upgrade -y
```

---

### 2. å®‰è£…ä¾èµ–

```bash
apt install -y \
    python3 \
    python3-pip \
    python3-venv \
    postgresql \
    postgresql-contrib \
    nginx \
    git
```

---

### 3. é…ç½® PostgreSQL

```bash
# å¯åŠ¨ PostgreSQL
service postgresql start

# åˆ›å»ºæ•°æ®åº“å’Œç”¨æˆ·
sudo -u postgres psql <<EOF
CREATE USER restaurant_user WITH PASSWORD 'Restaurant@2024';
CREATE DATABASE restaurant_db OWNER restaurant_user;
GRANT ALL PRIVILEGES ON DATABASE restaurant_db TO restaurant_user;
\c restaurant_db
GRANT ALL ON SCHEMA public TO restaurant_user;
EOF
```

---

### 4. é…ç½®é¡¹ç›®

```bash
cd /opt/restaurant-system

# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python3 -m venv venv
source venv/bin/activate

# å®‰è£…ä¾èµ–
pip install -r requirements.txt

# é…ç½®ç¯å¢ƒå˜é‡
cat > .env <<EOF
PGDATABASE_URL=postgresql://restaurant_user:Restaurant@2024@localhost/restaurant_db
APP_ENV=production
SECRET_KEY=$(openssl rand -hex 32)
EOF

# åˆå§‹åŒ–æ•°æ®åº“
python3 -c "from storage.database.init_db import init_database, ensure_test_data; init_database(); ensure_test_data()"
```

---

### 5. åˆ›å»º systemd æœåŠ¡

```bash
cat > /etc/systemd/system/restaurant.service <<EOF
[Unit]
Description=Restaurant Ordering System
After=network.target postgresql.service

[Service]
Type=simple
User=root
WorkingDirectory=/opt/restaurant-system
Environment="PATH=/opt/restaurant-system/venv/bin"
EnvironmentFile=/opt/restaurant-system/.env
ExecStart=/opt/restaurant-system/venv/bin/uvicorn src.main:app --host 0.0.0.0 --port 8080
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable restaurant
systemctl start restaurant
```

---

### 6. é…ç½® Nginx

```bash
cat > /etc/nginx/sites-available/restaurant <<EOF
server {
    listen 80;
    server_name _;

    location / {
        proxy_pass http://127.0.0.1:8080;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;

        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection "upgrade";

        proxy_connect_timeout 600s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;
    }
}
EOF

ln -sf /etc/nginx/sites-available/restaurant /etc/nginx/sites-enabled/
rm -f /etc/nginx/sites-enabled/default
nginx -t
systemctl restart nginx
```

---

### 7. é…ç½®é˜²ç«å¢™

```bash
ufw allow OpenSSH
ufw allow 80/tcp
ufw allow 443/tcp
ufw --force enable
```

---

## å¸¸è§é—®é¢˜

### é—®é¢˜ 1ï¼šè¿æ¥è¶…æ—¶

**ç°è±¡**ï¼šSSH è¿æ¥å¤±è´¥æˆ–è¶…æ—¶

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦åœ¨çº¿
ping your-server-ip

# æ£€æŸ¥é˜²ç«å¢™ï¼ˆå®å¡”é¢æ¿æˆ–è…¾è®¯äº‘å®‰å…¨ç»„ï¼‰
# ç¡®ä¿å¼€æ”¾ 22 (SSH)ã€80 (HTTP)ã€443 (HTTPS) ç«¯å£
```

---

### é—®é¢˜ 2ï¼šæ•°æ®åº“è¿æ¥å¤±è´¥

**ç°è±¡**ï¼š`psycopg2.OperationalError: could not connect to server`

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ£€æŸ¥ PostgreSQL æ˜¯å¦è¿è¡Œ
systemctl status postgresql

# æ£€æŸ¥æ•°æ®åº“è¿æ¥
sudo -u postgres psql -U restaurant_user -d restaurant_db -c "SELECT 1"

# æ£€æŸ¥ .env æ–‡ä»¶ä¸­çš„æ•°æ®åº“é…ç½®
cat /opt/restaurant-system/.env
```

---

### é—®é¢˜ 3ï¼šç«¯å£è¢«å ç”¨

**ç°è±¡**ï¼š`Address already in use`

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æŸ¥çœ‹å ç”¨ 8080 ç«¯å£çš„è¿›ç¨‹
lsof -i :8080

# æ€æ­»è¿›ç¨‹
kill -9 <PID>

# æˆ–ä¿®æ”¹é…ç½®ä½¿ç”¨å…¶ä»–ç«¯å£
# ç¼–è¾‘ systemd æœåŠ¡æ–‡ä»¶ï¼Œå°† 8080 æ”¹ä¸ºå…¶ä»–ç«¯å£
```

---

### é—®é¢˜ 4ï¼šæƒé™é”™è¯¯

**ç°è±¡**ï¼š`Permission denied`

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# ä½¿ç”¨ root ç”¨æˆ·æ‰§è¡Œéƒ¨ç½²è„šæœ¬
sudo su

# æˆ–èµ‹äºˆæ‰§è¡Œæƒé™
chmod +x scripts/deploy_to_server.sh
chmod +x deploy_to_server.sh
```

---

### é—®é¢˜ 5ï¼šä¾èµ–å®‰è£…å¤±è´¥

**ç°è±¡**ï¼špip å®‰è£…æ—¶æŠ¥é”™

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# å‡çº§ pip
pip install --upgrade pip

# ä½¿ç”¨å›½å†…é•œåƒæº
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple

# æˆ–å•ç‹¬å®‰è£…å¤±è´¥çš„åŒ…
pip install fastapi uvicorn sqlalchemy psycopg2-binary
```

---

### é—®é¢˜ 6ï¼šNginx é…ç½®é”™è¯¯

**ç°è±¡**ï¼šnginx -t æŠ¥é”™

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•
nginx -t

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
tail -f /var/log/nginx/error.log

# ä¿®å¤é…ç½®åé‡æ–°åŠ è½½
nginx -s reload
```

---

### é—®é¢˜ 7ï¼šæœåŠ¡æ— æ³•å¯åŠ¨

**ç°è±¡**ï¼š`systemctl start restaurant` å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
systemctl status restaurant

# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
journalctl -u restaurant -n 50

# æ‰‹åŠ¨å¯åŠ¨æµ‹è¯•
cd /opt/restaurant-system
source venv/bin/activate
source .env
uvicorn src.main:app --host 0.0.0.0 --port 8080
```

---

## ä¸‹ä¸€æ­¥

éƒ¨ç½²å®Œæˆåï¼Œæ‚¨å¯ä»¥ï¼š

1. **æ‰§è¡ŒåŠŸèƒ½æµ‹è¯•**
   - ä½¿ç”¨ `docs/æµ‹è¯•æ‰‹å†Œ.md` è¿›è¡Œå®Œæ•´çš„ç«¯åˆ°ç«¯æµ‹è¯•

2. **é…ç½®åŸŸåå’ŒSSL**
   - ç”³è¯·åŸŸåå¹¶è§£æåˆ°æœåŠ¡å™¨IP
   - ä½¿ç”¨ Certbot é…ç½® HTTPS

3. **å¯¹æ¥å‰ç«¯**
   - å°†å‰ç«¯éƒ¨ç½²åˆ°æœåŠ¡å™¨æˆ– CDN
   - é…ç½® API ä»£ç†

4. **ç›‘æ§å’Œç»´æŠ¤**
   - é…ç½®æ—¥å¿—æ”¶é›†
   - è®¾ç½®å¤‡ä»½ç­–ç•¥
   - ç›‘æ§æœåŠ¡çŠ¶æ€

---

## è·å–å¸®åŠ©

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

1. **æœåŠ¡å™¨ä¿¡æ¯**
   ```bash
   uname -a
   cat /etc/os-release
   ```

2. **æœåŠ¡çŠ¶æ€**
   ```bash
   systemctl status restaurant
   systemctl status nginx
   systemctl status postgresql
   ```

3. **é”™è¯¯æ—¥å¿—**
   ```bash
   journalctl -u restaurant -n 100
   tail -100 /var/log/nginx/restaurant_error.log
   ```

4. **ç¯å¢ƒä¿¡æ¯**
   ```bash
   python3 --version
   pip list
   ```

---

## é™„å½•ï¼šå¿«é€Ÿå‘½ä»¤å‚è€ƒ

```bash
# æœåŠ¡ç®¡ç†
systemctl start restaurant    # å¯åŠ¨æœåŠ¡
systemctl stop restaurant     # åœæ­¢æœåŠ¡
systemctl restart restaurant  # é‡å¯æœåŠ¡
systemctl status restaurant   # æŸ¥çœ‹çŠ¶æ€
journalctl -u restaurant -f   # æŸ¥çœ‹å®æ—¶æ—¥å¿—

# æ•°æ®åº“æ“ä½œ
sudo -u postgres psql -d restaurant_db  # è¿æ¥æ•°æ®åº“
\dt                                    # åˆ—å‡ºæ‰€æœ‰è¡¨
\q                                     # é€€å‡º

# API æµ‹è¯•
curl http://127.0.0.1:8080/health     # å¥åº·æ£€æŸ¥
curl http://127.0.0.1:8080/api/store  # åº—é“ºä¿¡æ¯

# æ—¥å¿—æŸ¥çœ‹
tail -f /var/log/nginx/restaurant_access.log   # Nginx è®¿é—®æ—¥å¿—
tail -f /var/log/nginx/restaurant_error.log    # Nginx é”™è¯¯æ—¥å¿—
```

---

**ç¥æ‚¨éƒ¨ç½²é¡ºåˆ©ï¼** ğŸ‰
