# 扫码点餐系统 - 系统架构文档

## 1. 系统概述

### 1.1 项目背景
本系统是一个多店铺、多角色的扫码点餐系统，支持顾客扫码点餐、在线支付、会员管理、库存管理、营收分析等全流程功能。

### 1.2 核心角色
- **开发者**：系统维护、开发权限
- **总公司**：管理所有店铺、查看全局数据
- **店长**：管理单个店铺、店员、库存、营收
- **店员**：接单、传菜、基础操作

### 1.3 技术栈
- **后端框架**：Python + LangChain + LangGraph
- **数据库**：PostgreSQL（集成：integration-postgre-database）
- **对象存储**：S3 兼容对象存储（集成：integration-s3-storage）
- **AI 模型**：豆包大模型（集成：integration-doubao-seed）
- **前端**：待实现（建议使用 React/Vue）

## 2. 系统架构

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                      前端层（待实现）                           │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐    │
│  │ 顾客点餐  │  │店员管理端 │  │店长管理端 │  │总公司端   │    │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘    │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                     API 层（待实现）                           │
│              RESTful API / GraphQL API                       │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                     业务逻辑层                                │
│  ┌──────────────────┐  ┌──────────────────┐                 │
│  │ 订单智能分析Agent │  │ 营收分析Agent     │                 │
│  └──────────────────┘  └──────────────────┘                 │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                     工具层                                   │
│  ┌──────────────┐  ┌──────────────┐                        │
│  │订单管理工具   │  │营收分析工具   │                        │
│  └──────────────┘  └──────────────┘                        │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                     数据层                                   │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐                 │
│  │PostgreSQL│  │  S3存储   │  │ LLM模型   │                 │
│  └──────────┘  └──────────┘  └──────────┘                 │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 数据库架构

#### 已创建的数据表（共 19 张表）

**用户与权限模块：**
- `users` - 用户表
- `roles` - 角色表
- `user_roles` - 用户角色关联表

**店铺管理模块：**
- `companies` - 总公司表
- `stores` - 店铺表
- `tables` - 桌号表
- `staff` - 店员表

**菜品管理模块：**
- `menu_categories` - 菜品分类表
- `menu_items` - 菜品表

**订单模块：**
- `orders` - 订单表
- `order_items` - 订单明细表
- `order_status_logs` - 订单状态变更日志

**支付模块：**
- `payments` - 支付表

**会员管理模块：**
- `members` - 会员表
- `member_level_rules` - 会员等级规则表
- `point_logs` - 积分变动日志

**库存管理模块：**
- `inventory` - 库存表
- `inventory_logs` - 库存变动日志
- `suppliers` - 供应商表
- `purchase_orders` - 采购订单表
- `purchase_items` - 采购明细表

**营收统计模块：**
- `daily_revenue` - 每日营收统计表

详细表结构请参考：`docs/database_design.md`

### 2.3 AI Agent 架构

#### Agent 1：订单智能分析 Agent
**文件路径**：`src/agents/order_analysis_agent.py`

**功能**：
- 订单查询与分析
- 异常订单识别（长时间未处理、支付失败等）
- 订单状态更新
- 订单详情查看

**工具**：
- `query_orders` - 查询订单信息
- `update_order_status` - 更新订单状态
- `analyze_order_anomalies` - 分析异常订单
- `get_order_detail` - 获取订单详情

**配置文件**：`config/order_analysis_agent_config.json`

#### Agent 2：营收分析 Agent
**文件路径**：`src/agents/revenue_analysis_agent.py`

**功能**：
- 每日营收计算与统计
- 营收趋势分析
- 不同时期营收对比
- 高峰时段分析

**工具**：
- `calculate_daily_revenue` - 计算每日营收
- `get_revenue_trend` - 获取营收趋势
- `compare_revenue` - 对比不同时期营收
- `get_peak_hours_analysis` - 分析高峰时段

**配置文件**：`config/revenue_analysis_agent_config.json`

## 3. 核心业务流程

### 3.1 扫码点餐流程

```
1. 顾客扫描二维码（对应桌号）
   ↓
2. 进入点餐页面，浏览菜单
   ↓
3. 选择菜品，提交订单
   ↓
4. 系统创建订单（状态：pending）
   ↓
5. 店员确认订单（状态：confirmed）
   ↓
6. 厨师接收订单，开始烹饪（状态：preparing）
   ↓
7. 烹饪完成（状态：ready）
   ↓
8. 传菜员送到桌号（状态：serving）
   ↓
9. 用餐完成（状态：completed）
   ↓
10. 支付（可提前支付或餐后支付）
```

### 3.2 支付流程

```
1. 顾客选择支付方式
   ↓
2. 创建支付记录
   ↓
3. 调用支付接口（待集成第三方支付）
   ↓
4. 支付成功/失败回调
   ↓
5. 更新订单支付状态
```

### 3.3 库存管理流程

```
1. 采购物料（创建采购订单）
   ↓
2. 供应商发货
   ↓
3. 收货入库（更新库存）
   ↓
4. 库存预警（低于最低库存提醒）
   ↓
5. 销售出库（订单消费）
   ↓
6. 定期盘点（调整库存）
```

### 3.4 营收统计流程

```
1. 每日定时任务（待实现）
   ↓
2. 统计当日订单数据
   ↓
3. 计算营收、折扣、退款等
   ↓
4. 分析支付方式、高峰时段
   ↓
5. 生成每日营收记录
   ↓
6. 生成趋势分析报告
```

## 4. 已实现功能

### 4.1 数据库层 ✅
- ✅ 完整的数据库表结构设计
- ✅ ORM 模型定义
- ✅ 数据库迁移完成
- ✅ 索引优化

### 4.2 AI Agent ✅
- ✅ 订单智能分析 Agent
- ✅ 营收分析 Agent
- ✅ 配置文件完善
- ✅ 短期记忆功能（滑动窗口）

### 4.3 工具层 ✅
- ✅ 订单管理工具（4个工具函数）
- ✅ 营收分析工具（4个工具函数）

### 4.4 集成 ✅
- ✅ PostgreSQL 数据库集成
- ✅ S3 对象存储集成
- ✅ 豆包大模型集成

## 5. 待实现功能

### 5.1 高优先级
1. **API 层**
   - [ ] RESTful API 接口开发
   - [ ] 用户认证与授权（JWT）
   - [ ] 接口文档（Swagger/OpenAPI）

2. **前端开发**
   - [ ] 顾客点餐端（H5/小程序）
   - [ ] 店员管理端
   - [ ] 店长管理端
   - [ ] 总公司管理端

3. **支付集成**
   - [ ] 微信支付集成
   - [ ] 支付宝支付集成
   - [ ] 支付回调处理

### 5.2 中优先级
1. **店铺管理功能**
   - [ ] 店铺信息管理
   - [ ] 菜品管理（增删改查）
   - [ ] 桌号管理
   - [ ] 店员管理

2. **会员管理功能**
   - [ ] 会员注册
   - [ ] 积分系统
   - [ ] 会员等级管理
   - [ ] 会员优惠活动

3. **库存管理功能**
   - [ ] 库存监控
   - [ ] 采购管理
   - [ ] 库存预警
   - [ ] 盘点功能

### 5.3 低优先级
1. **高级功能**
   - [ ] 菜品推荐算法（基于历史订单）
   - [ ] 营销活动管理
   - [ ] 数据可视化大屏
   - [ ] 财务报表导出

## 6. 使用指南

### 6.1 环境准备

确保已安装以下依赖：
```bash
pip install langchain langchain-openai langgraph sqlalchemy pydantic
```

### 6.2 数据库初始化

数据库表已创建完成，无需额外操作。

如需重置数据库：
```bash
eval $(python /workspace/projects/scripts/load_env.py) && bash /source/alembic/upgrade.sh
```

### 6.3 使用 AI Agent

#### 订单智能分析 Agent

```python
from agents.order_analysis_agent import build_agent

# 创建 Agent
agent = build_agent()

# 示例查询
query = "分析店铺1今天的异常订单"
result = agent.invoke({"messages": [HumanMessage(content=query)]})
print(result)
```

#### 营收分析 Agent

```python
from agents.revenue_analysis_agent import build_agent

# 创建 Agent
agent = build_agent()

# 示例查询
query = "分析店铺1最近7天的营收趋势"
result = agent.invoke({"messages": [HumanMessage(content=query)]})
print(result)
```

### 6.4 使用工具函数

#### 订单管理工具

```python
from tools.order_management_tool import query_orders, update_order_status

# 查询订单
result = query_orders('{"store_id": 1, "order_status": "pending"}')

# 更新订单状态
result = update_order_status(order_id=1, new_status="confirmed", operator_id=1)
```

#### 营收分析工具

```python
from tools.revenue_analysis_tool import calculate_daily_revenue, get_revenue_trend

# 计算今日营收
result = calculate_daily_revenue(store_id=1)

# 获取营收趋势
result = get_revenue_trend(store_id=1, days=7)
```

## 7. 部署建议

### 7.1 开发环境
- 使用 PostgreSQL 作为开发数据库
- 使用本地 S3 兼容存储（如 MinIO）测试
- 配置环境变量

### 7.2 生产环境
- 使用托管 PostgreSQL 服务（如 AWS RDS、阿里云 RDS）
- 使用对象存储服务（如 AWS S3、阿里云 OSS）
- 配置负载均衡
- 配置定时任务（营收统计）

### 7.3 监控与日志
- 配置日志收集（ELK/Loki）
- 监控数据库性能
- 监控 API 响应时间
- 告警机制（异常订单、库存预警）

## 8. 安全建议

### 8.1 数据安全
- 敏感数据加密（密码、支付信息）
- 定期备份数据库
- 访问日志记录

### 8.2 接口安全
- 使用 HTTPS
- API 接口鉴权
- 防 SQL 注入、XSS 攻击

### 8.3 支付安全
- 支付接口加密
- 订单验签
- 防重复支付

## 9. 扩展性设计

### 9.1 水平扩展
- 数据库读写分离
- API 服务集群部署
- 静态资源 CDN 加速

### 9.2 功能扩展
- 支持外卖配送（对接美团、饿了么）
- 支持预约订餐
- 支持团购活动
- 支持多种餐厅类型

## 10. 总结

本系统已完成核心架构设计和关键功能的开发，包括：
- 完整的数据库设计（19 张表）
- 两个核心 AI Agent（订单分析、营收分析）
- 8 个业务工具函数
- 集成了数据库、对象存储、大模型等基础设施

后续开发重点应放在：
1. API 层开发
2. 前端开发
3. 支付集成
4. 具体业务功能实现

系统架构清晰、模块化良好，具备良好的扩展性和可维护性。
